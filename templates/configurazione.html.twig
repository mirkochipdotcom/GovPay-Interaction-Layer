{% extends 'base.html.twig' %}

{% block title %}Configurazione - GovPay{% endblock %}

{% block content %}
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h4 mb-0">Configurazione</h1>
    <div>
      <a class="btn btn-outline-secondary" href="/">&laquo; Torna alla home</a>
    </div>
  </div>

  {% if errors is defined and errors|length > 0 %}
    <div class="alert alert-warning">
      <ul class="mb-0">
        {% for e in errors %}
          <li>{{ e }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <div class="card">
    <div class="card-header">
      <ul class="nav nav-tabs card-header-tabs">
        {% set current = tab|default('principali') %}
        <li class="nav-item"><a class="nav-link {{ current == 'principali' ? 'active' : '' }}" href="/configurazione?tab=principali">Dati principali</a></li>
        <li class="nav-item"><a class="nav-link {{ current == 'tipologie' ? 'active' : '' }}" href="/configurazione?tab=tipologie">Tipologie di pendenze</a></li>
  <li class="nav-item"><a class="nav-link {{ current == 'gestionali' ? 'active' : '' }}" href="/configurazione?tab=gestionali">Gestionali</a></li>
  <li class="nav-item"><a class="nav-link {{ current == 'info' ? 'active' : '' }}" href="/configurazione?tab=info">Info</a></li>
  <li class="nav-item"><a class="nav-link {{ current == 'applicazioni' ? 'active' : '' }}" href="/configurazione?tab=applicazioni">Applicazioni</a></li>
  <li class="nav-item"><a class="nav-link {{ current == 'confapi' ? 'active' : '' }}" href="/configurazione?tab=confapi">Configurazioni</a></li>
      </ul>
    </div>
    <div class="card-body">
      {% set c = cfg|default({}) %}
      {% set d = dominio|default({}) %}
      {% if current == 'principali' %}
        <h2 class="h5">Dati principali</h2>
        <div class="row g-3">
          <div class="col-lg-6">
            <div class="mb-2"><span class="text-muted">Ente:</span> {{ d.ragioneSociale|default((c.ente is defined and c.ente.denominazione is defined) ? c.ente.denominazione : '—') }}</div>
            <div class="mb-2"><span class="text-muted">ID Dominio:</span> {{ d.idDominio|default((c.ente is defined and c.ente.identificativoDominio is defined) ? c.ente.identificativoDominio : '—') }}</div>
            <div class="mb-2"><span class="text-muted">Indirizzo:</span>
              {% set addr = [d.indirizzo|default(null), d.civico|default(null)]|filter(v=>v)|join(' ') %}
              {{ addr and addr|length > 0 ? addr : '—' }}
            </div>
            <div class="mb-2"><span class="text-muted">CAP / Località (Provincia):</span>
              {% set loc = [d.cap|default(null), d.localita|default(null)]|filter(v=>v)|join(' ') %}
              {% set prov = d.provincia|default(null) %}
              {{ loc ? loc : '—' }}{{ prov ? ' (' ~ prov ~ ')' : '' }}
            </div>
            <div class="mb-2"><span class="text-muted">Nazione:</span> {{ d.nazione|default('—') }}</div>
            <div class="mb-2"><span class="text-muted">Telefono:</span> {{ d.tel|default('—') }}</div>
            <div class="mb-2"><span class="text-muted">Sito web:</span>
              {% if d.web is defined and d.web %}
                {% set webUrl = d.web starts with 'http' ? d.web : 'http://' ~ d.web %}
                <a href="{{ webUrl }}" target="_blank" rel="noopener">{{ d.web }}</a>
              {% else %}
                —
              {% endif %}
            </div>
            <div class="mb-2"><span class="text-muted">CBILL:</span> {{ d.cbill|default('—') }}</div>
            <div class="mb-2"><span class="text-muted">Stazione:</span> {{ d.stazione|default('—') }}</div>
            <div class="mb-2"><span class="text-muted">GLN:</span> {{ d.gln|default('—') }}</div>
            <div class="mb-2"><span class="text-muted">Aux digit / Segregation code:</span>
              {% set aux = d.auxDigit|default(null) %}
              {% set seg = d.segregationCode|default(null) %}
              {{ aux or seg ? (aux|default('—') ~ ' / ' ~ seg|default('—')) : '—' }}
            </div>
            <div class="mb-2"><span class="text-muted">Abilitato:</span>
              {% if d.abilitato is defined %}
                <span class="badge {{ d.abilitato ? 'bg-success' : 'bg-secondary' }}">{{ d.abilitato ? 'Sì' : 'No' }}</span>
              {% else %}
                —
              {% endif %}
            </div>
            <div class="mb-2"><span class="text-muted">Intermediato:</span>
              {% if d.intermediato is defined %}
                <span class="badge {{ d.intermediato ? 'bg-info text-dark' : 'bg-light text-muted border' }}">{{ d.intermediato ? 'Sì' : 'No' }}</span>
              {% else %}
                —
              {% endif %}
            </div>
            <div class="mb-2"><span class="text-muted">Aut. Stampa Poste Italiane:</span> {{ d.autStampaPosteItaliane|default('—') }}</div>
            <div class="mb-2"><span class="text-muted">Logo:</span>
              {% if d.logo is defined and d.logo %}
                {% set logoVal = d.logo %}
                {% set isDataUrl = logoVal starts with 'data:image/' %}
                {% set isBase64Only = (not isDataUrl) and (logoVal matches '#^[A-Za-z0-9+/=]+$#' and (logoVal|length) > 64) %}
                {% if isDataUrl %}
                  <img src="{{ logoVal }}" alt="Logo dominio" style="max-height:48px" class="align-text-bottom border rounded">
                {% elseif isBase64Only %}
                  <img src="{{ ('data:image/png;base64,' ~ logoVal) }}" alt="Logo dominio" style="max-height:48px" class="align-text-bottom border rounded">
                {% else %}
                  <span class="font-monospace small">{{ logoVal }}</span>
                {% endif %}
              {% else %}
                —
              {% endif %}
            </div>
          </div>
          <div class="col-lg-6">
            <h3 class="h6 mt-3">Conti di accredito</h3>
            {% set conti = d.contiAccredito|default([]) %}
            {% if conti and conti|length > 0 %}
              <div class="table-responsive small">
                <table class="table table-sm table-striped align-middle">
                  <thead>
                    <tr>
                      <th>IBAN</th>
                      <th>Descrizione</th>
                      <th>Postale</th>
                      <th>MyBank</th>
                      <th>Abilitato</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for cc in conti %}
                      <tr>
                        <td class="font-monospace">{{ cc.iban|default('—') }}</td>
                        <td>{{ cc.descrizione|default('—') }}</td>
                        <td>{{ cc.postale is defined and cc.postale ? 'Sì' : 'No' }}</td>
                        <td>{{ cc.mybank is defined and cc.mybank ? 'Sì' : 'No' }}</td>
                        <td>
                          {% if cc.abilitato is defined %}
                            <span class="badge {{ cc.abilitato ? 'bg-success' : 'bg-secondary' }}">{{ cc.abilitato ? 'Sì' : 'No' }}</span>
                          {% else %}
                            —
                          {% endif %}
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <p class="text-muted small mb-2">Nessun conto di accredito configurato.</p>
            {% endif %}

            <h3 class="h6 mt-3">Unità operative</h3>
            {% set uo = d.unitaOperative|default([]) %}
            {% if uo and uo|length > 0 %}
              <ul class="small mb-0">
                {% for u in uo %}
                  <li>{{ u.denominazione|default(u.idUnitaOperativa|default('Unità')) }}</li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted small mb-0">Nessuna unità operativa.</p>
            {% endif %}

          </div>
        </div>
        {% if app_debug and dominio_json %}
          <hr>
          <div class="d-flex justify-content-between align-items-center">
            <div class="text-muted small">Backoffice: /domini/{{ d.idDominio|default('idDominio') }}</div>
            <div class="d-flex align-items-center gap-2">
              <span class="badge bg-warning text-dark">Debug</span>
              <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#rawDominio" aria-expanded="false" aria-controls="rawDominio">Mostra JSON</button>
            </div>
          </div>
          <div class="collapse mt-2" id="rawDominio">
            <pre class="mb-0">{{ dominio_json }}</pre>
          </div>
        {% endif %}
      {% elseif current == 'tipologie' %}
        <h2 class="h5">Tipologie di entrata del dominio</h2>
        {% set elenco = entrate.risultati|default([]) %}
        {% if elenco and elenco|length > 0 %}
          <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
            <div class="flex-grow-1">
              <input id="entrateSearch" type="search" class="form-control form-control-sm" placeholder="Cerca per descrizione, IBAN, codice o ID" aria-label="Cerca tipologie di entrata">
            </div>
            <div class="text-muted small" id="entrateCounter" aria-live="polite"></div>
            <button id="entrateClear" type="button" class="btn btn-sm btn-outline-secondary">Pulisci</button>
          </div>
          <div class="accordion" id="accordionEntrate">
            {% for e in elenco %}
              {% set descr = e.tipoEntrata.descrizione|default(e.idEntrata|default('Tipologia')) %}
              {% set eid = 'entrata_' ~ (e.idEntrata|default(loop.index)) %}
              {% set effMap = entrate._effective_map|default({}) %}
              {% set idEnt = e.idEntrata|default(e.tipoEntrata.idEntrata|default('')) %}
              {% set eff = effMap[idEnt]|default(e.abilitato|default(false)) %}
              <div class="accordion-item">
                <h2 class="accordion-header" id="heading_{{ eid }}">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse_{{ eid }}" aria-expanded="false" aria-controls="collapse_{{ eid }}">
                    <div class="d-flex w-100 align-items-center justify-content-between">
                      <span class="me-3">{{ descr }}</span>
                      {% set ab = eff %}
                      <div class="d-flex align-items-center justify-content-end ms-2" style="width: 160px;">
                        <span class="small text-nowrap me-2 d-none d-sm-inline-block" style="width: 80px; text-align: right;">{{ ab ? 'Attivo' : 'Disattivo' }}</span>
                        <span class="form-check form-switch m-0">
                          <input class="form-check-input" type="checkbox" role="switch" disabled {{ ab ? 'checked' : '' }}>
                          <label class="form-check-label visually-hidden">{{ ab ? 'Attivo' : 'Disattivo' }}</label>
                        </span>
                      </div>
                    </div>
                  </button>
                </h2>
                <div id="collapse_{{ eid }}" class="accordion-collapse collapse" aria-labelledby="heading_{{ eid }}" data-bs-parent="#accordionEntrate">
                  <div class="accordion-body">
                    <div class="row g-3 small">
                      <div class="col-md-4">
                        <div class="text-muted">IBAN accredito</div>
                        <div class="fw-semibold">{{ e.ibanAccredito|default('—') }}</div>
                      </div>
                      <div class="col-md-4">
                        <div class="text-muted">Codice contabilità</div>
                        <div class="fw-semibold">{{ e.codiceContabilita|default(e.tipoEntrata.codiceContabilita|default('—')) }}</div>
                      </div>
                      <div class="col-md-4">
                        <div class="text-muted">ID Entrata</div>
                        <div class="fw-semibold">{{ idEnt|default('—') }}</div>
                      </div>
                    </div>
                    {% if current_user and current_user.role == 'superadmin' and idEnt %}
                      <hr>
                      <div class="d-flex flex-wrap gap-2 align-items-center">
                        <form method="post" action="/configurazione/tipologie/{{ idEnt }}/override" class="m-0">
                          <input type="hidden" name="enable" value="{{ eff ? 0 : 1 }}">
                          <button type="submit" class="btn btn-sm {{ eff ? 'btn-outline-danger' : 'btn-outline-success' }}">
                            {{ eff ? 'Disattiva localmente' : 'Attiva localmente' }}
                          </button>
                        </form>
                        <form method="post" action="/configurazione/tipologie/{{ idEnt }}/override" class="m-0">
                          <input type="hidden" name="action" value="reset">
                          <button type="submit" class="btn btn-sm btn-outline-secondary">Ripristina da Backoffice</button>
                        </form>
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
          <p id="noEntrateResults" class="text-muted small mt-2 d-none">Nessun risultato corrispondente al filtro.</p>
          <script>
            (function(){
              const q = document.getElementById('entrateSearch');
              const clearBtn = document.getElementById('entrateClear');
              const acc = document.getElementById('accordionEntrate');
              const counter = document.getElementById('entrateCounter');
              const noRes = document.getElementById('noEntrateResults');
              if (!q || !acc) return;
              const items = Array.from(acc.querySelectorAll('.accordion-item'));
              const total = items.length;
              const updateCounter = (visible) => {
                if (counter) counter.textContent = `Mostrati ${visible} di ${total}`;
                if (noRes) noRes.classList.toggle('d-none', visible > 0);
              };
              const norm = (s) => (s || '').toString().toLowerCase();
              const filter = () => {
                const term = norm(q.value);
                let visible = 0;
                items.forEach(it => {
                  const header = it.querySelector('.accordion-button');
                  const body = it.querySelector('.accordion-body');
                  const text = norm((header ? header.textContent : '') + ' ' + (body ? body.textContent : ''));
                  const match = term === '' || text.indexOf(term) !== -1;
                  it.classList.toggle('d-none', !match);
                  if (match) visible++;
                });
                updateCounter(visible);
              };
              q.addEventListener('input', filter);
              clearBtn && clearBtn.addEventListener('click', () => { q.value = ''; q.focus(); filter(); });
              // Init
              filter();
            })();
          </script>
        {% else %}
          <p class="text-muted mb-0">Nessuna tipologia disponibile.</p>
        {% endif %}

        {% if app_debug and entrate_json %}
          <hr>
          <div class="d-flex justify-content-between align-items-center">
            {% set esrc = entrate_source|default('/entrate') %}
            <div class="text-muted small">Backoffice: {{ esrc }} (Elenco tipologie di entrata)</div>
            <div class="d-flex align-items-center gap-2">
              <span class="badge bg-warning text-dark">Debug</span>
              <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#rawEntrate" aria-expanded="false" aria-controls="rawEntrate">Mostra JSON</button>
            </div>
          </div>
          <div class="collapse mt-2" id="rawEntrate">
            <pre class="mb-0">{{ entrate_json }}</pre>
          </div>
        {% endif %}
      {% elseif current == 'gestionali' %}
        <h2 class="h5">Gestionali</h2>
        {% set gest = c.gestionali|default([]) %}
        {% if gest and gest|length > 0 %}
          <div class="table-responsive small">
            <table class="table table-striped table-sm align-middle">
              <thead>
                <tr>
                  <th>Nome</th>
                  <th>Vendor</th>
                  <th>Versione</th>
                </tr>
              </thead>
              <tbody>
                {% for g in gest %}
                  <tr>
                    <td>{{ g.nome|default('—') }}</td>
                    <td>{{ g.vendor|default('—') }}</td>
                    <td>{{ g.versione|default('—') }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted mb-0">Nessun gestionale configurato.</p>
        {% endif %}
      {% elseif current == 'info' %}
        <h2 class="h5">Info GovPay</h2>
        {% set i = info|default({}) %}
        <div class="row g-3">
          <div class="col-md-6 col-lg-3">
            <div class="border rounded p-3 h-100">
              <div class="text-muted small">Applicazione</div>
              <div class="fw-semibold">{{ i.appName|default('—') }}</div>
            </div>
          </div>
          <div class="col-md-6 col-lg-3">
            <div class="border rounded p-3 h-100">
              <div class="text-muted small">Versione</div>
              <div class="fw-semibold">
                {% set iv = i.versione|default(null) %}
                {% if iv %}
                  <a href="https://govpay.readthedocs.io/it/{{ iv }}/index.html" target="_blank" rel="noopener">{{ iv }}</a>
                {% else %}
                  —
                {% endif %}
              </div>
            </div>
          </div>
          <div class="col-md-6 col-lg-3">
            <div class="border rounded p-3 h-100">
              <div class="text-muted small">Build</div>
              <div class="fw-semibold">{{ i.build|default('—') }}</div>
            </div>
          </div>
          <div class="col-md-6 col-lg-3">
            <div class="border rounded p-3 h-100">
              <div class="text-muted small">Ambiente</div>
              {% set amb = i.ambiente|default('—') %}
              <div>
                {% set badge = 'bg-secondary' %}
                {% if amb matches '/prod|prd|production/i' %}
                  {% set badge = 'bg-danger' %}
                {% elseif amb matches '/test|collaudo|uat/i' %}
                  {% set badge = 'bg-warning text-dark' %}
                {% elseif amb matches '/dev|svil|demo/i' %}
                  {% set badge = 'bg-info text-dark' %}
                {% endif %}
                <span class="badge {{ badge }}">{{ amb }}</span>
              </div>
            </div>
          </div>
        </div>

        {% if app_debug and info_json %}
          <hr>
          <div class="d-flex justify-content-between align-items-center">
            <div class="text-muted small">Backoffice: /info</div>
            <div class="d-flex align-items-center gap-2">
              <span class="badge bg-warning text-dark">Debug</span>
              <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#rawInfo" aria-expanded="false" aria-controls="rawInfo">Mostra JSON</button>
            </div>
          </div>
          <div class="collapse mt-2" id="rawInfo">
            <pre class="mb-0">{{ info_json }}</pre>
          </div>
        {% endif %}
          {% elseif current == 'applicazioni' %}
            <h2 class="h5">Dati applicazioni</h2>
            {% set a2a = idA2A|default('') %}
            {% set appSel = app|default(null) %}

            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <div><span class="text-muted">ID A2A:</span> {{ a2a ? a2a : '—' }}</div>
                {% if appSel %}
                  <div><span class="text-muted">Nome:</span> {{ appSel.nome|default(appSel.denominazione|default('—')) }}</div>
                  <div><span class="text-muted">Descrizione:</span> {{ appSel.descrizione|default('—') }}</div>
                {% endif %}
              </div>
              <div class="col-md-6">
                {% if appSel %}
                  <div><span class="text-muted">Stato:</span> {{ (appSel.attivo ?? appSel.abilitato ?? false) ? 'Attiva' : 'Disattiva' }}</div>
                {% endif %}
              </div>
            </div>

            {% if appSel %}
              {% set roles = [] %}
              {% if appSel.ruoli is defined and appSel.ruoli %}
                {% set roles = appSel.ruoli %}
              {% elseif appSel.acl is defined and appSel.acl.ruoli is defined %}
                {% set roles = appSel.acl.ruoli %}
              {% elseif appSel.profili is defined %}
                {% set roles = appSel.profili %}
              {% endif %}

              <h3 class="h6">Ruoli e ACL</h3>
              {% if roles and roles|length > 0 %}
                <div class="row g-3">
                  {% for r in roles %}
                    {% set roleName = r.nome|default(r.codice|default(r.id|default('Ruolo'))) %}
                    {% set perms = r.permessi|default(r.autorizzazioni|default(r.azioni|default([]))) %}
                    <div class="col-lg-4 col-md-6">
                      <div class="border rounded h-100 p-2">
                        <div class="d-flex align-items-center justify-content-between">
                          <strong class="small">{{ roleName }}</strong>
                          {% if r.attivo is defined %}
                            <span class="badge {{ r.attivo ? 'bg-success' : 'bg-secondary' }}">{{ r.attivo ? 'Attivo' : 'No' }}</span>
                          {% endif %}
                        </div>
                        {% if perms and perms|length > 0 %}
                          <div class="mt-2 d-flex flex-wrap gap-1">
                            {% for p in perms %}
                              {% set pName = (p.nome ?? p.codice ?? p.azione ?? p) %}
                              {% set enabled = (p.abilitato ?? p.attivo ?? (p.concesso ?? true)) %}
                              <span class="badge {{ enabled ? 'bg-primary' : 'bg-light text-muted border' }}">{{ pName }}</span>
                            {% endfor %}
                          </div>
                        {% else %}
                          <div class="text-muted small mt-2">Nessuna permission associata.</div>
                        {% endif %}
                      </div>
                    </div>
                  {% endfor %}
                </div>
              {% else %}
                <p class="text-muted">Nessun ruolo/ACL disponibile per questa applicazione.</p>
              {% endif %}
            {% else %}
              <p class="text-muted">Nessuna applicazione selezionata o non trovata per l'ID A2A configurato.</p>
            {% endif %}

            {% if app_debug %}
              <hr>
              <div class="d-flex flex-wrap gap-2 align-items-center">
                <span class="badge bg-warning text-dark">Debug</span>
                {% if apps_json %}
                  <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#rawApps" aria-expanded="false" aria-controls="rawApps">Mostra JSON - Lista applicazioni</button>
                {% endif %}
                {% if app_json %}
                  <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#rawAppDet" aria-expanded="false" aria-controls="rawAppDet">Mostra JSON - Applicazione {{ a2a }}</button>
                {% endif %}
              </div>
              {% if apps_json %}
                <div class="collapse mt-2" id="rawApps">
                  <pre class="mb-0">{{ apps_json }}</pre>
                </div>
              {% endif %}
              {% if app_json %}
                <div class="collapse mt-2" id="rawAppDet">
                  <pre class="mb-0">{{ app_json }}</pre>
                </div>
              {% endif %}
            {% endif %}
            {% elseif current == 'confapi' %}
              <h2 class="h5">Configurazioni (API Backoffice)</h2>
              {% if app_debug and cfg_json %}
                <div class="d-flex justify-content-between align-items-center">
                  <div class="text-muted small">Fonte dati: Backoffice /configurazioni</div>
                  <div class="d-flex align-items-center gap-2">
                    <span class="badge bg-warning text-dark">Debug</span>
                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#rawCfgApi" aria-expanded="false" aria-controls="rawCfgApi">Mostra JSON</button>
                  </div>
                </div>
                <div class="collapse mt-2" id="rawCfgApi">
                  <pre class="mb-0">{{ cfg_json }}</pre>
                </div>
              {% else %}
                <p class="text-muted">Nessun dettaglio JSON disponibile.</p>
              {% endif %}
      {% endif %}

      {% if false %}{# eliminato blocco raw globale configurazioni #}{% endif %}
    </div>
  </div>
{% endblock %}
