{% extends 'base.html.twig' %}

{% block title %}Configurazione - GovPay{% endblock %}

{% block content %}
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h4 mb-0">Configurazione</h1>
    <div>
      <a class="btn btn-outline-secondary" href="/">&laquo; Torna alla home</a>
    </div>
  </div>

  {% set currentTab = current is defined and current ? current : (tab|default('dominio')) %}
  {% if currentTab == 'principali' %}
    {% set currentTab = 'dominio' %}
  {% endif %}

  <div class="row g-3 mb-4">
    <div class="col-lg-3">
      <nav class="nav nav-pills flex-column" aria-label="Sezioni configurazione">
    <a class="nav-link {{ currentTab == 'dominio' ? 'active' : '' }}" href="/configurazione?tab=dominio"><i class="fas fa-building me-2"></i>Dominio</a>
    <a class="nav-link {{ currentTab == 'tipologie' ? 'active' : '' }}" href="/configurazione?tab=tipologie"><i class="fas fa-list me-2"></i>Tipologie</a>
    <a class="nav-link {{ currentTab == 'tipologie_esterne' ? 'active' : '' }}" href="/configurazione?tab=tipologie_esterne"><i class="fas fa-external-link-alt me-2"></i>Tipologie esterne</a>
        <a class="nav-link {{ currentTab == 'gestionali' ? 'active' : '' }}" href="/configurazione?tab=gestionali"><i class="fas fa-cog me-2"></i>Gestionali</a>
  <a class="nav-link {{ currentTab == 'info' ? 'active' : '' }}" href="/configurazione?tab=info"><i class="fas fa-info-circle me-2"></i>Info</a>
  <a class="nav-link {{ currentTab == 'logs' ? 'active' : '' }}" href="/configurazione?tab=logs"><i class="fas fa-file-alt me-2"></i>Logs</a>
        <a class="nav-link {{ currentTab == 'applicazioni' ? 'active' : '' }}" href="/configurazione?tab=applicazioni"><i class="fas fa-puzzle-piece me-2"></i>Applicazioni</a>
        <a class="nav-link {{ currentTab == 'confapi' ? 'active' : '' }}" href="/configurazione?tab=confapi"><i class="fas fa-code me-2"></i>Config API</a>
      </nav>
    </div>
    <div class="col-lg-9">
      {% if currentTab == 'dominio' %}
        <h2 class="h5">Dominio dell'ente</h2>
        {% set d = dominio %}
        {% if d %}
          <div class="row g-3">
            <div class="col-lg-6">
              <div class="mb-2"><span class="text-muted">ID Dominio:</span> <span class="font-monospace">{{ d.idDominio|default('—') }}</span></div>
              <div class="mb-2"><span class="text-muted">Denominazione:</span> {{ d.ragioneSociale|default('—') }}</div>
              <div class="mb-2"><span class="text-muted">Indirizzo:</span> {{ d.indirizzo|default('—') }}</div>
              <div class="mb-2"><span class="text-muted">Località:</span> {{ d.localita|default('—') }}</div>
              <div class="mb-2"><span class="text-muted">Provincia:</span> {{ d.provincia|default('—') }}</div>
              <div class="mb-2"><span class="text-muted">CAP:</span> {{ d.cap|default('—') }}</div>
              <div class="mb-2"><span class="text-muted">Nazione:</span> {{ d.nazione|default('—') }}</div>
              <div class="mb-2"><span class="text-muted">Email:</span> {{ d.email|default('—') }}</div>
              <div class="mb-2"><span class="text-muted">PEC:</span> {{ d.pec|default('—') }}</div>
              <div class="mb-2"><span class="text-muted">Telefono:</span> {{ d.tel|default('—') }}</div>
              <div class="mb-2"><span class="text-muted">Sito web:</span>
                {% if d.web is defined and d.web %}
                  {% set webUrl = d.web starts with 'http' ? d.web : 'http://' ~ d.web %}
                  <a href="{{ webUrl }}" target="_blank" rel="noopener">{{ d.web }}</a>
                {% else %}
                  —
                {% endif %}
              </div>
              <div class="mb-2"><span class="text-muted">CBILL:</span> {{ d.cbill|default('—') }}</div>
              <div class="mb-2"><span class="text-muted">Stazione:</span> {{ d.stazione|default('—') }}</div>
              <div class="mb-2"><span class="text-muted">GLN:</span> {{ d.gln|default('—') }}</div>
              <div class="mb-2"><span class="text-muted">Aux digit / Segregation code:</span>
                {% set aux = d.auxDigit|default(null) %}
                {% set seg = d.segregationCode|default(null) %}
                {{ aux or seg ? (aux|default('—') ~ ' / ' ~ seg|default('—')) : '—' }}
              </div>
              <div class="mb-2"><span class="text-muted">Abilitato:</span>
                {% if d.abilitato is defined %}
                  <span class="badge {{ d.abilitato ? 'bg-success' : 'bg-secondary' }}">{{ d.abilitato ? 'Sì' : 'No' }}</span>
                {% else %}
                  —
                {% endif %}
              </div>
              <div class="mb-2"><span class="text-muted">Intermediato:</span>
                {% if d.intermediato is defined %}
                  <span class="badge {{ d.intermediato ? 'bg-info text-dark' : 'bg-light text-muted border' }}">{{ d.intermediato ? 'Sì' : 'No' }}</span>
                {% else %}
                  —
                {% endif %}
              </div>
              <div class="mb-2"><span class="text-muted">Aut. Stampa Poste Italiane:</span> {{ d.autStampaPosteItaliane|default('—') }}</div>
              <div class="mb-2"><span class="text-muted">Logo:</span>
                {% if d.logo is defined and d.logo %}
                  {% set logoVal = d.logo %}
                  {% set isDataUrl = logoVal starts with 'data:image/' %}
                  {% set isBase64Only = (not isDataUrl) and (logoVal matches '#^[A-Za-z0-9+/=]+$#' and (logoVal|length) > 64) %}
                  {% if isDataUrl %}
                    <img src="{{ logoVal }}" alt="Logo dominio" style="max-height:48px" class="align-text-bottom border rounded">
                  {% elseif isBase64Only %}
                    <img src="{{ ('data:image/png;base64,' ~ logoVal) }}" alt="Logo dominio" style="max-height:48px" class="align-text-bottom border rounded">
                  {% else %}
                    <span class="font-monospace small">{{ logoVal }}</span>
                  {% endif %}
                {% else %}
                  —
                {% endif %}
              </div>
            </div>
            <div class="col-lg-6">
              <h3 class="h6 mt-3 mt-lg-0">Conti di accredito</h3>
              {% set conti = d.contiAccredito|default([]) %}
              {% if conti and conti|length > 0 %}
                <div class="table-responsive small">
                  <table class="table table-sm table-striped align-middle">
                    <thead>
                      <tr>
                        <th>IBAN</th>
                        <th>Descrizione</th>
                        <th>Postale</th>
                        <th>MyBank</th>
                        <th>Abilitato</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for cc in conti %}
                        <tr>
                          <td class="font-monospace">{{ cc.iban|default('—') }}</td>
                          <td>{{ cc.descrizione|default('—') }}</td>
                          <td>{{ cc.postale is defined and cc.postale ? 'Sì' : 'No' }}</td>
                          <td>{{ cc.mybank is defined and cc.mybank ? 'Sì' : 'No' }}</td>
                          <td>
                            {% if cc.abilitato is defined %}
                              <span class="badge {{ cc.abilitato ? 'bg-success' : 'bg-secondary' }}">{{ cc.abilitato ? 'Sì' : 'No' }}</span>
                            {% else %}
                              —
                            {% endif %}
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% else %}
                <p class="text-muted small mb-2">Nessun conto di accredito configurato.</p>
              {% endif %}

              <h3 class="h6 mt-3">Unità operative</h3>
              {% set uo = d.unitaOperative|default([]) %}
              {% if uo and uo|length > 0 %}
                <ul class="small mb-0">
                  {% for u in uo %}
                    <li>{{ u.denominazione|default(u.idUnitaOperativa|default('Unità')) }}</li>
                  {% endfor %}
                </ul>
              {% else %}
                <p class="text-muted small mb-0">Nessuna unità operativa.</p>
              {% endif %}
            </div>
          </div>

          {% if current_user and current_user.role == 'superadmin' and d %}
            <hr>
            <div class="d-flex justify-content-between align-items-center">
              <h3 class="h6 mb-0">Modifica dati dominio</h3>
              <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDominioEdit" aria-expanded="false" aria-controls="collapseDominioEdit">
                Apri/Chiudi form
              </button>
            </div>
            <div class="collapse mt-3" id="collapseDominioEdit">
              <div class="alert alert-info py-2 mb-3 small">
                Campi obbligatori: Ragione sociale, GLN, Stazione (richiesti dall'API Backoffice). GLN è il Global Location Number del beneficiario.
              </div>
              <form method="post" action="/configurazione/dominio" class="row g-2">
                <div class="col-md-6">
                  <label class="form-label form-label-sm">Ragione sociale*</label>
                  <input name="ragione_sociale" class="form-control form-control-sm" value="{{ d.ragioneSociale|default('') }}" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label form-label-sm">GLN*</label>
                  <input name="gln" class="form-control form-control-sm" value="{{ d.gln|default('') }}" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label form-label-sm">Stazione*</label>
                  <input name="stazione" class="form-control form-control-sm" value="{{ d.stazione|default('') }}" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label form-label-sm">CBILL</label>
                  <input name="cbill" class="form-control form-control-sm" value="{{ d.cbill|default('') }}">
                </div>
                <div class="col-md-6">
                  <label class="form-label form-label-sm">Indirizzo</label>
                  <input name="indirizzo" class="form-control form-control-sm" value="{{ d.indirizzo|default('') }}">
                </div>
                <div class="col-md-2">
                  <label class="form-label form-label-sm">Civico</label>
                  <input name="civico" class="form-control form-control-sm" value="{{ d.civico|default('') }}">
                </div>
                <div class="col-md-2">
                  <label class="form-label form-label-sm">CAP</label>
                  <input name="cap" class="form-control form-control-sm" value="{{ d.cap|default('') }}">
                </div>
                <div class="col-md-4">
                  <label class="form-label form-label-sm">Località</label>
                  <input name="localita" class="form-control form-control-sm" value="{{ d.localita|default('') }}">
                </div>
                <div class="col-md-2">
                  <label class="form-label form-label-sm">Provincia</label>
                  <input name="provincia" class="form-control form-control-sm" value="{{ d.provincia|default('') }}">
                </div>
                <div class="col-md-2">
                  <label class="form-label form-label-sm">Nazione</label>
                  <input name="nazione" class="form-control form-control-sm" value="{{ d.nazione|default('') }}">
                </div>
                <div class="col-md-6">
                  <label class="form-label form-label-sm">Email</label>
                  <input type="email" name="email" class="form-control form-control-sm" value="{{ d.email|default('') }}">
                </div>
                <div class="col-md-6">
                  <label class="form-label form-label-sm">PEC</label>
                  <input type="email" name="pec" class="form-control form-control-sm" value="{{ d.pec|default('') }}">
                </div>
                <div class="col-md-6">
                  <label class="form-label form-label-sm">Telefono</label>
                  <input name="tel" class="form-control form-control-sm" value="{{ d.tel|default('') }}">
                </div>
                <div class="col-md-6">
                  <label class="form-label form-label-sm">Fax</label>
                  <input name="fax" class="form-control form-control-sm" value="{{ d.fax|default('') }}">
                </div>
                <div class="col-md-6">
                  <label class="form-label form-label-sm">Sito web</label>
                  <input name="web" class="form-control form-control-sm" value="{{ d.web|default('') }}" placeholder="es. https://www.comune.it">
                </div>
                <div class="col-md-3">
                  <label class="form-label form-label-sm">IUV Prefix</label>
                  <input name="iuv_prefix" class="form-control form-control-sm" value="{{ d.iuvPrefix|default('') }}">
                </div>
                <div class="col-md-3">
                  <label class="form-label form-label-sm">Aux digit</label>
                  <input name="aux_digit" class="form-control form-control-sm" value="{{ d.auxDigit|default('') }}">
                </div>
                <div class="col-md-3">
                  <label class="form-label form-label-sm">Segregation code</label>
                  <input name="segregation_code" class="form-control form-control-sm" value="{{ d.segregationCode|default('') }}">
                </div>
                <div class="col-md-12">
                  <label class="form-label form-label-sm">Logo (data URL o base64)</label>
                  <input name="logo" class="form-control form-control-sm" value="{{ d.logo|default('') }}">
                </div>
                <div class="col-md-3 form-check mt-2 ms-2">
                  <input class="form-check-input" type="checkbox" id="abilitato" name="abilitato" value="1" {% if d.abilitato %}checked{% endif %}>
                  <label class="form-check-label" for="abilitato">Abilitato</label>
                </div>
                <div class="col-md-3 form-check mt-2 ms-2">
                  <input class="form-check-input" type="checkbox" id="intermediato" name="intermediato" value="1" {% if d.intermediato %}checked{% endif %}>
                  <label class="form-check-label" for="intermediato">Intermediato</label>
                </div>
                <div class="col-12 mt-2">
                  <button type="submit" class="btn btn-sm btn-primary">Salva dominio</button>
                  <a href="/configurazione?tab=dominio" class="btn btn-sm btn-outline-secondary">Annulla</a>
                </div>
              </form>
            </div>
          {% endif %}

          {% if app_debug and dominio_json %}
            <hr>
            <div class="d-flex justify-content-between align-items-center">
              <div class="text-muted small">Backoffice: /domini/{{ d.idDominio|default('idDominio') }}</div>
              <div class="d-flex align-items-center gap-2">
                <span class="badge bg-warning text-dark">Debug</span>
                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#rawDominio" aria-expanded="false" aria-controls="rawDominio">Mostra JSON</button>
              </div>
            </div>
            <div class="collapse mt-2" id="rawDominio">
              <pre class="mb-0">{{ dominio_json }}</pre>
            </div>
          {% endif %}
        {% else %}
          <p class="text-muted mb-0">Dati dominio non disponibili.</p>
        {% endif %}
  {% elseif currentTab == 'tipologie' %}
        <h2 class="h5">Tipologie di entrata del dominio</h2>
        {% set elenco = entrate.risultati|default([]) %}
        {% if elenco and elenco|length > 0 %}
          <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
            <div class="flex-grow-1">
              <input id="entrateSearch" type="search" class="form-control form-control-sm" placeholder="Cerca per descrizione, IBAN, codice o ID" aria-label="Cerca tipologie di entrata">
            </div>
            <div class="text-muted small" id="entrateCounter" aria-live="polite"></div>
            <button id="entrateClear" type="button" class="btn btn-sm btn-outline-secondary">Pulisci</button>
          </div>
          <div class="accordion" id="accordionEntrate">
              {% for e in elenco %}
              {% set idEnt = e.idEntrata|default(e.tipoEntrata.idEntrata|default('')) %}
              {% set descrLocaleMap = entrate._descr_map|default({}) %}
              {% set descrEffMap = entrate._descr_eff_map|default({}) %}
              {% set descrBackoffice = e.tipoEntrata.descrizione|default(idEnt|default('Tipologia')) %}
              {% set descrLocale = descrLocaleMap[idEnt]|default(null) %}
              {% set descrEff = descrEffMap[idEnt]|default(descrBackoffice) %}
              {% set descr = descrEff %}
              {% set eid = 'entrata_' ~ (e.idEntrata|default(loop.index)) %}
              {% set boMap = entrate._bo_map|default({}) %}
              {% set ovrMap = entrate._override_map|default({}) %}
              {% set urlMap = entrate._exturl_map|default({}) %}
              {% set idEnt = e.idEntrata|default(e.tipoEntrata.idEntrata|default('')) %}
              {% set bo = (boMap[idEnt] is defined) ? boMap[idEnt] : (e.abilitato|default(false)) %}
              {% set ovr = ovrMap[idEnt]|default(null) %}
              {% set urlVal = urlMap[idEnt]|default('') %}
              <div class="accordion-item">
                <h2 class="accordion-header" id="heading_{{ eid }}">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse_{{ eid }}" aria-expanded="false" aria-controls="collapse_{{ eid }}">
                    <div class="d-flex w-100 align-items-center justify-content-start">
                      <span class="me-3 d-flex align-items-center gap-2">
                        <span>{{ descr }}</span>
                        {% set localeAttivo = (ovr is same as(null)) or (ovr == true) %}
                        {% set localeDisattivo = (ovr is not same as(null)) and (ovr == false) %}
                        {% set urlPresente = urlVal is not empty %}
                        {% if localeDisattivo %}
                          <span class="badge bg-warning text-dark small d-none d-md-inline-flex align-items-center">
                            <i class="fas fa-ban me-1"></i> Disattivo locale
                          </span>
                        {% elseif localeAttivo and urlPresente %}
                          <span class="badge bg-primary small d-none d-md-inline-flex align-items-center">
                            <i class="fas fa-external-link-alt me-1"></i> Instradato esterno
                          </span>
                        {% elseif bo and localeAttivo and not urlPresente %}
                          <span class="badge bg-success small d-none d-md-inline-flex align-items-center">
                            <i class="fas fa-check me-1"></i> Attivo GovPay
                          </span>
                        {% else %}
                          <span class="badge bg-secondary small d-none d-md-inline-flex align-items-center">
                            <i class="fas fa-power-off me-1"></i> Disabilitato GovPay
                          </span>
                        {% endif %}
                      </span>
                    </div>
                  </button>
                </h2>
                <div id="collapse_{{ eid }}" class="accordion-collapse collapse" aria-labelledby="heading_{{ eid }}" data-bs-parent="#accordionEntrate">
                  <div class="accordion-body">
                    <div class="row g-3 small">
                      <div class="col-md-4">
                        <div class="text-muted">IBAN accredito</div>
                        <div class="fw-semibold">{{ e.ibanAccredito|default('—') }}</div>
                      </div>
                      <div class="col-md-4">
                        <div class="text-muted">Codice contabilità</div>
                        <div class="fw-semibold">{{ e.codiceContabilita|default(e.tipoEntrata.codiceContabilita|default('—')) }}</div>
                      </div>
                      <div class="col-md-4">
                        <div class="text-muted">ID Entrata</div>
                        <div class="fw-semibold">{{ idEnt|default('—') }}</div>
                      </div>
                    </div>
                    <div class="row g-3 small mt-1">
                      <div class="col-md-6">
                        <div class="text-muted">Stato Backoffice</div>
                        <div>
                          <span class="badge {{ bo ? 'bg-secondary' : 'bg-light text-muted border' }}">{{ bo ? 'Abilitato' : 'Disabilitato' }}</span>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="text-muted">Override locale</div>
                        <div>
                          {% if ovr is same as(null) %}
                            <span class="badge bg-light text-muted border">Nessun override</span>
                          {% elseif ovr %}
                            <span class="badge bg-success">Forzato attivo</span>
                          {% else %}
                            <span class="badge bg-warning text-dark">Forzato disattivo</span>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                    {% if current_user and current_user.role == 'superadmin' and idEnt %}
                      <div class="row g-3 small mt-1">
                        <div class="col-md-12">
                          <div class="d-flex align-items-start gap-2 flex-wrap">
                            <form method="post" action="/configurazione/tipologie/{{ idEnt }}/descrizione" class="d-flex align-items-start gap-2 flex-wrap m-0">
                              <div class="flex-grow-1" style="min-width:260px">
                                <label for="descr_{{ eid }}" class="text-muted">Descrizione personalizzata</label>
                                <input id="descr_{{ eid }}" name="descrizione" type="text" maxlength="255" value="{{ descrLocale is not null ? descrLocale : descrBackoffice }}" class="form-control form-control-sm" placeholder="Inserisci descrizione personalizzata" autocomplete="off">
                                <div class="form-text">
                                  {% if descrLocale is not null %}
                                    Personalizzata (originale GovPay: <span class="text-muted">{{ descrBackoffice }}</span>)
                                  {% else %}
                                    Nessuna personalizzazione locale. Puoi sovrascrivere la descrizione GovPay.
                                  {% endif %}
                                </div>
                              </div>
                              <div class="pt-4">
                                <button type="submit" class="btn btn-sm btn-primary">Salva descrizione</button>
                              </div>
                            </form>
                            {% if descrLocale is not null %}
                              <form method="post" action="/configurazione/tipologie/{{ idEnt }}/descrizione/restore" class="m-0 pt-4">
                                <button type="submit" class="btn btn-sm btn-outline-secondary" onclick="return confirm('Sei sicuro di voler ripristinare la descrizione originale da GovPay?')">Ripristina GovPay</button>
                              </form>
                            {% endif %}
                          </div>
                        </div>
                      </div>
                    {% endif %}
                    {% if current_user and current_user.role == 'superadmin' and idEnt %}
                      <hr>
                      <div class="d-flex flex-column gap-3">
                        <div class="d-flex flex-wrap gap-2 align-items-center">
                          {% if bo %}
                            <form method="post" action="/configurazione/tipologie/{{ idEnt }}/govpay" class="m-0">
                              <input type="hidden" name="enable" value="{{ bo ? 0 : 1 }}">
                              <button type="submit" class="btn btn-sm {{ bo ? 'btn-warning' : 'btn-success' }}">
                                {{ bo ? 'Disabilita su GovPay' : 'Abilita su GovPay' }}
                              </button>
                            </form>
                            {% if ovr is same as(null) or ovr == true %}
                              <form method="post" action="/configurazione/tipologie/{{ idEnt }}/override" class="m-0">
                                <input type="hidden" name="enable" value="0">
                                <button type="submit" class="btn btn-sm btn-outline-danger">Disattiva localmente</button>
                              </form>
                            {% elseif ovr == false %}
                              <form method="post" action="/configurazione/tipologie/{{ idEnt }}/override" class="m-0">
                                <input type="hidden" name="enable" value="1">
                                <button type="submit" class="btn btn-sm btn-outline-success">Attiva localmente</button>
                              </form>
                              {% if urlPresente %}
                                <form method="post" action="/configurazione/tipologie/{{ idEnt }}/url" class="m-0">
                                  <input type="hidden" name="external_url" value="">
                                  <button type="submit" class="btn btn-sm btn-outline-secondary">Reset URL</button>
                                </form>
                              {% endif %}
                            {% endif %}
                          {% else %}
                            <form method="post" action="/configurazione/tipologie/{{ idEnt }}/govpay" class="m-0">
                              <input type="hidden" name="enable" value="1">
                              <button type="submit" class="btn btn-sm btn-success">Abilita su GovPay</button>
                            </form>
                            {% if urlVal %}
                              <form method="post" action="/configurazione/tipologie/{{ idEnt }}/override" class="m-0">
                                <input type="hidden" name="enable" value="{{ ovr == true ? 0 : 1 }}">
                                <button type="submit" class="btn btn-sm {{ ovr == true ? 'btn-outline-danger' : 'btn-outline-success' }}">
                                  {{ ovr == true ? 'Disattiva localmente' : 'Attiva localmente' }}
                                </button>
                              </form>
                            {% endif %}
                          {% endif %}
                          {% if not (ovr is same as(null) or ovr == false) and urlPresente %}
                            <form method="post" action="/configurazione/tipologie/{{ idEnt }}/url" class="m-0">
                              <input type="hidden" name="external_url" value="">
                              <button type="submit" class="btn btn-sm btn-outline-secondary">Reset URL</button>
                            </form>
                          {% endif %}
                          <form method="post" action="/configurazione/tipologie/{{ idEnt }}/url" class="m-0 d-flex align-items-center gap-2">
                            <label for="exturl_{{ eid }}" class="small text-muted">URL esterno</label>
                            <input id="exturl_{{ eid }}" name="external_url" type="url" class="form-control form-control-sm" style="max-width:420px" placeholder="https://..." value="{{ urlVal }}">
                            <button type="submit" class="btn btn-sm btn-primary">Salva</button>
                          </form>
                        </div>
                        {% if not bo and not urlVal %}
                          <span class="text-danger small d-flex align-items-center"><i class="fas fa-info-circle me-1"></i> Imposta un URL esterno per poter attivare localmente quando GovPay è disattivo.</span>
                        {% endif %}
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
          <p id="noEntrateResults" class="text-muted small mt-2 d-none">Nessun risultato corrispondente al filtro.</p>
          <script>
            (function(){
              const q = document.getElementById('entrateSearch');
              const clearBtn = document.getElementById('entrateClear');
              const acc = document.getElementById('accordionEntrate');
              const counter = document.getElementById('entrateCounter');
              const noRes = document.getElementById('noEntrateResults');
              if (!q || !acc) return;
              const items = Array.from(acc.querySelectorAll('.accordion-item'));
              const total = items.length;
              const updateCounter = (visible) => {
                if (counter) counter.textContent = `Mostrati ${visible} di ${total}`;
                if (noRes) noRes.classList.toggle('d-none', visible > 0);
              };
              const norm = (s) => (s || '').toString().toLowerCase();
              const filter = () => {
                const term = norm(q.value);
                let visible = 0;
                items.forEach(it => {
                  const header = it.querySelector('.accordion-button');
                  const body = it.querySelector('.accordion-body');
                  const text = norm((header ? header.textContent : '') + ' ' + (body ? body.textContent : ''));
                  const match = term === '' || text.indexOf(term) !== -1;
                  it.classList.toggle('d-none', !match);
                  if (match) visible++;
                });
                updateCounter(visible);
              };
              q.addEventListener('input', filter);
              clearBtn && clearBtn.addEventListener('click', () => { q.value = ''; q.focus(); filter(); });
              filter();
            })();
          </script>
        {% else %}
          <p class="text-muted mb-0">Nessuna tipologia disponibile.</p>
        {% endif %}

        {% if app_debug and entrate_json %}
          <hr>
          <div class="d-flex justify-content-between align-items-center">
            {% set esrc = entrate_source|default('/entrate') %}
            <div class="text-muted small">Backoffice: {{ esrc }} (Elenco tipologie di entrata)</div>
            <div class="d-flex align-items-center gap-2">
              <span class="badge bg-warning text-dark">Debug</span>
              <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#rawEntrate" aria-expanded="false" aria-controls="rawEntrate">Mostra JSON</button>
            </div>
          </div>
          <div class="collapse mt-2" id="rawEntrate">
            <pre class="mb-0">{{ entrate_json }}</pre>
          </div>
        {% endif %}
  {% elseif currentTab == 'tipologie_esterne' %}
        <h2 class="h5">Tipologie di pagamento esterne</h2>
        <p class="text-muted small">Definisci collegamenti esterni per gestire specifiche tipologie di pagamento al di fuori di GovPay.</p>

        <div class="card border-0 shadow-sm mb-4">
          <div class="card-body">
            <h3 class="h6 mb-3">Nuova tipologia esterna</h3>
            <form method="post" action="/configurazione/tipologie-esterne" class="row g-3 align-items-end">
              <div class="col-md-5">
                <label for="tipologiaDescrizione" class="form-label small text-muted mb-1">Descrizione</label>
                <input type="text" id="tipologiaDescrizione" name="descrizione" class="form-control" placeholder="Es. Pagamenti Imu" autocomplete="off" required>
              </div>
              <div class="col-md-5">
                <label for="tipologiaUrl" class="form-label small text-muted mb-1">URL destinazione</label>
                <input type="url" id="tipologiaUrl" name="url" class="form-control" placeholder="https://..." inputmode="url" required>
                <div class="form-text">Inserisci un URL completo comprensivo di protocollo (http/https).</div>
              </div>
              <div class="col-md-2 d-grid">
                <button type="submit" class="btn btn-primary">Aggiungi</button>
              </div>
            </form>
          </div>
        </div>

        {% set tipi = tipologie_esterne|default([]) %}
        {% if tipi and tipi|length > 0 %}
          <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th scope="col">Descrizione</th>
                  <th scope="col">URL</th>
                  <th scope="col" class="text-nowrap">Ultima modifica</th>
                  <th scope="col" class="text-end">Azioni</th>
                </tr>
              </thead>
              <tbody>
                {% for tipo in tipi %}
                  <tr>
                    <td>{{ tipo.descrizione }}</td>
                    <td class="font-monospace small">
                      <a href="{{ tipo.url }}" target="_blank" rel="noopener">{{ tipo.url }}</a>
                    </td>
                    <td class="small text-muted">
                      {% if tipo.updated_at %}
                        {{ tipo.updated_at|date('d/m/Y H:i') }}
                      {% else %}
                        —
                      {% endif %}
                    </td>
                    <td class="text-end">
                      <form method="post" action="/configurazione/tipologie-esterne/{{ tipo.id }}/delete" class="d-inline">
                        <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Rimuovere la tipologia esterna \"{{ tipo.descrizione|e('js') }}\"?');">Elimina</button>
                      </form>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted mb-0">Non sono ancora state configurate tipologie di pagamento esterne.</p>
        {% endif %}
  {% elseif currentTab == 'gestionali' %}
        <h2 class="h5">Gestionali</h2>
        {% set gest = c.gestionali|default([]) %}
        {% if gest and gest|length > 0 %}
          <div class="table-responsive small">
            <table class="table table-striped table-sm align-middle">
              <thead>
                <tr>
                  <th>Nome</th>
                  <th>Vendor</th>
                  <th>Versione</th>
                </tr>
              </thead>
              <tbody>
                {% for g in gest %}
                  <tr>
                    <td>{{ g.nome|default('—') }}</td>
                    <td>{{ g.vendor|default('—') }}</td>
                    <td>{{ g.versione|default('—') }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted mb-0">Nessun gestionale configurato.</p>
        {% endif %}
  {% elseif currentTab == 'info' %}
        <h2 class="h5">Info GovPay</h2>
        {% set i = info|default({}) %}
        <div class="row g-3">
          <div class="col-md-6 col-lg-3">
            <div class="border rounded p-3 h-100">
              <div class="text-muted small">Applicazione</div>
              <div class="fw-semibold">{{ i.appName|default('—') }}</div>
            </div>
          </div>
          <div class="col-md-6 col-lg-3">
            <div class="border rounded p-3 h-100">
              <div class="text-muted small">Versione</div>
              <div class="fw-semibold">
                {% set iv = i.versione|default(null) %}
                {% if iv %}
                  <a href="https://govpay.readthedocs.io/it/{{ iv }}/index.html" target="_blank" rel="noopener">{{ iv }}</a>
                {% else %}
                  —
                {% endif %}
              </div>
            </div>
          </div>
          <div class="col-md-6 col-lg-3">
            <div class="border rounded p-3 h-100">
              <div class="text-muted small">Build</div>
              <div class="fw-semibold">{{ i.build|default('—') }}</div>
            </div>
          </div>
          <div class="col-md-6 col-lg-3">
            <div class="border rounded p-3 h-100">
              <div class="text-muted small">Ambiente</div>
              {% set amb = i.ambiente|default('—') %}
              <div>
                {% set badge = 'bg-secondary' %}
                {% if amb matches '/prod|prd|production/i' %}
                  {% set badge = 'bg-danger' %}
                {% elseif amb matches '/test|collaudo|uat/i' %}
                  {% set badge = 'bg-warning text-dark' %}
                {% elseif amb matches '/dev|svil|demo/i' %}
                  {% set badge = 'bg-info text-dark' %}
                {% endif %}
                <span class="badge {{ badge }}">{{ amb }}</span>
              </div>
            </div>
          </div>
        </div>

        {% if app_debug and info_json %}
          <hr>
          <div class="d-flex justify-content-between align-items-center">
            <div class="text-muted small">Backoffice: /info</div>
            <div class="d-flex align-items-center gap-2">
              <span class="badge bg-warning text-dark">Debug</span>
              <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#rawInfo" aria-expanded="false" aria-controls="rawInfo">Mostra JSON</button>
            </div>
          </div>
          <div class="collapse mt-2" id="rawInfo">
            <pre class="mb-0">{{ info_json }}</pre>
          </div>
        {% endif %}
  {% elseif currentTab == 'logs' %}
        <h2 class="h5">Log applicazione</h2>
        <p class="text-muted small">Ultime {{ logs_lines is defined ? logs_lines|length : 0 }} righe del file di log applicazione (mostrate le più recenti per prime).</p>
        <div class="mb-3">
          <div class="table-responsive">
            <pre class="small bg-dark text-white p-3" style="max-height:60vh; overflow:auto; white-space:pre-wrap">{% if logs_lines is defined and logs_lines|length > 0 %}{{ logs_lines|join("\n") }}{% else %}Nessuna riga di log disponibile.{% endif %}</pre>
          </div>
        </div>
  {% elseif currentTab == 'applicazioni' %}
        <h2 class="h5">Dati applicazioni</h2>
        {% set a2a = idA2A|default('') %}
        {% set appSel = app|default(null) %}

        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <div><span class="text-muted">ID A2A:</span> {{ a2a ? a2a : '—' }}</div>
          </div>
        </div>

        {% if appSel %}
          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <div class="border rounded p-3 h-100">
                <div class="text-muted small">Principal</div>
                <div class="fw-semibold">{{ appSel.principal|default('—') }}</div>
                <div class="mt-2 text-muted small">Password configurata</div>
                {% set pwd = appSel.password|default(false) %}
                <span class="badge {{ pwd ? 'bg-success' : 'bg-secondary' }}">{{ pwd ? 'Sì' : 'No' }}</span>
              </div>
            </div>
            <div class="col-md-6">
              <div class="border rounded p-3 h-100">
                <div class="text-muted small mb-2">Abilitazioni API</div>
                <div class="d-flex flex-wrap gap-2">
                  {% set apiFlags = {
                    'Pagamenti': appSel.apiPagamenti|default(false),
                    'Pendenze': appSel.apiPendenze|default(false),
                    'Ragioneria': appSel.apiRagioneria|default(false)
                  } %}
                  {% for label, enabled in apiFlags %}
                    <span class="badge {{ enabled ? 'bg-primary' : 'bg-light text-muted border' }}">API {{ label }}</span>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>

          {% set domini = appSel.domini|default([]) %}
          {% if domini and domini|length > 0 %}
            <div class="mb-3">
              <h3 class="h6">Domini abilitati</h3>
              <div class="table-responsive small">
                <table class="table table-sm table-striped align-middle">
                  <thead>
                    <tr>
                      <th>ID Dominio</th>
                      <th>Ragione sociale</th>
                      <th>Unità operative</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for dom in domini %}
                      {% set unita = dom.unitaOperative|default([]) %}
                      <tr>
                        <td class="font-monospace">{{ dom.idDominio|default('—') }}</td>
                        <td>{{ dom.ragioneSociale|default('—') }}</td>
                        <td>
                          {% if unita and unita|length > 0 %}
                            <ul class="list-unstyled mb-0">
                              {% for u in unita %}
                                <li>{{ u.ragioneSociale|default(u.idUnita|default('Unità')) }}</li>
                              {% endfor %}
                            </ul>
                          {% else %}
                            <span class="text-muted">—</span>
                          {% endif %}
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          {% endif %}

          {% set tipi = appSel.tipiPendenza|default([]) %}
          {% if tipi and tipi|length > 0 %}
            <div class="mb-3">
              <h3 class="h6">Tipologie di pendenza</h3>
              <div class="table-responsive small">
                <table class="table table-sm table-striped align-middle">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Descrizione</th>
                      <th>Abilitato</th>
                      <th>Paga terzi</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for tp in tipi %}
                      <tr>
                        <td class="font-monospace">{{ tp.idTipoPendenza|default(tp.id|default('—')) }}</td>
                        <td>{{ tp.descrizione|default('—') }}</td>
                        <td><span class="badge {{ tp.abilitato|default(false) ? 'bg-success' : 'bg-secondary' }}">{{ tp.abilitato|default(false) ? 'Sì' : 'No' }}</span></td>
                        <td><span class="badge {{ tp.pagaTerzi|default(false) ? 'bg-info text-dark' : 'bg-light text-muted border' }}">{{ tp.pagaTerzi|default(false) ? 'Sì' : 'No' }}</span></td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          {% endif %}

          {% set roles = [] %}
          {% if appSel.ruoli is defined and appSel.ruoli %}
            {% set roles = appSel.ruoli %}
          {% elseif appSel.acl is defined and appSel.acl.ruoli is defined %}
            {% set roles = appSel.acl.ruoli %}
          {% elseif appSel.profili is defined %}
            {% set roles = appSel.profili %}
          {% endif %}

          <h3 class="h6">Ruoli e ACL</h3>
          {% if roles and roles|length > 0 %}
            <div class="row g-3">
              {% for r in roles %}
                {% set roleName = r.nome|default(r.codice|default(r.id|default('Ruolo'))) %}
                {% set perms = r.permessi|default(r.autorizzazioni|default(r.azioni|default([]))) %}
                {% set aclEntries = r.acl is defined and r.acl is iterable ? r.acl : [] %}
                <div class="col-lg-4 col-md-6">
                  <div class="border rounded h-100 p-2">
                    <div class="d-flex align-items-center justify-content-between">
                      <strong class="small">{{ roleName }}</strong>
                      {% if r.attivo is defined %}
                        <span class="badge {{ r.attivo ? 'bg-success' : 'bg-secondary' }}">{{ r.attivo ? 'Attivo' : 'No' }}</span>
                      {% endif %}
                    </div>
                    {% if aclEntries and aclEntries|length > 0 %}
                      <div class="mt-2 d-flex flex-column gap-2">
                        {% for entry in aclEntries %}
                          {% set servizio = entry.servizio|default(entry.nome|default(entry.codice|default('Servizio'))) %}
                          {% set rawActions = entry.autorizzazioni|default(entry.azioni|default(entry.permessi|default([]))) %}
                          {% set actions = rawActions is iterable ? rawActions : (rawActions ? [rawActions] : []) %}
                          <div class="border border-light rounded p-2 bg-light-subtle">
                            <div class="small fw-semibold">{{ servizio }}</div>
                            {% if actions and actions|length > 0 %}
                              <div class="mt-1 d-flex flex-wrap gap-1">
                                {% for az in actions %}
                                  <span class="badge bg-primary">{{ az }}</span>
                                {% endfor %}
                              </div>
                            {% else %}
                              <div class="text-muted small mt-1">Nessuna azione</div>
                            {% endif %}
                          </div>
                        {% endfor %}
                      </div>
                    {% elseif perms and perms|length > 0 %}
                      <div class="mt-2 d-flex flex-wrap gap-1">
                        {% for p in perms %}
                          {% set pName = p.nome|default(p.codice|default(p.azione|default(p))) %}
                          {% set enabled = p.abilitato|default(p.attivo|default(p.concesso|default(true))) %}
                          <span class="badge {{ enabled ? 'bg-primary' : 'bg-light text-muted border' }}">{{ pName }}</span>
                        {% endfor %}
                      </div>
                    {% else %}
                      <div class="text-muted small mt-2">Nessuna permission associata.</div>
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="text-muted">Nessun ruolo/ACL disponibile per questa applicazione.</p>
          {% endif %}
        {% else %}
          <p class="text-muted">Nessuna applicazione selezionata o non trovata per l'ID A2A configurato.</p>
        {% endif %}

        {% if app_debug %}
          <hr>
          <div class="d-flex flex-column gap-2">
            <div class="d-flex flex-wrap gap-2 align-items-center">
              <span class="badge bg-warning text-dark">Debug</span>
              {% if app_json %}
                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#rawAppDet" aria-expanded="false" aria-controls="rawAppDet">Mostra JSON - Applicazione {{ a2a }}</button>
              {% endif %}
            </div>
            {% if ruoli_api_status %}
              <div class="d-flex flex-wrap gap-2 align-items-center small">
                <span>
                  <strong>RuoliApi</strong>:
                  {% if ruoli_api_status == 'ok' %}
                    <span class="text-success">OK</span>
                    {% if ruoli_api_count is not null %}
                      <span class="text-muted">({{ ruoli_api_count }} risultati)</span>
                    {% endif %}
                  {% elseif ruoli_api_status == 'missing-client' %}
                    <span class="text-warning">{{ ruoli_api_error|default('Client non disponibile') }}</span>
                  {% else %}
                    <span class="text-danger">{{ ruoli_api_error|default('Errore') }}</span>
                  {% endif %}
                </span>
                {% if ruoli_api_status == 'ok' and ruoli_api_json %}
                  <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#rawRuoliApi" aria-expanded="false" aria-controls="rawRuoliApi">Mostra JSON - /ruoli</button>
                {% endif %}
              </div>
            {% endif %}
          </div>
          {% if apps_json %}
            <div class="collapse mt-2" id="rawApps">
              <pre class="mb-0">{{ apps_json }}</pre>
            </div>
          {% endif %}
          {% if app_json %}
            <div class="collapse mt-2" id="rawAppDet">
              <pre class="mb-0">{{ app_json }}</pre>
            </div>
          {% endif %}
          {% if ruoli_api_status == 'ok' and ruoli_api_json %}
            <div class="collapse mt-2" id="rawRuoliApi">
              <pre class="mb-0">{{ ruoli_api_json }}</pre>
            </div>
          {% endif %}
        {% endif %}
  {% elseif currentTab == 'confapi' %}
        <h2 class="h5">Configurazioni (API Backoffice)</h2>
        {% if app_debug and cfg_json %}
          <div class="d-flex justify-content-between align-items-center">
            <div class="text-muted small">Fonte dati: Backoffice /configurazioni</div>
            <div class="d-flex align-items-center gap-2">
              <span class="badge bg-warning text-dark">Debug</span>
              <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#rawCfgApi" aria-expanded="false" aria-controls="rawCfgApi">Mostra JSON</button>
            </div>
          </div>
          <div class="collapse mt-2" id="rawCfgApi">
            <pre class="mb-0">{{ cfg_json }}</pre>
          </div>
        {% else %}
          <p class="text-muted">Nessun dettaglio JSON disponibile.</p>
        {% endif %}
      {% else %}
        <p class="text-muted mb-0">Seleziona una sezione dalla navigazione.</p>
      {% endif %}

      {% if false %}{# eliminato blocco raw globale configurazioni #}{% endif %}
    </div>
  </div>
{% endblock %}
