{% extends 'base.html.twig' %}

{% block title %}Pagamenti - Dettaglio Flusso{% endblock %}

{% block content %}
  <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-4">
    <div>
      <h1 class="h3 mb-1">Dettaglio flusso di rendicontazione</h1>
      <p class="text-muted mb-0 small">Visualizza i dati di un flusso acquisito da pagoPA</p>
    </div>
    <a class="btn btn-outline-secondary" href="{{ return_url|default('/pagamenti/ricerca-flussi') }}">
      <i class="fas fa-arrow-left me-1"></i> Torna ai risultati
    </a>
  </div>

  {% if errors is defined and errors %}
    <div class="alert alert-danger" role="alert">
      <ul class="mb-0">
        {% for e in errors %}<li>{{ e }}</li>{% endfor %}
      </ul>
    </div>
  {% endif %}

  {% if flusso %}
    {% set flow = flusso %}
    {% set idFlusso = flow.idFlusso|default(flow.id_flusso|default(id_flusso|default(''))) %}
    {% set stato = flow.stato|default(flow.statoFlusso|default('')) %}
    {% set dataFlusso = flow.dataFlusso|default(flow.data|default(data_flusso|default(''))) %}
    {% set dataRegolamento = flow.dataRegolamento|default(flow.data_regolamento|default('')) %}
    {% set idDominio = flow.idDominio|default(flow.dominio.idDominio|default(id_dominio|default(''))) %}
    {% set dominioNome = flow.ragioneSocialeDominio|default(flow.dominio.ragioneSociale|default('')) %}
    {% set idPsp = flow.idPsp|default(flow.id_psp|default('')) %}
    {% set pspNome = flow.ragioneSocialePsp|default(flow.psp.ragioneSociale|default('')) %}
    {% set importoTotale = flow.importoTotale|default(flow.importo_totale|default(null)) %}
    {% set numeroPagamenti = flow.numeroPagamenti|default(flow.numero_pagamenti|default(null)) %}
    {% set trn = flow.trn|default('') %}
    {% set bic = flow.bicRiversamento|default(flow.bic_riversamento|default('')) %}

    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <div class="row g-4">
          <div class="col-12 col-lg-6">
            <h2 class="h5 mb-3">Informazioni generali</h2>
            <dl class="row small mb-0">
              <dt class="col-sm-5 text-muted">ID flusso</dt>
              <dd class="col-sm-7 text-break">{{ idFlusso ?: '—' }}</dd>
              <dt class="col-sm-5 text-muted">Data flusso</dt>
              <dd class="col-sm-7">{% if dataFlusso %}{{ dataFlusso|date('d/m/Y H:i:s') }}{% else %}—{% endif %}</dd>
              <dt class="col-sm-5 text-muted">Data regolamento</dt>
              <dd class="col-sm-7">{% if dataRegolamento %}{{ dataRegolamento|date('d/m/Y H:i:s') }}{% else %}—{% endif %}</dd>
              <dt class="col-sm-5 text-muted">Stato</dt>
              <dd class="col-sm-7">
                {% if stato %}
                  <span class="badge bg-primary-subtle text-primary-emphasis px-3 py-2">{{ stato }}</span>
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </dd>
            </dl>
          </div>
          <div class="col-12 col-lg-6">
            <h2 class="h5 mb-3">Soggetti coinvolti</h2>
            <dl class="row small mb-0">
              <dt class="col-sm-5 text-muted">Dominio</dt>
              <dd class="col-sm-7">
                {% if idDominio %}<strong>{{ idDominio }}</strong>{% else %}<span class="text-muted">—</span>{% endif %}
                {% if dominioNome %}<div class="text-muted">{{ dominioNome }}</div>{% endif %}
              </dd>
              <dt class="col-sm-5 text-muted">PSP</dt>
              <dd class="col-sm-7">
                {% if idPsp %}<strong>{{ idPsp }}</strong>{% else %}<span class="text-muted">—</span>{% endif %}
                {% if pspNome %}<div class="text-muted">{{ pspNome }}</div>{% endif %}
              </dd>
              <dt class="col-sm-5 text-muted">TRN</dt>
              <dd class="col-sm-7">{{ trn ?: '—' }}</dd>
              <dt class="col-sm-5 text-muted">BIC riversamento</dt>
              <dd class="col-sm-7">{{ bic ?: '—' }}</dd>
            </dl>
          </div>
        </div>
        <hr class="my-4">
        <div class="row text-center g-3">
          <div class="col-12 col-md-6 col-lg-3">
            <div class="border rounded p-3 h-100 bg-light">
              <div class="text-muted small">Numero pagamenti</div>
              <div class="h4 mb-0">{{ numeroPagamenti is not null ? numeroPagamenti : '—' }}</div>
            </div>
          </div>
          <div class="col-12 col-md-6 col-lg-3">
            <div class="border rounded p-3 h-100 bg-light">
              <div class="text-muted small">Importo totale</div>
              <div class="h4 mb-0">{% if importoTotale is not null %}{{ importoTotale|number_format(2, ',', '.') }} €{% else %}—{% endif %}</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    {% set segnalazioni = flow.segnalazioni|default(flow.segnalazioni_flusso|default([])) %}
    {% if segnalazioni %}
      <div class="card border-warning-subtle mb-4">
        <div class="card-header bg-warning-subtle text-warning-emphasis">Segnalazioni del flusso</div>
        <div class="card-body">
          <ul class="mb-0 small">
            {% for s in segnalazioni %}
              <li>
                <strong>{{ s.codice|default('N/D') }}</strong>
                {% if s.descrizione %}<span class="ms-1">{{ s.descrizione }}</span>{% endif %}
              </li>
            {% endfor %}
          </ul>
        </div>
      </div>
    {% endif %}

    {% set rendicontazioni = flow.rendicontazioni|default(flow.pagamenti|default([])) %}
    <div class="card shadow-sm">
      <div class="card-header bg-light border-bottom py-3">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h2 class="h6 mb-0 text-uppercase text-secondary">Pagamenti rendicontati</h2>
            <p class="mb-0 small text-muted">Dettaglio dei singoli pagamenti presenti nel flusso</p>
          </div>
          <span class="badge text-bg-primary">{{ rendicontazioni|length }}</span>
        </div>
      </div>
      <div class="table-responsive">
        <table class="table table-striped align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th scope="col">IUV</th>
              <th scope="col">IUR</th>
              <th scope="col" class="text-center">Indice</th>
              <th scope="col" class="text-end">Importo</th>
              <th scope="col">Esito</th>
              <th scope="col">Data esito</th>
              <th scope="col">Segnalazioni</th>
            </tr>
          </thead>
          <tbody>
            {% if rendicontazioni %}
              {% set esiti_map = {
                '0': 'Pagamento eseguito',
                '3': 'Pagamento revocato',
                '4': 'Stand-in',
                '8': 'Stand-in senza RPT',
                '9': 'Pagamento senza RPT'
              } %}
              {% for r in rendicontazioni %}
                {% set esito_code = r.esito is defined ? r.esito : r.esitoPagamento|default('') %}
                {% set esito_key = esito_code is same as('') ? '' : esito_code ~ '' %}
                {% set esito_label = esiti_map[esito_key]|default('') %}
                {% set segs = r.segnalazioni|default([]) %}
                <tr>
                  <td class="text-break">{{ r.iuv|default('—') }}</td>
                  <td class="text-break">{{ r.iur|default('—') }}</td>
                  <td class="text-center">{{ r.indice is defined ? r.indice : '—' }}</td>
                  <td class="text-end">{% if r.importo is defined %}{{ r.importo|number_format(2, ',', '.') }} €{% else %}—{% endif %}</td>
                  <td>
                    {% if esito_code is not same as('') %}
                      <span class="badge bg-primary-subtle text-primary-emphasis">{{ esito_code }}</span>
                      {% if esito_label %}<span class="ms-1 small text-muted">{{ esito_label }}</span>{% endif %}
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>
                  <td>{% if r.data %}{{ r.data|date('d/m/Y') }}{% else %}—{% endif %}</td>
                  <td>
                    {% if segs %}
                      <ul class="mb-0 small ps-3">
                        {% for s in segs %}
                          <li>
                            <strong>{{ s.codice|default('N/D') }}</strong>
                            {% if s.descrizione %}<span class="ms-1">{{ s.descrizione }}</span>{% endif %}
                          </li>
                        {% endfor %}
                      </ul>
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr><td colspan="7" class="text-center text-muted">Nessun pagamento presente nel flusso</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>

    {% if app_debug and flusso %}
      <div class="card mt-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center gap-2">
            <span class="badge bg-warning text-dark">Debug</span>
            <span>Dati raw flusso</span>
          </div>
          <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#rawFlow" aria-expanded="false" aria-controls="rawFlow">
            Mostra/Nascondi
          </button>
        </div>
        <div id="rawFlow" class="collapse">
          <div class="card-body">
            <pre class="small text-break mb-0">{{ flusso|json_encode(constant('JSON_PRETTY_PRINT') b-or constant('JSON_UNESCAPED_SLASHES')) }}</pre>
          </div>
        </div>
      </div>
    {% endif %}
  {% else %}
    <div class="alert alert-warning">Nessun dettaglio disponibile per il flusso richiesto.</div>
  {% endif %}
{% endblock %}
