{% extends 'base.html.twig' %}

{% block title %}Pendenze - Inserimento{% endblock %}

{% block content %}
 
  {% if errors is defined and errors %}
    <div class="alert alert-danger" role="alert">
      <ul class="mb-0">
        {% for e in errors %}<li>{{ e }}</li>{% endfor %}
      </ul>
    </div>
  {% endif %}

  {% if warnings is defined and warnings %}
    <div class="alert alert-warning" role="alert">
      <ul class="mb-0">
        {% for w in warnings %}<li>{{ w }}</li>{% endfor %}
      </ul>
    </div>
  {% endif %}

  <form method="post" action="/pendenze" class="card border-0 shadow-sm mb-4">
    <input type="hidden" name="return" value="/pendenze/ricerca">
    {% if id_dominio is defined and id_dominio %}
      <input type="hidden" name="idDominio" value="{{ id_dominio }}">
    {% endif %}

    {# ID A2A: deve essere preso esclusivamente dalla variabile d'ambiente (mostrato nel body per mantenere header in cima alla card) #}
    <div class="card-header bg-light border-bottom py-3">
      <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-lg-between gap-1">
        <h2 class="h5 mb-0">Inserimento Nuova pendenza</h2>
        <p class="mb-0 text-muted small">Compila i campi obbligatori per creare una pendenza</p>
      </div>
    </div>
    <div class="card-body">
      <div class="mb-3">
        {% if not id_a2a %}
          <div class="alert alert-warning small mb-0">Variabile di ambiente <code>ID_A2A</code> non impostata: imposta <code>ID_A2A</code> in <code>.env</code> prima di creare pendenze.</div>
        {% endif %}
      </div>
      <div class="row">
        <div class="form-group col-md-6">
          <div class="select-wrapper">
            <label for="idTipoPendenza" class="active">Tipologia pendenza</label>
            <select id="idTipoPendenza" name="idTipoPendenza" required aria-label="Tipologia pendenza">
              <option value="">-- seleziona --</option>
              {% for t in tipologie_pendenze|default([]) %}
                <option value="{{ t.id_entrata }}" {% if old.idTipoPendenza is defined and old.idTipoPendenza == t.id_entrata %}selected{% endif %}>{{ t.nome|default(t.descrizione)|e }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="form-group col-md-3">
          <div class="select-wrapper">
            <label for="annoRiferimento" class="active">Anno di riferimento</label>
            {% set current = default_anno|default(date('Y')) %}
            <select id="annoRiferimento" name="annoRiferimento" required aria-label="Anno di riferimento">
              {% for y in range(current + 1, current - 10) %}
                <option value="{{ y }}" {% if (old.annoRiferimento is defined and old.annoRiferimento == y) or (old.annoRiferimento is not defined and y == current) %}selected{% endif %}>{{ y }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="form-group col-md-3">
          <label for="importo" class="input-symbol-label active">Importo</label>
          <div class="input-group input-number">
            <span class="input-group-text fw-semibold">€</span>
            <input id="importo" name="importo" type="number" step="0.01" min="0.01" class="form-control" required placeholder="0.00" value="{{ old.importo is defined ? old.importo : '' }}">
          </div>
          <div class="form-text">Inserisci l'importo in euro (es. 100.50).</div>
        </div>
      </div>

      <div class="row g-3 mt-1">
        <div class="form-group col-12">
          <label for="causale" class="active">Causale / Descrizione</label>
          <input type="text" id="causale" name="causale" class="form-control" placeholder="Inserisci la causale della pendenza" value="{{ old.causale|default('') }}">
          <div class="form-text small">La causale verrà usata automaticamente per la prima voce se non ne viene specificata una diversa.</div>
        </div>
      </div>

      <div class="row g-3 mt-1">
        <div class="form-group col-md-4">
          <label for="dataValidita" class="active">Data validità (opzionale)</label>
          <input id="dataValidita" name="dataValidita" type="date" class="form-control" value="{{ old.dataValidita|default('') }}">
        </div>
        <div class="form-group col-md-4">
          <label for="dataScadenza" class="active">Data scadenza (opzionale)</label>
          <input id="dataScadenza" name="dataScadenza" type="date" class="form-control" value="{{ old.dataScadenza|default('') }}">
        </div>
      </div>

      <div class="row g-3 mt-1">
        {# ID pendenza rimosso: il sistema genera l'id quando non fornito #}
      </div>

      <hr>

      <h3 class="h6">Soggetto pagatore</h3>
      <div class="row g-3 align-items-end">
        <div class="form-group col-12">
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="soggettoPagatore[tipo]" id="soggettoPF" value="F" {% if old.soggettoPagatore is defined and old.soggettoPagatore.tipo is defined and old.soggettoPagatore.tipo == 'G' %}{% else %}checked{% endif %}>
            <label class="form-check-label" for="soggettoPF">Persona fisica</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="soggettoPagatore[tipo]" id="soggettoPJ" value="G" {% if old.soggettoPagatore is defined and old.soggettoPagatore.tipo is defined and old.soggettoPagatore.tipo == 'G' %}checked{% endif %}>
            <label class="form-check-label" for="soggettoPJ">Persona giuridica</label>
          </div>
        </div>
      </div>
      <div class="row">
        {% set tipoSoggetto = old.soggettoPagatore.tipo|default('F') %}
        <div class="form-group col-md-4">
          <label id="identificativoLabel" for="identificativo" class="active">{{ tipoSoggetto == 'G' ? 'Partita IVA' : 'Codice fiscale' }}</label>
          <input id="identificativo" name="soggettoPagatore[identificativo]" type="text" class="form-control" placeholder="{{ tipoSoggetto == 'G' ? 'P.IVA' : 'CF' }}" required autocomplete="off" value="{{ old.soggettoPagatore.identificativo|default('') }}">
        </div>
        <div class="form-group col-md-4">
          <label id="lblAnagrafica" for="anagrafica" class="active">{{ tipoSoggetto == 'G' ? 'Ragione sociale' : 'Cognome' }}</label>
          <input id="anagrafica" name="soggettoPagatore[anagrafica]" type="text" class="form-control" placeholder="{{ tipoSoggetto == 'G' ? 'Ragione sociale' : 'Cognome' }}" required value="{{ old.soggettoPagatore.anagrafica|default('') }}">
        </div>
        <div class="form-group col-md-4" id="colNome" style="{{ tipoSoggetto == 'G' ? 'display:none;' : '' }}">
          <label for="nome" class="active">Nome (se persona fisica)</label>
          <input id="nome" name="soggettoPagatore[nome]" type="text" class="form-control" placeholder="Nome" autocomplete="off" value="{{ old.soggettoPagatore.nome|default('') }}">
        </div>
      </div>
      <script>
      (function(){
        const pf = document.getElementById('soggettoPF');
        const pj = document.getElementById('soggettoPJ');
        const idLabel = document.getElementById('identificativoLabel');
        const ident = document.getElementById('identificativo');
        const lblAnag = document.getElementById('lblAnagrafica');
        const colNome = document.getElementById('colNome');
        function update(t){
          if(!idLabel || !ident || !lblAnag) return;
          if(t === 'G'){
            idLabel.textContent = 'Partita IVA';
            ident.placeholder = 'P.IVA';
            lblAnag.textContent = 'Ragione sociale';
            if(colNome) colNome.style.display = 'none';
          } else {
            idLabel.textContent = 'Codice fiscale';
            ident.placeholder = 'CF';
            lblAnag.textContent = 'Cognome';
            if(colNome) colNome.style.display = '';
          }
        }
        [pf,pj].forEach(function(r){ if(r) r.addEventListener('change', function(){ if(this.checked) update(this.value); }); });
      })();
      </script>
      <div class="row">
        <div class="form-group col-md-6">
          <label for="email" class="active">Email (opzionale)</label>
          <input id="email" name="soggettoPagatore[email]" type="email" class="form-control" placeholder="esempio@dominio.it" value="{{ old.soggettoPagatore.email|default('') }}">
        </div>
      </div>
      

      <hr>

      <h3 class="h6">Voci di pendenza</h3>
      <div class="d-flex align-items-center justify-content-between mb-5">
        <p class="text-muted small mb-0">Il sistema crea almeno una voce di pendenza; puoi aggiungerne altre se necessario.</p>
      </div>
      <div id="vociList">
        {% set existingVoci = old.voci|default([]) %}
        {% if existingVoci is iterable and existingVoci|length > 0 %}
          {% for idx, voce in existingVoci %}
            <div class="row g-3 align-items-end voce-item" data-index="{{ idx }}">
              <div class="form-group col-md-3">
                <label class="active">ID voce</label>
                <div class="form-control-plaintext">{{ voce.idVocePendenza|default('') }}</div>
                <input type="hidden" name="voci[{{ idx }}][idVocePendenza]" value="{{ voce.idVocePendenza|default('') }}">
              </div>
              <div class="form-group col-md-5">
                <label for="voce_desc_{{ idx }}" class="active">Descrizione voce</label>
                <input id="voce_desc_{{ idx }}" name="voci[{{ idx }}][descrizione]" type="text" class="form-control" placeholder="Descrizione voce" value="{{ voce.descrizione|default('') }}" required>
              </div>
              <div class="form-group col-md-3">
                <label for="voce_imp_{{ idx }}" class="input-symbol-label active">Importo voce</label>
                <div class="input-group input-number">
                    <span class="input-group-text fw-semibold">€</span>
                    <input id="voce_imp_{{ idx }}" name="voci[{{ idx }}][importo]" type="number" step="0.01" min="0.01" class="form-control" placeholder="0.00" value="{{ voce.importo|default('') }}" required>
                </div>
              </div>
              <div class="col-md-1 d-flex align-items-center">
                {# Spazio per pulsante rimuovi - lasciato vuoto per voci esistenti #}
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="row g-3 align-items-end voce-item" data-index="0">
            <div class="form-group col-md-3">
                <label class="active">ID voce</label>
                <div class="form-control-plaintext">1</div>
                <input type="hidden" name="voci[0][idVocePendenza]" value="1">
              </div>
            <div class="form-group col-md-5">
              <label for="voce_desc_0" class="active">Descrizione voce</label>
              <input id="voce_desc_0" name="voci[0][descrizione]" type="text" class="form-control" placeholder="Descrizione voce" value="{{ old.causale|default('') }}" required>
            </div>
            <div class="form-group col-md-3">
              <label for="voce_imp_0" class="input-symbol-label active">Importo voce</label>
              <div class="input-group input-number">
                <span class="input-group-text fw-semibold">€</span>
                <input id="voce_imp_0" name="voci[0][importo]" type="number" step="0.01" min="0.01" class="form-control" placeholder="0.00" value="{{ old.importo|default('') }}" required>
              </div>
            </div>
            <div class="col-md-1 d-flex align-items-center">
              {# Spazio per pulsante rimuovi - lasciato vuoto per prima voce #}
            </div>
          </div>
        {% endif %}
      </div>
      <div class="mt-2 mb-4">
        <button type="button" id="addVoceBtn" class="btn btn-outline-secondary btn-sm">Aggiungi voce</button>
      </div>
      <div id="vociSumError" class="alert alert-danger d-none" role="alert"></div>
      <div class="collapse" id="apiExtra">
        <div class="card card-body">
          <h4 class="h6">Campi avanzati (API)</h4>
            <div class="row g-3">
              <div class="col-md-4">
                <label for="ibanAccredito">IBAN accredito (opzionale)</label>
                <input id="ibanAccredito" name="ibanAccredito" type="text" maxlength="34" class="form-control" placeholder="IT.." value="{{ old.ibanAccredito|default('') }}">
                <div class="form-text small">Se presente, l'IBAN sarà inviato e il codice entrata non verrà inviato.</div>
              </div>
                <div class="col-md-4">
                <label for="codiceContabilita" class="active">Codice contabilita' (opzionale)</label>
                <input id="codiceContabilita" name="codiceContabilita" type="text" maxlength="35" pattern="[A-Za-z0-9\-_.]{1,35}" class="form-control" placeholder="Es. 0114111AP" value="{{ old.codiceContabilita|default(old.codEntrata|default('')) }}">
                <div class="form-text small">Se non è presente l'IBAN, questo valore verrà inviato come <code>codiceContabilita</code>. Non usare caratteri speciali.</div>
              </div>
              <div class="col-md-4">
                <label for="tipoBollo" class="active">Tipo bollo (opzionale)</label>
                <input id="tipoBollo" name="tipoBollo" type="text" maxlength="16" class="form-control" placeholder="Es. 01" value="{{ old.tipoBollo|default('') }}">
              </div>
              <div class="col-md-4">
                <div class="select-wrapper">
                  <label for="tipoContabilita" class="active">Tipo contabilità (opzionale)</label>
                  <select id="tipoContabilita" name="tipoContabilita" class="form-select">
                  <option value="">-- seleziona --</option>
                  <option value="CAPITOLO" {% if old.tipoContabilita is defined and old.tipoContabilita == 'CAPITOLO' %}selected{% endif %}>CAPITOLO</option>
                  <option value="SPECIALE" {% if old.tipoContabilita is defined and old.tipoContabilita == 'SPECIALE' %}selected{% endif %}>SPECIALE</option>
                  <option value="SIOPE" {% if old.tipoContabilita is defined and old.tipoContabilita == 'SIOPE' %}selected{% endif %}>SIOPE</option>
                  <option value="ALTRO" {% if old.tipoContabilita is defined and old.tipoContabilita == 'ALTRO' %}selected{% endif %}>ALTRO</option>
                  </select>
                  <div class="form-text small">Obbligatorio se si invia un codice entrata o altri dati di contabilita'.</div>
                </div>
              </div>
            </div>
            <div class="row g-3 mt-2">
              <div class="col-md-4">
                  <label for="direzione">Direzione (opzionale)</label>
                  <input id="direzione" name="direzione" type="text" class="form-control" value="{{ old.direzione|default('') }}">
                </div>
              <div class="col-md-4">
                <label for="divisione">Divisione (opzionale)</label>
                <input id="divisione" name="divisione" type="text" class="form-control" value="{{ old.divisione|default('') }}">
              </div>
              <div class="col-md-4">
                <label for="cartellaPagamento">Cartella pagamento (opzionale)</label>
                <input id="cartellaPagamento" name="cartellaPagamento" type="text" class="form-control" value="{{ old.cartellaPagamento|default('') }}">
              </div>
            </div>
        </div>
      </div>

      <div class="d-flex gap-2 mt-4">
        <button type="submit" formaction="/pendenze/preview" formmethod="post" class="btn btn-outline-primary">Anteprima</button>
        <button type="submit" class="btn btn-primary" {% if not id_a2a %}disabled{% endif %}>Crea pendenza</button>
        <a class="btn btn-outline-secondary" href="/pendenze/ricerca">Annulla</a>
        <button type="button" class="btn btn-link ms-auto" data-bs-toggle="collapse" data-bs-target="#apiExtra" aria-expanded="false">Mostra campi avanzati</button>
      </div>
    </div>
  </form>

      <script>
    (function(){
      // Toggle PF/PJ
      const pf = document.getElementById('soggettoPF');
      const pj = document.getElementById('soggettoPJ');
      const colNome = document.getElementById('colNome');
      const lblAnagrafica = document.getElementById('lblAnagrafica');
      const anag = document.getElementById('anagrafica');
      const importoMain = document.getElementById('importo');
      const causale = document.getElementById('causale');

      function refreshPersona(){
        const isPF = pf.checked;
        if (colNome) colNome.style.display = isPF ? '' : 'none';
        lblAnagrafica.textContent = isPF ? 'Cognome' : 'Ragione sociale';
        anag.placeholder = isPF ? 'Cognome' : 'Ragione sociale';
      }
      pf.addEventListener('change', refreshPersona);
      pj.addEventListener('change', refreshPersona);
      refreshPersona();

      // Sincronizza la prima voce con causale/importo (solo se è vuota)
      const firstVoceDesc = document.querySelector('#vociList .voce-item input[name$="[descrizione]"]');
      const firstVoceImp = document.querySelector('#vociList .voce-item input[name$="[importo]"]');
      let userModifiedFirstVoce = firstVoceDesc && firstVoceDesc.value.trim() !== '';

      const syncVoce0 = function(){
        if (userModifiedFirstVoce) return;
        if (firstVoceDesc && causale) firstVoceDesc.value = causale.value || '';
        if (firstVoceImp && importoMain) firstVoceImp.value = importoMain.value || '';
      };

      // Ferma sincronizzazione se utente modifica manualmente la prima voce
      if (firstVoceDesc) {
        firstVoceDesc.addEventListener('input', function() {
          userModifiedFirstVoce = true;
        });
      }

      if (causale) causale.addEventListener('input', syncVoce0);
      if (importoMain) importoMain.addEventListener('input', syncVoce0);
      syncVoce0();

      // Validation: ensure sum of voci importo == main importo before submit
      const formEl = document.querySelector('form');
      const vociSumError = document.getElementById('vociSumError');
      function clearVociErrors() {
        vociSumError.classList.add('d-none');
        Array.from(document.querySelectorAll('#vociList input[name$="[importo]"]')).forEach(function(i){
          i.classList.remove('is-invalid');
        });
      }
      function validateVociSum(e){
        clearVociErrors();
        const total = parseFloat((importoMain && importoMain.value) ? importoMain.value : '0') || 0;
        let sum = 0;
        const inputs = Array.from(document.querySelectorAll('#vociList input[name$="[importo]"]'));
        inputs.forEach(function(inp){ sum += parseFloat(inp.value) || 0; });
        // Round to cents
        const sumRounded = Math.round(sum * 100) / 100;
        const totalRounded = Math.round(total * 100) / 100;
        if (Math.abs(sumRounded - totalRounded) > 0.01) {
          if (e) e.preventDefault();
          vociSumError.textContent = 'La somma delle voci (' + sumRounded.toFixed(2) + ') non corrisponde all\'importo principale (' + totalRounded.toFixed(2) + ').';
          vociSumError.classList.remove('d-none');
          inputs.forEach(function(i){ i.classList.add('is-invalid'); });
          // scroll to error
          vociSumError.scrollIntoView({behavior:'smooth',block:'center'});
          return false;
        }
        return true;
      }
      if (formEl) {
        formEl.addEventListener('submit', function(ev){
          // only validate for POST submissions that create/preview pendenza
          // allow non-submit buttons/links to function
          if (!validateVociSum(ev)) return false;
        });
      }

  // Aggiungi nuove voci
  let voceIndex = Math.max(0, document.querySelectorAll('#vociList .voce-item').length);
      document.getElementById('addVoceBtn').addEventListener('click', function(){
        const container = document.getElementById('vociList');
        const row = document.createElement('div');
        row.className = 'row g-3 align-items-end voce-item';
        row.setAttribute('data-index', voceIndex);
        row.innerHTML = `
          <div class="form-group col-md-3">
            <label class="active">ID voce</label>
            <div class="form-control-plaintext">${voceIndex + 1}</div>
            <input type="hidden" name="voci[${voceIndex}][idVocePendenza]" value="${voceIndex + 1}">
          </div>
          <div class="form-group col-md-5">
            <label for="voce_desc_${voceIndex}" class="active">Descrizione voce</label>
            <input id="voce_desc_${voceIndex}" name="voci[${voceIndex}][descrizione]" type="text" class="form-control" placeholder="Descrizione voce" required>
          </div>
          <div class="form-group col-md-2">
            <label for="voce_imp_${voceIndex}" class="input-symbol-label active">Importo voce</label>
            <div class="input-group input-number">
              <span class="input-group-text fw-semibold">€</span>
              <input id="voce_imp_${voceIndex}" name="voci[${voceIndex}][importo]" type="number" step="0.01" min="0.01" class="form-control" placeholder="0.00" required>
            </div>
          </div>
          <div class="form-group col-md-1 d-flex align-items-center">
            <button type="button" class="btn btn-outline-danger btn-sm remove-voce">✖</button>
          </div>
        `;
        container.appendChild(row);
        row.querySelector('.remove-voce').addEventListener('click', function(){ row.remove(); });
        voceIndex++;
      });
      // Disable codiceContabilita input when IBAN is present
      const ibanInput = document.getElementById('ibanAccredito');
      const codiceContabilitaInput = document.getElementById('codiceContabilita');
      function refreshCodiceContabilitaState(){
        if (!ibanInput || !codiceContabilitaInput) return;
        if (ibanInput.value && ibanInput.value.trim() !== '') {
          codiceContabilitaInput.disabled = true;
          codiceContabilitaInput.classList.add('disabled');
        } else {
          codiceContabilitaInput.disabled = false;
          codiceContabilitaInput.classList.remove('disabled');
        }
      }
      if (ibanInput && codiceContabilitaInput) {
        ibanInput.addEventListener('input', refreshCodiceContabilitaState);
        refreshCodiceContabilitaState();
      }
      // Se l'utente compila uno qualsiasi dei campi Entrata, scegliamo quale
      // rappresentazione inviare: Entrata completa (IBAN+Tipo+Codice) oppure
      // RiferimentoEntrata (solo Codice) come fallback. Mostriamo un messaggio
      // informativo e non forziamo la validazione lato client per tutti e tre.
      const tipoContSelect = document.getElementById('tipoContabilita');
      const entrataModeInfo = document.createElement('div');
      entrataModeInfo.id = 'entrataModeInfo';
      entrataModeInfo.className = 'form-text small text-muted mb-2';
      // Inseriamo il messaggio subito dopo i campi avanzati
      const apiExtraBody = document.querySelector('#apiExtra .card-body');
      if (apiExtraBody) apiExtraBody.appendChild(entrataModeInfo);

      function refreshEntrataState(){
        if (!codiceContabilitaInput || !tipoContSelect || !ibanInput || !entrataModeInfo) return;
        const hasIban = ibanInput.value && ibanInput.value.trim() !== '';
        const hasTipo = tipoContSelect.value && tipoContSelect.value !== '';
        const hasCod = codiceContabilitaInput.value && codiceContabilitaInput.value.trim() !== '';
        if (hasIban && hasTipo && hasCod) {
          entrataModeInfo.textContent = 'Invio come Entrata completa (IBAN, Tipo contabilita e Codice contabilita).';
          entrataModeInfo.classList.remove('text-danger');
        } else if (hasCod && !(hasIban && hasTipo)) {
          entrataModeInfo.textContent = 'Invio come RiferimentoEntrata (solo codiceEntrata) perché mancano IBAN o Tipo contabilita.';
          entrataModeInfo.classList.add('text-muted');
        } else if (hasIban || hasTipo) {
          entrataModeInfo.textContent = 'Dati parziali: per inviare una Entrata completa compila IBAN, Tipo contabilita e Codice; in alternativa inserisci solo il Codice per inviare un RiferimentoEntrata.';
          entrataModeInfo.classList.add('text-warning');
        } else {
          entrataModeInfo.textContent = '';
          entrataModeInfo.classList.remove('text-warning');
        }
      }
      if (codiceContabilitaInput && tipoContSelect && ibanInput) {
        codiceContabilitaInput.addEventListener('input', refreshEntrataState);
        tipoContSelect.addEventListener('change', refreshEntrataState);
        ibanInput.addEventListener('input', refreshEntrataState);
        refreshEntrataState();
      }
    })();
  </script>
{% endblock %}
