{% extends 'base.html.twig' %}

{% block title %}Documento multirata{% endblock %}

{% block content %}
  <h1 class="it-title">Documento multirata: {{ multi.documento.identificativo }}</h1>
  <p><strong>Descrizione:</strong> {{ multi.documento.descrizione }}</p>
  <h2>Dati soggetto</h2>
  <pre>{{ multi.soggettoPagatore|json_encode(constant('JSON_PRETTY_PRINT')) }}</pre>
  <h2>Voci</h2>
  <pre>{{ multi.voci|json_encode(constant('JSON_PRETTY_PRINT')) }}</pre>
  <h2>Rate</h2>
  <table class="table table-sm">
    <thead><tr><th>#</th><th>Importo</th><th>Validita</th><th>Scadenza</th><th>ID Pendenza</th></tr></thead>
    <tbody>
      {% for r in multi.rates %}
        <tr>
          <td>{{ r.indice }}</td>
          <td>{{ r.importo }}</td>
          <td>{{ r.dataValidita }}</td>
          <td>{{ r.dataScadenza }}</td>
          <td>{{ r.idPendenza }}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
  <div class="mt-3">
    {% set numeri = [] %}
    {% for r in multi.rates %}
      {% if r.numeroAvviso %}
        {% set numeri = numeri|merge([r.numeroAvviso]) %}
      {% endif %}
    {% endfor %}
    {% if numeri|length > 0 %}
      <button id="stampa-doc-btn" class="btn btn-primary">Stampa documento</button>
      <script>
        (function(){
          const btn = document.getElementById('stampa-doc-btn');
          const numeri = {{ numeri|json_encode|raw }};
          const idDom = '{{ multi.idDominio|e('js') }}';
          const docId = '{{ multi.documento.identificativo|e('js') }}';
          btn.addEventListener('click', async function(e){
            e.preventDefault();
            if (!numeri || numeri.length === 0) {
              alert('Nessun avviso disponibile per il download');
              return;
            }
            btn.disabled = true;
            const orig = btn.textContent;
            btn.textContent = 'Preparazione...';
            try {
              const resp = await fetch('/documenti/' + encodeURIComponent(idDom) + '/' + encodeURIComponent(docId) + '/avvisi', {
                method: 'POST',
                headers: {'Accept':'application/pdf','Content-Type':'application/json'},
                body: JSON.stringify({ numeriAvviso: numeri })
              });
              if (!resp.ok) throw new Error('Errore server: ' + resp.status);
              const blob = await resp.blob();
              const url = URL.createObjectURL(blob);
              window.open(url, '_blank');
            } catch (err) {
              alert('Errore durante la chiamata API: ' + err.message);
              console.error(err);
            } finally {
              btn.disabled = false;
              btn.textContent = orig;
            }
          });
        })();
      </script>
    {% else %}
      <button class="btn btn-primary" disabled>Stampa documento</button>
    {% endif %}
    <a class="btn btn-outline-secondary" href="/pendenze/ricerca">Torna all'elenco</a>
  </div>
{% endblock %}
