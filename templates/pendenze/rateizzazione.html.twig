{% extends 'base.html.twig' %}

{% block title %}Rateizzazione pendenza{% endblock %}

{% block content %}
  <h1 class="it-title">Rateizzazione</h1>

  <form method="post" action="/pendenze/preview">
    <input type="hidden" name="original_params" value="{{ params|json_encode|e }}">
    {# Reincludi i principali campi originali come hidden per sicurezza (soggettoPagatore, idTipoPendenza, ecc.) #}
    {% for k,v in params %}
      {% if v is iterable and k == 'voci' %}
        {# Include anche le voci originali come hidden così il Preview le può mostrare se torni indietro #}
        {% for idx, vv in v %}
          <input type="hidden" name="voci[{{ idx }}][idVocePendenza]" value="{{ vv.idVocePendenza|e }}">
          <input type="hidden" name="voci[{{ idx }}][descrizione]" value="{{ vv.descrizione|e }}">
          <input type="hidden" name="voci[{{ idx }}][importo]" value="{{ vv.importo|e }}">
        {% endfor %}
      {% elseif v is iterable %}
        {% for sk, sv in v %}
          {% if sv is iterable %}
            <input type="hidden" name="{{ k|e }}[{{ sk|e }}]" value="{{ sv|json_encode|e }}">
          {% else %}
            <input type="hidden" name="{{ k|e }}[{{ sk|e }}]" value="{{ sv|e }}">
          {% endif %}
        {% endfor %}
      {% else %}
        <input type="hidden" name="{{ k|e }}" value="{{ v|e }}">
      {% endif %}
    {% endfor %}
    {% if errors is defined and errors %}
    <div class="alert alert-danger">
      <ul class="mb-0">
        {% for e in errors %}
          <li>{{ e }}</li>
        {% endfor %}
      </ul>
      {# Show only sanitized errors in UI. For full HTTP exchange, enable APP_DEBUG and check logs. #}
    </div>
  {% endif %}
    <div class="card mb-3">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <div class="d-flex gap-2 align-items-center">
            <label for="rateCount" class="mb-0 small text-muted">Numero rate</label>
            <input id="rateCount" name="rate" type="number" min="1" value="{{ parts|length }}" class="form-control form-control-sm" style="width:80px">
            <button id="recalcBtn" type="button" class="btn btn-sm btn-outline-secondary">Ricalcola</button>
          </div>
          <div class="d-flex gap-2 align-items-center">
            <label for="validitaFrequency" class="mb-0 small text-muted">Intervallo validità</label>
            <select id="validitaFrequency" class="form-select form-select-sm" style="width:140px">
              <option value="1">Mensile</option>
              <option value="2">Bimestrale</option>
              <option value="6">Semestrale</option>
              <option value="12">Annuale</option>
            </select>
            <button id="recalcValiditaBtn" type="button" class="btn btn-sm btn-outline-secondary">Ricalcola validità</button>
          </div>
        </div>

        <table class="table table-sm align-middle">
          <thead>
            <tr><th>#</th><th class="w-50">Importo</th><th>Validità</th><th>Scadenza <button id="copyDatesBtnHeader" type="button" class="btn btn-link btn-sm p-0 ms-2" title="Copia validità → scadenza">Copia</button><button id="clearDatesBtnHeader" type="button" class="btn btn-link btn-sm p-0 ms-2 text-danger" title="Azzera scadenze">Azzera</button></th></tr>
          </thead>
          <tbody id="rateRows">
            {% for p in parts %}
              <tr>
                <td>{{ p.indice }}</td>
                <td><input type="number" step="0.01" name="parts[{{ loop.index0 }}][importo]" value="{{ p.importo }}" class="form-control"></td>
                <td><input type="date" name="parts[{{ loop.index0 }}][dataValidita]" value="{{ p.dataValidita|default(p.data_validita|default('')) }}" class="form-control"></td>
                <td><input type="date" name="parts[{{ loop.index0 }}][dataScadenza]" value="{{ params.parts is defined ? (p.dataScadenza|default(p.data_scadenza|default(''))) : '' }}" class="form-control"></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
          <div class="d-flex justify-content-end mt-2">
            <div id="partsSum" class="fw-semibold">Totale rate: €<span id="partsSumValue">0.00</span></div>
          </div>
      </div>
    </div>

    <div class="d-flex gap-2">
    <div class="me-auto d-flex gap-2 align-items-center">
    </div>
      <!-- Invia a preview/conferma includendo le "parts" modificate -->
      <button type="submit" class="btn btn-primary">Aggiungi rate</button>
      <!-- Annulla: costruisce e invia esplicitamente un form POST verso /pendenze/preview -->
      <button type="button" id="btnAnnulla" class="btn btn-outline-secondary">Annulla</button>
    </div>
  </form>

  <script>
  (function(){
    function splitAmount(total, n) {
      if (n <= 1) return [Math.round(total*100)/100];
      const base = Math.floor((total / n) * 100) / 100.0;
      const parts = [Math.round((total - base*(n-1))*100)/100];
      for (let i=1;i<n;i++) parts.push(base);
      return parts;
    }
    function buildPartsWithDates(total, n) {
      const parts = splitAmount(total,n);
      const rows = [];
      const today = new Date();
      for (let i=0;i<parts.length;i++){
        const d = new Date(today.getFullYear(), today.getMonth() + i + 1, today.getDate());
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,'0');
        const day = String(d.getDate()).padStart(2,'0');
        // default: populate only dataValidita; leave dataScadenza empty so user can decide
        rows.push({indice:i+1, importo: parts[i].toFixed(2), dataValidita: y + '-' + m + '-' + day, dataScadenza: ''});
      }
      return rows;
    }
    // Controllo che la somma delle rate sia uguale all'importo totale prima dell'invio
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e){
      const total = {{ importo }};
      let sum = 0;
      document.querySelectorAll('#rateRows input[name$="[importo]"]').forEach(function(inp){
        const v = parseFloat(inp.value) || 0;
        sum += v;
      });
      sum = Math.round(sum * 100)/100;
      if (Math.abs(sum - total) > 0.01) {
        e.preventDefault();
        alert('La somma delle rate (' + sum.toFixed(2) + ') non corrisponde all\'importo totale (' + total.toFixed(2) + ').');
      }
    });

    document.getElementById('recalcBtn').addEventListener('click', function(){
      const count = Math.max(1, parseInt(document.getElementById('rateCount').value || '3', 10));
      const total = {{ importo }};
      const rows = buildPartsWithDates(total, count);
      const tbody = document.getElementById('rateRows');
      tbody.innerHTML = '';
      rows.forEach(function(r, idx){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.indice}</td>
          <td><input type="number" step="0.01" name="parts[${idx}][importo]" value="${r.importo}" class="form-control"></td>
          <td><input type="date" name="parts[${idx}][dataValidita]" value="${r.dataValidita}" class="form-control"></td>
          <td><input type="date" name="parts[${idx}][dataScadenza]" value="" class="form-control"></td>`;
        tbody.appendChild(tr);
      });
      // update total after rebuild
      updatePartsSum();
    });
    // Ricalcola le validità successive a partire dalla prima in base all'intervallo scelto
    const recalcValiditaBtn = document.getElementById('recalcValiditaBtn');
    if (recalcValiditaBtn) {
      recalcValiditaBtn.addEventListener('click', function(){
        const freq = parseInt(document.getElementById('validitaFrequency').value || '1', 10);
        const tbody = document.getElementById('rateRows');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        if (rows.length === 0) return;
        const firstValiditaInput = rows[0].querySelector('input[name^="parts"][name$="[dataValidita]"]');
        if (!firstValiditaInput || !firstValiditaInput.value) { alert('Imposta la validità della prima rata prima di ricalcolare le successive.'); return; }
        const firstDate = new Date(firstValiditaInput.value + 'T00:00:00');
        rows.forEach(function(tr, idx){
          if (idx === 0) return; // skip first
          const monthsToAdd = freq * idx;
          const d = new Date(firstDate.getTime());
          d.setMonth(d.getMonth() + monthsToAdd);
          const y = d.getFullYear();
          const m = String(d.getMonth()+1).padStart(2,'0');
          const day = String(d.getDate()).padStart(2,'0');
          const input = tr.querySelector('input[name^="parts"][name$="[dataValidita]"]');
          if (input) input.value = y + '-' + m + '-' + day;
        });
      });
    }
    // Copy validita -> scadenza when requested (header button)
    const copyBtn = document.getElementById('copyDatesBtnHeader');
    if (copyBtn) {
      copyBtn.addEventListener('click', function(){
        const tbody = document.getElementById('rateRows');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        rows.forEach(function(tr, idx){
          const validita = tr.querySelector('input[name^="parts"][name$="[dataValidita]"]');
          let scadenza = tr.querySelector('input[name^="parts"][name$="[dataScadenza]"]');
          if (!scadenza) {
            scadenza = document.createElement('input');
            scadenza.type = 'hidden';
            scadenza.name = 'parts['+idx+'][dataScadenza]';
            tr.appendChild(scadenza);
          }
          if (validita && scadenza) scadenza.value = validita.value || '';
        });
      });
    }
    // Clear (azzera) all dataScadenza values when requested
    const clearBtn = document.getElementById('clearDatesBtnHeader');
    if (clearBtn) {
      clearBtn.addEventListener('click', function(){
        const tbody = document.getElementById('rateRows');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        rows.forEach(function(tr, idx){
          let scadenza = tr.querySelector('input[name^="parts"][name$="[dataScadenza]"]');
          if (scadenza) {
            scadenza.value = '';
          } else {
            // create hidden empty input so POST includes empty value
            const inp = document.createElement('input'); inp.type = 'hidden'; inp.name = 'parts['+idx+'][dataScadenza]'; inp.value = ''; tr.appendChild(inp);
          }
        });
      });
    }
      // helper: update live sum of parts importo
      function updatePartsSum(){
        const inputs = Array.from(document.querySelectorAll('#rateRows input[name$="[importo]"]'));
        let sum = 0;
        inputs.forEach(function(i){ sum += parseFloat(i.value) || 0; });
        const rounded = Math.round(sum * 100) / 100;
        const el = document.getElementById('partsSumValue');
        if (el) el.textContent = rounded.toFixed(2);
        // highlight in red if differs from main importo
        try {
          const total = Math.round(({{ importo }} || 0) * 100) / 100;
          const container = document.getElementById('partsSum');
          if (Math.abs(rounded - total) > 0.01) {
            if (container) container.classList.add('text-danger');
          } else {
            if (container) container.classList.remove('text-danger');
          }
        } catch(e) {
          // ignore if importo not available
        }
      }

      // live update on input changes via delegation
      const rateRowsEl = document.getElementById('rateRows');
      if (rateRowsEl) {
        rateRowsEl.addEventListener('input', function(e){
          if (!e.target) return; // defensive
          if (e.target.name && e.target.name.indexOf('[importo]') !== -1) updatePartsSum();
        });
      }

      // initialize sum on load
      updatePartsSum();

      // Annulla: submit a sanitized clone of the form to /pendenze/preview
      const annullaBtn = document.getElementById('btnAnnulla');
      if (annullaBtn) {
        annullaBtn.addEventListener('click', function(){
          const origForm = document.querySelector('form');
          if (!origForm) return;
          const f = document.createElement('form');
          f.method = 'post';
          f.action = '/pendenze/preview';
          // clone inputs (serialize current visible values)
          Array.from(origForm.elements).forEach(function(el){
            if (!el.name) return;                        
            // If this is a parts input (rate fields) skip it: Annulla should NOT persist rate edits
            if (el.name.indexOf('parts[') === 0) return;
            // skip the client-side rate count control
            if (el.name === 'rate') return;
            // skip buttons
            if (el.type === 'button' || el.type === 'submit' || el.disabled) return;
            // handle checkboxes/radios
            if ((el.type === 'checkbox' || el.type === 'radio') && !el.checked) return;
            if (el.tagName === 'SELECT') {
              const val = el.value;
              const inp = document.createElement('input'); inp.type = 'hidden'; inp.name = el.name; inp.value = val; f.appendChild(inp);
              return;
            }
            if (el.type === 'file') return; // skip files
            // preserve array-like names (except parts) by creating hidden inputs with same name
            const inp = document.createElement('input'); inp.type = 'hidden'; inp.name = el.name; inp.value = el.value; f.appendChild(inp);
          });
          document.body.appendChild(f);
          f.submit();
        });
      }
  })();
  </script>
{% endblock %}
