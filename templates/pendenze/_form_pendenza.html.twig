{# Partial riusabile per campi pendenza (inserimento e modifica) #}
{# Parametri attesi:
   old: array con valori precedenti
   tipologie_pendenze: lista tipologie
   default_anno: anno di riferimento default
   is_edit: boolean (true se modifica)
 #}
<div class="row">
  <div class="form-group col-md-6">
    <div class="select-wrapper">
      <label for="idTipoPendenza" class="active">Tipologia pendenza</label>
      <select id="idTipoPendenza" name="idTipoPendenza" required aria-label="Tipologia pendenza">
        <option value="">-- seleziona --</option>
        {% for t in tipologie_pendenze|default([]) %}
          <option value="{{ t.id_entrata }}" {% if old.idTipoPendenza is defined and old.idTipoPendenza == t.id_entrata %}selected{% endif %}>{{ t.nome|default(t.descrizione)|e }}</option>
        {% endfor %}
      </select>
    </div>
  </div>
  <div class="form-group col-md-3">
    <div class="select-wrapper">
      <label for="annoRiferimento" class="active">Anno di riferimento</label>
      {% set current = default_anno|default(date('Y')) %}
      <select id="annoRiferimento" name="annoRiferimento" required aria-label="Anno di riferimento">
        {% for y in range(current + 1, current - 10) %}
          <option value="{{ y }}" {% if (old.annoRiferimento is defined and old.annoRiferimento == y) or (old.annoRiferimento is not defined and y == current) %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>
    </div>
  </div>
  <div class="form-group col-md-3">
    <label for="importo" class="input-symbol-label active">Importo</label>
    <div class="input-group input-number">
      <span class="input-group-text fw-semibold">€</span>
      <input id="importo" name="importo" type="number" step="0.01" min="0.01" class="form-control" required placeholder="0.00" value="{{ old.importo is defined ? old.importo : '' }}">
    </div>
    <div class="form-text">Inserisci l'importo in euro (es. 100.50).</div>
  </div>
</div>
<div class="row g-3 mt-1">
  <div class="form-group col-12">
    <label for="causale" class="active">Causale / Descrizione</label>
    <input type="text" id="causale" name="causale" class="form-control" placeholder="Inserisci la causale della pendenza" value="{{ old.causale|default('') }}" maxlength="140" autocomplete="off">
    <div class="d-flex justify-content-between small text-muted mt-1">
      <span>Max 140 caratteri.</span>
      <span id="causaleCounter">0/140</span>
    </div>
    <div class="form-text small">La causale verrà usata automaticamente per la prima voce se non ne viene specificata una diversa.</div>
  </div>
</div>
<div class="row g-3 mt-1">
  <div class="form-group col-md-4">
    <label for="dataValidita" class="active">Data validità (opzionale)</label>
    <input id="dataValidita" name="dataValidita" type="date" class="form-control" value="{{ old.dataValidita|default('') }}">
  </div>
  <div class="form-group col-md-4">
    <label for="dataScadenza" class="active">Data scadenza (opzionale)</label>
    <input id="dataScadenza" name="dataScadenza" type="date" class="form-control" value="{{ old.dataScadenza|default('') }}">
  </div>
</div>
<hr>
<h3 class="h6">Soggetto pagatore</h3>
<div class="row g-3 align-items-end">
  <div class="form-group col-12">
    <div class="form-check form-check-inline">
      <input class="form-check-input" type="radio" name="soggettoPagatore[tipo]" id="soggettoPF" value="F" {% if old.soggettoPagatore is defined and old.soggettoPagatore.tipo is defined and old.soggettoPagatore.tipo == 'G' %}{% else %}checked{% endif %}>
      <label class="form-check-label" for="soggettoPF">Persona fisica</label>
    </div>
    <div class="form-check form-check-inline">
      <input class="form-check-input" type="radio" name="soggettoPagatore[tipo]" id="soggettoPJ" value="G" {% if old.soggettoPagatore is defined and old.soggettoPagatore.tipo is defined and old.soggettoPagatore.tipo == 'G' %}checked{% endif %}>
      <label class="form-check-label" for="soggettoPJ">Persona giuridica</label>
    </div>
  </div>
</div>
<div class="row">
  {% set tipoSoggetto = old.soggettoPagatore.tipo|default('F') %}
  <div class="form-group col-md-4">
    <label id="identificativoLabel" for="identificativo" class="active">{{ tipoSoggetto == 'G' ? 'Partita IVA' : 'Codice fiscale' }}</label>
    <input id="identificativo" name="soggettoPagatore[identificativo]" type="text" class="form-control" placeholder="{{ tipoSoggetto == 'G' ? 'P.IVA' : 'CF' }}" required autocomplete="off" value="{{ old.soggettoPagatore.identificativo|default('') }}">
  </div>
  <div class="form-group col-md-4">
    <label id="lblAnagrafica" for="anagrafica" class="active">{{ tipoSoggetto == 'G' ? 'Ragione sociale' : 'Cognome' }}</label>
    <input id="anagrafica" name="soggettoPagatore[anagrafica]" type="text" class="form-control" placeholder="{{ tipoSoggetto == 'G' ? 'Ragione sociale' : 'Cognome' }}" required value="{{ old.soggettoPagatore.anagrafica|default('') }}">
  </div>
  <div class="form-group col-md-4" id="colNome" style="{{ tipoSoggetto == 'G' ? 'display:none;' : '' }}">
    <label for="nome" class="active">Nome (se persona fisica)</label>
    <input id="nome" name="soggettoPagatore[nome]" type="text" class="form-control" placeholder="Nome" autocomplete="off" value="{{ old.soggettoPagatore.nome|default('') }}">
  </div>
</div>
<div class="row">
  <div class="form-group col-md-6">
    <label for="email" class="active">Email (opzionale)</label>
    <input id="email" name="soggettoPagatore[email]" type="email" class="form-control" placeholder="esempio@dominio.it" value="{{ old.soggettoPagatore.email|default('') }}">
  </div>
</div>
<script>
(function(){
  const pf = document.getElementById('soggettoPF');
  const pj = document.getElementById('soggettoPJ');
  const idLabel = document.getElementById('identificativoLabel');
  const ident = document.getElementById('identificativo');
  const lblAnag = document.getElementById('lblAnagrafica');
  const anagraficaInput = document.getElementById('anagrafica');
  const nomeInput = document.getElementById('nome');
  const colNome = document.getElementById('colNome');
  function update(t){
    if(!idLabel || !ident || !lblAnag) return;
    if(t === 'G'){
      idLabel.textContent = 'Partita IVA';
      ident.placeholder = 'P.IVA';
      lblAnag.textContent = 'Ragione sociale';
      if(colNome) colNome.style.display = 'none';
    } else {
      idLabel.textContent = 'Codice fiscale';
      ident.placeholder = 'CF';
      lblAnag.textContent = 'Cognome';
      if(colNome) colNome.style.display = '';
    }
  }
  [pf,pj].forEach(function(r){ if(r) r.addEventListener('change', function(){ if(this.checked) update(this.value); }); });

  // Forza maiuscolo su CF/P.IVA, cognome/ragione sociale e nome
  function attachUppercase(el){
    if(!el) return;
    el.addEventListener('input', function(){
      const s = el.selectionStart; const e = el.selectionEnd;
      el.value = (el.value || '').toUpperCase();
      if(typeof s === 'number' && typeof e === 'number'){ try { el.setSelectionRange(s,e); } catch(_) {} }
    });
    // Normalizza anche su blur
    el.addEventListener('blur', function(){ el.value = (el.value || '').toUpperCase(); });
  }
  attachUppercase(ident);
  attachUppercase(anagraficaInput);
  attachUppercase(nomeInput);
})();
</script>
<hr>
<h3 class="h6">Voci di pendenza</h3>
<div class="d-flex align-items-center justify-content-between mb-5">
  <p class="text-muted small mb-0">Il sistema crea almeno una voce di pendenza; puoi aggiungerne altre se necessario.</p>
</div>
<div id="vociList">
  {% set existingVoci = old.voci|default([]) %}
  {% if existingVoci is iterable and existingVoci|length > 0 %}
    {% for idx, voce in existingVoci %}
      <div class="row g-3 align-items-end voce-item" data-index="{{ idx }}">
        <div class="form-group col-md-3">
          <label class="active">ID voce</label>
          <div class="form-control-plaintext">{{ voce.idVocePendenza|default('') }}</div>
          <input type="hidden" name="voci[{{ idx }}][idVocePendenza]" value="{{ voce.idVocePendenza|default('') }}">
        </div>
        <div class="form-group col-md-5">
          <label for="voce_desc_{{ idx }}" class="active">Descrizione voce</label>
          <input id="voce_desc_{{ idx }}" name="voci[{{ idx }}][descrizione]" type="text" class="form-control" placeholder="Descrizione voce" value="{{ voce.descrizione|default('') }}" required>
        </div>
        <div class="form-group col-md-3">
          <label for="voce_imp_{{ idx }}" class="input-symbol-label active">Importo voce</label>
          <div class="input-group input-number">
              <span class="input-group-text fw-semibold">€</span>
              <input id="voce_imp_{{ idx }}" name="voci[{{ idx }}][importo]" type="number" step="0.01" min="0.01" class="form-control" placeholder="0.00" value="{{ voce.importo|default('') }}" required>
          </div>
        </div>
        <div class="col-md-1 d-flex align-items-center">
          {# Nessun pulsante rimuovi per voci già esistenti #}
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="row g-3 align-items-end voce-item" data-index="0">
      <div class="form-group col-md-3">
          <label class="active">ID voce</label>
          <div class="form-control-plaintext">1</div>
          <input type="hidden" name="voci[0][idVocePendenza]" value="1">
        </div>
      <div class="form-group col-md-5">
        <label for="voce_desc_0" class="active">Descrizione voce</label>
        <input id="voce_desc_0" name="voci[0][descrizione]" type="text" class="form-control" placeholder="Descrizione voce" value="{{ old.causale|default('') }}" required>
      </div>
      <div class="form-group col-md-3">
        <label for="voce_imp_0" class="input-symbol-label active">Importo voce</label>
        <div class="input-group input-number">
          <span class="input-group-text fw-semibold">€</span>
          <input id="voce_imp_0" name="voci[0][importo]" type="number" step="0.01" min="0.01" class="form-control" placeholder="0.00" value="{{ old.importo|default('') }}" required>
        </div>
      </div>
      <div class="col-md-1 d-flex align-items-center">
        {# Nessun pulsante rimuovi per prima voce #}
      </div>
    </div>
  {% endif %}
</div>
<div class="mt-2 mb-4">
  <button type="button" id="addVoceBtn" class="btn btn-outline-secondary btn-sm">Aggiungi voce</button>
</div>
<div id="vociSumError" class="alert alert-danger d-none" role="alert"></div>
<div id="formValidationErrors" class="alert alert-danger d-none" role="alert"></div>
<div class="collapse" id="apiExtra">
  <div class="card card-body">
    <h4 class="h6">Campi avanzati (API)</h4>
      <div class="row g-3">
        <div class="col-md-4">
          <label for="ibanAccredito" class="active">IBAN accredito (opzionale)</label>
          <input id="ibanAccredito" name="ibanAccredito" type="text" maxlength="34" class="form-control" placeholder="IT.." value="{{ old.ibanAccredito|default('') }}">
          <div class="form-text small">Se presente, l'IBAN sarà inviato e il codice entrata non verrà inviato.</div>
        </div>
        <div class="col-md-4">
          <label for="codiceContabilita" class="active">Codice contabilita' (opzionale)</label>
          <input id="codiceContabilita" name="codiceContabilita" type="text" maxlength="35" pattern="[A-Za-z0-9\-_.]{1,35}" class="form-control" placeholder="Es. 0114111AP" value="{{ old.codiceContabilita|default(old.codEntrata|default('')) }}">
          <div class="form-text small">Se non è presente l'IBAN, questo valore verrà inviato come <code>codiceContabilita</code>. Non usare caratteri speciali.</div>
        </div>
        <div class="col-md-4">
          <label for="tipoBollo" class="active">Tipo bollo (opzionale)</label>
          <input id="tipoBollo" name="tipoBollo" type="text" maxlength="16" class="form-control" placeholder="Es. 01" value="{{ old.tipoBollo|default('') }}">
        </div>
        <div class="col-md-4">
          <div class="select-wrapper">
            <label for="tipoContabilita" class="active">Tipo contabilità (opzionale)</label>
            <select id="tipoContabilita" name="tipoContabilita" class="form-select">
              <option value="">-- seleziona --</option>
              <option value="CAPITOLO" {% if old.tipoContabilita is defined and old.tipoContabilita == 'CAPITOLO' %}selected{% endif %}>CAPITOLO</option>
              <option value="SPECIALE" {% if old.tipoContabilita is defined and old.tipoContabilita == 'SPECIALE' %}selected{% endif %}>SPECIALE</option>
              <option value="SIOPE" {% if old.tipoContabilita is defined and old.tipoContabilita == 'SIOPE' %}selected{% endif %}>SIOPE</option>
              <option value="ALTRO" {% if old.tipoContabilita is defined and old.tipoContabilita == 'ALTRO' %}selected{% endif %}>ALTRO</option>
            </select>
            <div class="form-text small">Obbligatorio se si invia un codice entrata o altri dati di contabilita'.</div>
          </div>
        </div>
      </div>
      <div class="row g-3 mt-2">
        <div class="col-md-4">
          <label for="direzione" class="active">Direzione (opzionale)</label>
          <input id="direzione" name="direzione" type="text" class="form-control" value="{{ old.direzione|default('') }}">
        </div>
        <div class="col-md-4">
          <label for="divisione" class="active">Divisione (opzionale)</label>
          <input id="divisione" name="divisione" type="text" class="form-control" value="{{ old.divisione|default('') }}">
        </div>
        <div class="col-md-4">
          <label for="cartellaPagamento" class="active">Cartella pagamento (opzionale)</label>
          <input id="cartellaPagamento" name="cartellaPagamento" type="text" class="form-control" value="{{ old.cartellaPagamento|default('') }}">
        </div>
      </div>
  </div>
</div>
{# Script condiviso per aggiunta/rimozione voci + validazione somma + stato entrata #}
<script>
(function(){
  const importoMain = document.getElementById('importo');
  const causale = document.getElementById('causale');
  const firstVoceDesc = document.querySelector('#vociList .voce-item input[name$="[descrizione]"]');
  const firstVoceImp = document.querySelector('#vociList .voce-item input[name$="[importo]"]');
  let userModifiedFirstVoce = firstVoceDesc && firstVoceDesc.value.trim() !== '';
  try { const initialVoceCount = document.querySelectorAll('#vociList .voce-item').length; if (initialVoceCount > 1) userModifiedFirstVoce = true; } catch(e) {}
  function syncVoce0(){
    if (userModifiedFirstVoce) return;
    if (firstVoceDesc && causale) firstVoceDesc.value = causale.value || '';
    if (firstVoceImp && importoMain) firstVoceImp.value = importoMain.value || '';
  }
  if (firstVoceDesc) firstVoceDesc.addEventListener('input', function(){ userModifiedFirstVoce = true; });
  if (firstVoceImp) firstVoceImp.addEventListener('input', function(){ userModifiedFirstVoce = true; });
  if (causale) causale.addEventListener('input', syncVoce0);
  if (importoMain) importoMain.addEventListener('input', syncVoce0);
  syncVoce0();
  // Add voce button
  let voceIndex = Math.max(0, document.querySelectorAll('#vociList .voce-item').length);
  const addBtn = document.getElementById('addVoceBtn');
  if (addBtn) addBtn.addEventListener('click', function(){
    userModifiedFirstVoce = true;
    const container = document.getElementById('vociList');
    const row = document.createElement('div');
    row.className = 'row g-3 align-items-end voce-item';
    row.setAttribute('data-index', voceIndex);
    row.innerHTML = `
      <div class="form-group col-md-3">
        <label class="active">ID voce</label>
        <div class="form-control-plaintext">${voceIndex + 1}</div>
        <input type="hidden" name="voci[${voceIndex}][idVocePendenza]" value="${voceIndex + 1}">
      </div>
      <div class="form-group col-md-5">
        <label for="voce_desc_${voceIndex}" class="active">Descrizione voce</label>
        <input id="voce_desc_${voceIndex}" name="voci[${voceIndex}][descrizione]" type="text" class="form-control" placeholder="Descrizione voce" required>
      </div>
      <div class="form-group col-md-2">
        <label for="voce_imp_${voceIndex}" class="input-symbol-label active">Importo voce</label>
        <div class="input-group input-number">
          <span class="input-group-text fw-semibold">€</span>
          <input id="voce_imp_${voceIndex}" name="voci[${voceIndex}][importo]" type="number" step="0.01" min="0.01" class="form-control" placeholder="0.00" required>
        </div>
      </div>
      <div class="form-group col-md-1 d-flex align-items-center">
        <button type="button" class="btn btn-outline-danger btn-sm remove-voce">✖</button>
      </div>`;
    container.appendChild(row);
    row.querySelector('.remove-voce').addEventListener('click', function(){ row.remove(); });
    voceIndex++;
  });
  // IBAN vs codice contabilita toggle
  const ibanInput = document.getElementById('ibanAccredito');
  const codiceContabilitaInput = document.getElementById('codiceContabilita');
  function refreshCodiceContabilitaState(){
    if (!ibanInput || !codiceContabilitaInput) return;
    if (ibanInput.value && ibanInput.value.trim() !== '') {
      codiceContabilitaInput.disabled = true;
      codiceContabilitaInput.classList.add('disabled');
    } else {
      codiceContabilitaInput.disabled = false;
      codiceContabilitaInput.classList.remove('disabled');
    }
  }
  if (ibanInput && codiceContabilitaInput) {
    ibanInput.addEventListener('input', refreshCodiceContabilitaState);
    refreshCodiceContabilitaState();
  }
  // Entrata state info
  const tipoContSelect = document.getElementById('tipoContabilita');
  const entrataModeInfo = document.createElement('div');
  entrataModeInfo.id = 'entrataModeInfo';
  entrataModeInfo.className = 'form-text small text-muted mb-2';
  const apiExtraBody = document.querySelector('#apiExtra .card-body');
  if (apiExtraBody) apiExtraBody.appendChild(entrataModeInfo);
  function refreshEntrataState(){
    if (!codiceContabilitaInput || !tipoContSelect || !ibanInput || !entrataModeInfo) return;
    const hasIban = ibanInput.value && ibanInput.value.trim() !== '';
    const hasTipo = tipoContSelect.value && tipoContSelect.value !== '';
    const hasCod = codiceContabilitaInput.value && codiceContabilitaInput.value.trim() !== '';
    if (hasIban && hasTipo && hasCod) {
      entrataModeInfo.textContent = 'Invio come Entrata completa (IBAN, Tipo contabilita e Codice contabilita).';
      entrataModeInfo.classList.remove('text-danger');
    } else if (hasCod && !(hasIban && hasTipo)) {
      entrataModeInfo.textContent = 'Invio come RiferimentoEntrata (solo codiceEntrata) perché mancano IBAN o Tipo contabilita.';
      entrataModeInfo.classList.add('text-muted');
    } else if (hasIban || hasTipo) {
      entrataModeInfo.textContent = 'Dati parziali: per inviare una Entrata completa compila IBAN, Tipo contabilita e Codice; in alternativa inserisci solo il Codice per inviare un RiferimentoEntrata.';
      entrataModeInfo.classList.add('text-warning');
    } else {
      entrataModeInfo.textContent = '';
      entrataModeInfo.classList.remove('text-warning');
    }
  }
  if (codiceContabilitaInput && tipoContSelect && ibanInput) {
    codiceContabilitaInput.addEventListener('input', refreshEntrataState);
    tipoContSelect.addEventListener('change', refreshEntrataState);
    ibanInput.addEventListener('input', refreshEntrataState);
    refreshEntrataState();
  }
  // Validazione somma voci
  const vociSumError = document.getElementById('vociSumError');
  function clearVociErrors(){
    vociSumError.classList.add('d-none');
    Array.from(document.querySelectorAll('#vociList input[name$="[importo]"]')).forEach(function(i){ i.classList.remove('is-invalid'); });
  }
  function validateVociSum(e){
    clearVociErrors();
    const total = parseFloat((importoMain && importoMain.value) ? importoMain.value : '0') || 0;
    let sum = 0;
    const inputs = Array.from(document.querySelectorAll('#vociList input[name$="[importo]"]'));
    inputs.forEach(function(inp){ sum += parseFloat(inp.value) || 0; });
    const sumRounded = Math.round(sum * 100) / 100;
    const totalRounded = Math.round(total * 100) / 100;
    if (Math.abs(sumRounded - totalRounded) > 0.01) {
      if (e) e.preventDefault();
      vociSumError.textContent = 'La somma delle voci (' + sumRounded.toFixed(2) + ') non corrisponde all\'importo principale (' + totalRounded.toFixed(2) + ').';
      vociSumError.classList.remove('d-none');
      inputs.forEach(function(i){ i.classList.add('is-invalid'); });
      vociSumError.scrollIntoView({behavior:'smooth',block:'center'});
      return false;
    }
    return true;
  }
  // --- Validazioni aggiuntive (causale, CF/P.IVA) ---
  const errorsBox = document.getElementById('formValidationErrors');
  function pushError(msg){
    if(!errorsBox) return;
    errorsBox.classList.remove('d-none');
    errorsBox.innerHTML += '<div>' + msg.replace(/</g,'&lt;') + '</div>';
  }
  function clearFormErrors(){ if(errorsBox){ errorsBox.classList.add('d-none'); errorsBox.innerHTML=''; } }
  function updateCausaleCounter(){
    const c = document.getElementById('causale');
    const cnt = document.getElementById('causaleCounter');
    if(!c || !cnt) return;
    const len = c.value.length; cnt.textContent = len + '/140';
    if(len > 140) cnt.classList.add('text-danger'); else cnt.classList.remove('text-danger');
  }
  updateCausaleCounter();
  if(causale) causale.addEventListener('input', updateCausaleCounter);
  function validateCausale(){
    if(!causale) return true;
    const val = causale.value.trim();
    if(val.length > 140){ pushError('La causale supera i 140 caratteri ('+ val.length +').'); return false; }
    if(val.length === 0){ pushError('Causale obbligatoria.'); return false; }
    return true;
  }
  // Codice fiscale: controllo pattern + prime 3 lettere cognome + prime 3 lettere nome (regole semplificate)
  function codFiscaleBlockFromString(str, isName){
    const s = (str||'').toUpperCase().replace(/[^A-Z]/g,'');
    const consonants = s.replace(/[AEIOU]/g,'');
    const vowels = s.replace(/[^AEIOU]/g,'');
    let block = '';
    if(isName){
      // Regola semplificata nome: se >=4 consonanti prende 1a,3a,4a altrimenti prime 3 consonanti
      if(consonants.length >=4){ block = consonants[0] + consonants[2] + consonants[3]; }
      else block = consonants.slice(0,3);
    } else {
      block = consonants.slice(0,3);
    }
    if(block.length < 3) block += vowels.slice(0, 3 - block.length);
    while(block.length < 3) block += 'X';
    return block;
  }
  function validateCodiceFiscale(cf, nome, cognome){
    const CF_PATTERN = /^[A-Z0-9]{16}$/;
    if(!cf || !CF_PATTERN.test(cf)) return 'Formato codice fiscale non valido';
    const blockCognome = codFiscaleBlockFromString(cognome,false);
    const blockNome = codFiscaleBlockFromString(nome,true);
    if(cf.substring(0,3) !== blockCognome || cf.substring(3,6) !== blockNome){
      return 'Codice fiscale non coerente con nome/cognome';
    }
    // Controllo carattere di controllo (semplificato)
    const evenMap = {0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,'A':0,'B':1,'C':2,'D':3,'E':4,'F':5,'G':6,'H':7,'I':8,'J':9,'K':10,'L':11,'M':12,'N':13,'O':14,'P':15,'Q':16,'R':17,'S':18,'T':19,'U':20,'V':21,'W':22,'X':23,'Y':24,'Z':25};
    const oddMap = {0:1,1:0,2:5,3:7,4:9,5:13,6:15,7:17,8:19,9:21,'A':1,'B':0,'C':5,'D':7,'E':9,'F':13,'G':15,'H':17,'I':19,'J':21,'K':2,'L':4,'M':18,'N':20,'O':11,'P':3,'Q':6,'R':8,'S':12,'T':14,'U':16,'V':10,'W':22,'X':25,'Y':24,'Z':23};
    const controlChars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    let sum = 0;
    for(let i=0;i<15;i++){
      const ch = cf[i];
      if(i%2===0){ sum += oddMap[ch]; } else { sum += evenMap[ch]; }
    }
    const expected = controlChars[sum % 26];
    if(cf[15] !== expected) return 'Carattere di controllo codice fiscale non valido';
    return null; // ok
  }
  function validatePartitaIva(piva){
    if(!piva) return 'Partita IVA obbligatoria';
    const p = piva.replace(/[^0-9]/g,'');
    if(p.length !== 11) return 'La partita IVA deve contenere 11 cifre';
    let sum = 0;
    for(let i=0;i<10;i++){
      let n = parseInt(p[i],10);
      if(i%2===0){ // posizione dispari (0-based) -> somma semplice
        sum += n;
      } else { // posizione pari -> *2 e somma cifre
        n = n*2; if(n>9) n = n-9; sum += n;
      }
    }
    const check = (10 - (sum % 10)) % 10;
    if(check !== parseInt(p[10],10)) return 'Partita IVA non valida (check digit)';
    return null;
  }
  function validateIdentity(){
    const tipoPF = document.getElementById('soggettoPF');
    const tipoPJ = document.getElementById('soggettoPJ');
    const ident = document.getElementById('identificativo');
    const cognome = document.getElementById('anagrafica');
    const nome = document.getElementById('nome');
    if(!ident) return true;
    const raw = ident.value.trim();
    if(tipoPF && tipoPF.checked){
      const err = validateCodiceFiscale(raw.toUpperCase(), nome?nome.value.trim():'' , cognome?cognome.value.trim():'' );
      if(err){ pushError(err); ident.classList.add('is-invalid'); return false; }
      ident.classList.remove('is-invalid'); return true;
    } else if(tipoPJ && tipoPJ.checked){
      const err = validatePartitaIva(raw);
      if(err){ pushError(err); ident.classList.add('is-invalid'); return false; }
      ident.classList.remove('is-invalid'); return true;
    }
    return true;
  }
  function runAllValidations(ev){
    clearFormErrors();
    const okCausale = validateCausale();
    const okIdent = validateIdentity();
    const okVoci = validateVociSum(ev);
    if(!(okCausale && okIdent && okVoci)){
      if(ev) ev.preventDefault();
      if(errorsBox) errorsBox.scrollIntoView({behavior:'smooth',block:'center'});
      return false;
    }
    return true;
  }
  const formEl = document.querySelector('form');
  if (formEl) formEl.addEventListener('submit', function(ev){ if(!runAllValidations(ev)) return false; });
})();
</script>