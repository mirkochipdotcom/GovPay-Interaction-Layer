<VirtualHost *:443>
    ServerName ${APACHE_SERVER_NAME}

    # Ora il DocumentRoot punta direttamente alla cartella ricostruita "public"
    DocumentRoot /var/www/html/public

    # Rimuoviamo gli ErrorDocument personalizzati per lasciare la gestione degli errori a Slim
    # (Slim intercetter√† 404 e 500 tramite ErrorMiddleware). Eventuali 403 restano di default Apache.

    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined

   
    SSLEngine on
    SSLCertificateFile /ssl/server.crt
    SSLCertificateKeyFile /ssl/server.key

    # ----------------------------------------------------------------------
    # BLOCCO DI SICUREZZA: Impedisci l'accesso diretto a cartelle sensibili
    # ----------------------------------------------------------------------

    # Nega l'accesso alla cartella delle dipendenze Composer
    <Directory /var/www/html/vendor>
        Require all denied
    </Directory>

    # Nega l'accesso ai metadata SP (contengono la chiave privata)
    <Directory /var/www/html/metadata-sp>
        Require all denied
    </Directory>

    # ----------------------------------------------------------------------
    # Fine Blocchi di Sicurezza
    # ----------------------------------------------------------------------

    <Directory /var/www/html>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    # Le regole di rewrite sono demandate al file .htaccess dentro /public
    <Directory /var/www/html/public>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

</VirtualHost>

<VirtualHost *:80>
    ServerName ${APACHE_SERVER_NAME}
    Redirect permanent / https://${APACHE_SERVER_NAME}/
</VirtualHost>
