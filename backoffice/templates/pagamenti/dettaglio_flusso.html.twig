{% extends 'base.html.twig' %}

{% block title %}Pagamenti - Dettaglio Flusso{% endblock %}

{% block content %}
  <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-4">
    <div>
      <h1 class="h3 mb-1">Dettaglio flusso di rendicontazione</h1>
      <p class="text-muted mb-0 small">Visualizza i dati di un flusso acquisito da pagoPA</p>
    </div>
    <a class="btn btn-outline-secondary" href="{{ return_url|default('/pagamenti/ricerca-flussi') }}">
      <i class="fas fa-arrow-left me-1"></i> Torna ai risultati
    </a>
  </div>

  {% if errors is defined and errors %}
    <div class="alert alert-danger" role="alert">
      <ul class="mb-0">
        {% for e in errors %}<li>{{ e }}</li>{% endfor %}
      </ul>
    </div>
  {% endif %}

  {% if flusso %}
    {% set flow = flusso %}
    {% set idFlusso = flow.idFlusso|default(flow.id_flusso|default(id_flusso|default(''))) %}
    {% set stato = flow.stato|default(flow.statoFlusso|default('')) %}
    {% set dataFlusso = flow.dataFlusso|default(flow.data|default(data_flusso|default(''))) %}
    {% set dataRegolamento = flow.dataRegolamento|default(flow.data_regolamento|default('')) %}
    {% set idDominio = flow.idDominio|default(flow.dominio.idDominio|default(id_dominio|default(''))) %}
    {% set dominioNome = flow.ragioneSocialeDominio|default(flow.dominio.ragioneSociale|default('')) %}
    {% set idPsp = flow.idPsp|default(flow.id_psp|default('')) %}
    {% set pspNome = flow.ragioneSocialePsp|default(flow.psp.ragioneSociale|default('')) %}
    {% set importoTotale = flow.importoTotale|default(flow.importo_totale|default(null)) %}
    {% set numeroPagamenti = flow.numeroPagamenti|default(flow.numero_pagamenti|default(null)) %}
    {% set trn = flow.trn|default('') %}
    {% set bic = flow.bicRiversamento|default(flow.bic_riversamento|default('')) %}
    {% set flow_return_url = '/pagamenti/ricerca-flussi/dettaglio' %}
    {% if idFlusso %}
      {% set flow_return_url = flow_return_url ~ '/' ~ idFlusso %}
    {% endif %}
    {% if return_url is defined and return_url %}
      {% set flow_return_url = flow_return_url ~ '?return=' ~ return_url|url_encode %}
    {% endif %}

    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <div class="row g-4">
          <div class="col-12 col-lg-6">
            <h2 class="h5 mb-3">Informazioni generali</h2>
            <dl class="row small mb-0">
              <dt class="col-sm-5 text-muted">ID flusso</dt>
              <dd class="col-sm-7 text-break">{{ idFlusso ?: '—' }}</dd>
              <dt class="col-sm-5 text-muted">Data flusso</dt>
              <dd class="col-sm-7">{% if dataFlusso %}{{ dataFlusso|date('d/m/Y H:i:s') }}{% else %}—{% endif %}</dd>
              <dt class="col-sm-5 text-muted">Data regolamento</dt>
              <dd class="col-sm-7">{% if dataRegolamento %}{{ dataRegolamento|date('d/m/Y H:i:s') }}{% else %}—{% endif %}</dd>
              <dt class="col-sm-5 text-muted">Stato</dt>
              <dd class="col-sm-7">
                {% if stato %}
                  <span class="badge bg-primary text-white px-3 py-2">{{ stato }}</span>
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </dd>
            </dl>
          </div>
          <div class="col-12 col-lg-6">
            <h2 class="h5 mb-3">Soggetti coinvolti</h2>
            <dl class="row small mb-0">
              <dt class="col-sm-5 text-muted">Dominio</dt>
              <dd class="col-sm-7">
                {% if idDominio %}<strong>{{ idDominio }}</strong>{% else %}<span class="text-muted">—</span>{% endif %}
                {% if dominioNome %}<div class="text-muted">{{ dominioNome }}</div>{% endif %}
              </dd>
              <dt class="col-sm-5 text-muted">PSP</dt>
              <dd class="col-sm-7">
                {% if idPsp %}<strong>{{ idPsp }}</strong>{% else %}<span class="text-muted">—</span>{% endif %}
                {% if pspNome %}<div class="text-muted">{{ pspNome }}</div>{% endif %}
              </dd>
              <dt class="col-sm-5 text-muted">TRN</dt>
              <dd class="col-sm-7">{{ trn ?: '—' }}</dd>
              <dt class="col-sm-5 text-muted">BIC riversamento</dt>
              <dd class="col-sm-7">{{ bic ?: '—' }}</dd>
            </dl>
          </div>
        </div>
        <hr class="my-4">
        <div class="row text-center g-3">
          <div class="col-12 col-md-6 col-lg-3">
            <div class="border rounded p-3 h-100 bg-light">
              <div class="text-muted small">Numero pagamenti</div>
              <div class="h4 mb-0">{{ numeroPagamenti is not null ? numeroPagamenti : '—' }}</div>
            </div>
          </div>
          <div class="col-12 col-md-6 col-lg-3">
            <div class="border rounded p-3 h-100 bg-light">
              <div class="text-muted small">Importo totale</div>
              <div class="h4 mb-0">{% if importoTotale is not null %}{{ importoTotale|number_format(2, ',', '.') }} €{% else %}—{% endif %}</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    {% set segnalazioni = flow.segnalazioni|default(flow.segnalazioni_flusso|default([])) %}
    {% if segnalazioni %}
      <div class="card border-warning-subtle mb-4">
        <div class="card-header bg-warning-subtle text-warning-emphasis">Segnalazioni del flusso</div>
        <div class="card-body">
          <ul class="mb-0 small">
            {% for s in segnalazioni %}
              <li>
                <strong>{{ s.codice|default('N/D') }}</strong>
                {% if s.descrizione %}<span class="ms-1">{{ s.descrizione }}</span>{% endif %}
              </li>
            {% endfor %}
          </ul>
        </div>
      </div>
    {% endif %}

    {% set pagamenti = flow.rendicontazioni|default(flow.pagamenti|default([])) %}
    <div class="card shadow-sm">
      <div class="card-header bg-light border-bottom py-3">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h2 class="h6 mb-0 text-uppercase text-secondary">Pagamenti rendicontati</h2>
            <p class="mb-0 small text-muted">Dettaglio dei singoli pagamenti presenti nel flusso</p>
          </div>
          <span class="badge bg-primary text-white">{{ pagamenti|length }}</span>
        </div>
      </div>
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th scope="col" class="text-center">#</th>
              <th scope="col">IUV / Voce</th>
              <th scope="col">Causale</th>
              <th scope="col">Tipologia</th>
              <th scope="col">Anno Rif.</th>
              <th scope="col" class="text-end">Importo</th>
              <th scope="col">Stato/Esito</th>
              <th scope="col" class="text-center">Dettaglio</th>
            </tr>
          </thead>
          <tbody>
            {% if pagamenti and pagamenti|length > 0 %}
              {% set esiti_map = {
                '0': 'Pagamento eseguito',
                '3': 'Pagamento revocato',
                '4': 'Stand-in',
                '8': 'Stand-in senza RPT',
                '9': 'Pagamento senza RPT'
              } %}
              {% set esiti_badge_map = {
                '0': 'bg-success',
                '3': 'bg-danger',
                '4': 'bg-warning text-dark',
                '8': 'bg-warning text-dark',
                '9': 'bg-info text-dark'
              } %}
              {% for p in pagamenti %}
                {% set idx = loop.index %}
                {% set risc = p.riscossione|default(null) %}
                {% if risc is iterable and risc|length == 0 %}
                  {% set risc = null %}
                {% endif %}
                {% set voce = {} %}
                {% if risc is not null and risc.vocePendenza is defined %}
                  {% set voce = risc.vocePendenza %}
                {% elseif p.vocePendenza is defined %}
                  {% set voce = p.vocePendenza %}
                {% endif %}
                {% set pend = voce.pendenza|default(p.pendenza|default({})) %}
                {% set iuv = p.iuv|default(risc.iuv|default(p.iuvPagamento|default(p.iuvAvviso|default('')))) %}
                {% set voceId = voce.idVocePendenza|default('') %}
                {% set causale = p.causale|default(voce.descrizione|default(pend.causale|default(''))) %}
                {% set tipologia = p.tipologia|default(pend.tipoPendenza.descrizione|default(pend.tipoPendenza.idTipoPendenza|default(''))) %}
                {% set anno = p.annoRiferimento|default(pend.annoRiferimento|default('')) %}
                {% set importo = p.importo|default(voce.importo|default(risc.importo|default(null))) %}
                {% set esito_code = p.stato|default(voce.stato|default(risc.stato|default(p.esito|default(p.esitoPagamento|default(''))))) %}
                {% set esito_label = esiti_map[esito_code ~ '']|default('') %}
                {% set esito_badge_class = esiti_badge_map[esito_code ~ '']|default('bg-secondary text-white') %}
                {% set collapseId = 'payRow-' ~ idx %}
                {% set hasDetail = risc is not null %}
                <tr{% if loop.index is even %} class="table-light"{% endif %}>
                  <td class="text-center small text-muted">{{ idx }}</td>
                  <td class="align-middle">
                    {% if voceId %}
                      <div class="fw-semibold text-nowrap">
                        <a href="/pendenze/dettaglio/{{ voceId|url_encode }}?return={{ flow_return_url|url_encode }}&origin=flusso" class="link-underline-opacity-0 link-underline-opacity-100-hover">
                          {{ voceId }}
                        </a>
                      </div>
                    {% endif %}
                    {% if iuv %}
                      <div class="small text-muted text-break">{{ iuv }}</div>
                    {% endif %}
                    {% if not iuv and not voceId %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>
                  <td>{{ causale ?: '—' }}</td>
                  <td>{{ tipologia ?: '—' }}</td>
                  <td class="text-nowrap">{{ anno ?: '—' }}</td>
                  <td class="text-end">{% if importo is not null %}{{ importo|number_format(2, ',', '.') }} €{% else %}—{% endif %}</td>
                  <td>
                    {% if esito_code %}
                      <span class="badge {{ esito_badge_class }}">{{ esito_code }}</span>
                      {% if esito_label %}<span class="ms-1 small text-muted">{{ esito_label }}</span>{% endif %}
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>
                  <td class="text-center">
                    {% if hasDetail %}
                      <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#{{ collapseId }}" aria-expanded="false" aria-controls="{{ collapseId }}" title="Mostra dettaglio">
                        <i class="fas fa-arrow-down"></i>
                      </button>
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>
                </tr>
                {% if hasDetail %}
                  {% set sogg = pend.soggettoPagatore|default(p.soggettoPagatore|default(p.debitore|default({}))) %}
                  {% set cf = sogg.identificativo|default('') %}
                  {% set den = sogg.anagrafica|default(sogg.denominazione|default('')) %}
                  {% set dataPag = pend.dataPagamento|default(risc.dataPagamento|default(risc.data|default(p.dataPagamento|default(p.data|default(''))))) %}
                  {% set rataDocumento = pend.documento.rata|default(voce.documento.rata|default('')) %}
                  {% set rata = pend.rata|default(voce.rata|default(p.rata|default(p.numeroRata|default(rataDocumento|default(''))))) %}
                  <tr class="detail-row">
                    <td colspan="8" class="p-0 border-0">
                      <div class="collapse" id="{{ collapseId }}">
                        <article class="it-card it-card-height-full rounded shadow-sm border"
                        <div class="card-body small">
                          <div class="row g-3">
                            <div class="col-12 col-md-6">
                              <h6 class="text-secondary text-uppercase mb-2">Soggetto</h6>
                              <dl class="row mb-0">
                                <dt class="col-sm-5 text-muted">Identificativo</dt>
                                <dd class="col-sm-7">{{ cf ?: '—' }}</dd>
                                <dt class="col-sm-5 text-muted">Denominazione</dt>
                                <dd class="col-sm-7">{{ den ?: '—' }}</dd>
                                <dt class="col-sm-5 text-muted">Email</dt>
                                <dd class="col-sm-7">{{ sogg.email|default('—') }}</dd>
                              </dl>
                            </div>
                            <div class="col-12 col-md-6">
                              <h6 class="text-secondary text-uppercase mb-2">Pagamento</h6>
                              <dl class="row mb-0">
                                <dt class="col-sm-5 text-muted">Data pagamento</dt>
                                <dd class="col-sm-7">{% if dataPag %}{{ dataPag|date('d/m/Y H:i') }}{% else %}—{% endif %}</dd>
                                <dt class="col-sm-5 text-muted">Rata</dt>
                                <dd class="col-sm-7">{{ rata ?: '—' }}</dd>
                                <dt class="col-sm-5 text-muted">Voce pendenza</dt>
                                <dd class="col-sm-7">
                                  {% if voceId %}
                                    <a href="/pendenze/dettaglio/{{ voceId|url_encode }}?return={{ flow_return_url|url_encode }}&origin=flusso" class="link-primary">
                                      {{ voceId }}
                                    </a>
                                  {% else %}
                                    <span class="text-muted">—</span>
                                  {% endif %}
                                </dd>
                              </dl>
                            </div>
                          </div>
                        </div>
                        </article>
                      </div>
                    </td>
                  </tr>
                {% endif %}
              {% endfor %}
            {% else %}
              <tr><td colspan="8" class="text-center text-muted">Nessun pagamento presente nel flusso</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="d-flex justify-content-end mt-4">
      <a class="btn btn-outline-secondary" href="{{ return_url|default('/pagamenti/ricerca-flussi') }}">
        <i class="fas fa-arrow-left me-1"></i> Torna ai risultati
      </a>
    </div>

    {% if app_debug and flusso %}
      <div class="card mt-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center gap-2">
            <span class="badge bg-warning text-dark">Debug</span>
            <span>Dati raw flusso</span>
          </div>
          <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#rawFlow" aria-expanded="false" aria-controls="rawFlow">
            Mostra/Nascondi
          </button>
        </div>
        <div id="rawFlow" class="collapse">
          <div class="card-body">
            <pre class="small text-break mb-0">{{ flusso|json_encode(constant('JSON_PRETTY_PRINT') b-or constant('JSON_UNESCAPED_SLASHES')) }}</pre>
          </div>
        </div>
      </div>
    {% endif %}
  {% else %}
    <div class="alert alert-warning">Nessun dettaglio disponibile per il flusso richiesto.</div>
  {% endif %}
{% endblock %}
