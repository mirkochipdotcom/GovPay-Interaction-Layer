{% extends 'base.html.twig' %}

{% block title %}Statistiche{% endblock %}

{% block content %}
  <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-md-between gap-2 mb-4">
    <div>
      <h1 class="h4 mb-1">Statistiche dei pagamenti</h1>
      <p class="text-muted mb-0">Aggregazioni fornite dall'API Backoffice di reportistica</p>
    </div>
    <div>
      <a href="/" class="btn btn-outline-secondary"><i class="fas fa-home me-1"></i> Home</a>
    </div>
  </div>

  {% if errors is defined and errors %}
    <div class="alert alert-danger" role="alert">
      <ul class="mb-0">
        {% for e in errors %}<li>{{ e }}</li>{% endfor %}
      </ul>
    </div>
  {% endif %}

  {% set f = filters ?? {} %}
  <form method="get" action="/statistiche" class="card shadow-sm mb-4">
    <div class="card-header bg-light border-bottom py-3">
      <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-lg-between gap-2">
        <div>
          <h2 class="h6 mb-0">Filtri</h2>
          <p class="small text-muted mb-0">Scegli intervallo temporale e raggruppamento</p>
        </div>
        <button type="submit" class="btn btn-primary"><i class="fas fa-sync me-1"></i> Aggiorna</button>
      </div>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-3">
          <label for="dataDa" class="form-label">Data da</label>
          <input type="date" class="form-control" id="dataDa" name="dataDa" value="{{ f.dataDa|default('') }}">
        </div>
        <div class="col-md-3">
          <label for="dataA" class="form-label">Data a</label>
          <input type="date" class="form-control" id="dataA" name="dataA" value="{{ f.dataA|default('') }}">
        </div>
        <div class="col-md-3">
          <label for="raggruppamento" class="form-label">Raggruppa per</label>
          <select id="raggruppamento" name="raggruppamento" class="form-select">
            {% for value,label in group_options %}
              <option value="{{ value }}" {% if f.raggruppamento|default('TIPO_PENDENZA') == value %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label for="idDominio" class="form-label">ID Dominio</label>
          <input type="text" class="form-control" id="idDominio" name="idDominio" value="{{ f.idDominio|default('') }}" placeholder="(opzionale)">
        </div>
      </div>
    </div>
  </form>

  {% set has_data = stats is defined and stats %}
  {% if has_data %}
    <div class="row g-3 mb-4">
      <div class="col-md-6">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <div class="text-muted text-uppercase small">Importo complessivo</div>
            <div class="display-6">€ {{ totals.amount|default(0)|number_format(2, ',', '.') }}</div>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <div class="text-muted text-uppercase small">Numero pagamenti</div>
            <div class="display-6">{{ totals.count|default(0)|number_format(0, ',', '.') }}</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm mb-4">
      <div class="card-header bg-light border-bottom py-3">
        <div class="d-flex flex-column flex-md-row justify-content-md-between align-items-md-center gap-2">
          <div>
            <h3 class="h6 mb-0">Distribuzione importi</h3>
            <p class="small text-muted mb-0">Somma degli incassi per categoria</p>
          </div>
        </div>
      </div>
      <div class="card-body">
        <canvas id="statsAmountChart" height="280"></canvas>
      </div>
    </div>

    <div class="card shadow-sm mb-4">
      <div class="card-header bg-light border-bottom py-3">
        <div class="d-flex flex-column flex-md-row justify-content-md-between align-items-md-center gap-2">
          <div>
            <h3 class="h6 mb-0">Numero pagamenti</h3>
            <p class="small text-muted mb-0">Conteggio transazioni per categoria</p>
          </div>
        </div>
      </div>
      <div class="card-body">
        <canvas id="statsCountChart" height="280"></canvas>
      </div>
    </div>

    <div class="row g-3 mb-4">
      <div class="col-md-6">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-light border-bottom py-3">
            <h3 class="h6 mb-0">Ripartizione importi (torta)</h3>
          </div>
          <div class="card-body" style="height:320px;">
            <canvas id="statsAmountPie" class="w-100" style="height:100%;"></canvas>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-light border-bottom py-3">
            <h3 class="h6 mb-0">Ripartizione pagamenti (torta)</h3>
          </div>
          <div class="card-body" style="height:320px;">
            <canvas id="statsCountPie" class="w-100" style="height:100%;"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm mb-4">
      <div class="card-header bg-light border-bottom py-3">
        <h3 class="h6 mb-0">Dettaglio dati</h3>
      </div>
      <div class="table-responsive">
        <table class="table table-striped align-middle mb-0">
          <thead>
            <tr>
              <th scope="col">Categoria</th>
              <th scope="col" class="text-end">Numero pagamenti</th>
              <th scope="col" class="text-end">Importo</th>
            </tr>
          </thead>
          <tbody>
            {% for row in stats %}
              <tr>
                <td>{{ row.label }}</td>
                <td class="text-end">{{ row.numero_pagamenti|number_format(0, ',', '.') }}</td>
                <td class="text-end">€ {{ row.importo|number_format(2, ',', '.') }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% else %}
    <div class="alert alert-info">Nessun dato disponibile per i filtri selezionati.</div>
  {% endif %}

  {% if app_debug and statistics_json %}
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-light border-bottom py-3 d-flex align-items-center gap-2">
        <span class="badge bg-warning text-dark">Debug</span>
        <span>Payload API /quadrature/riscossioni</span>
        <button class="btn btn-sm btn-outline-secondary ms-auto" type="button" data-bs-toggle="collapse" data-bs-target="#statsRawJson" aria-expanded="false" aria-controls="statsRawJson">Mostra/Nascondi</button>
      </div>
      <div id="statsRawJson" class="collapse">
        <div class="card-body">
          <pre class="small text-break mb-0">{{ statistics_json }}</pre>
        </div>
      </div>
    </div>
  {% endif %}

  {% if chart_payload_json %}
    <script src="/assets/chartjs/chart.umd.min.js"></script>
    <script>
      (function(){
        const payload = {{ chart_payload_json|raw }};
        const palette = ['#0a6dd4','#0f8bff','#33a1ff','#78b9ff','#a5cdfc','#cfe3ff','#4b8b3b','#65a060','#f1b244','#d05252','#7a5af8','#c41740'];
        const colors = payload.labels.map((_, idx) => palette[idx % palette.length]);

        function getCanvasContext(canvasId) {
          const canvas = document.getElementById(canvasId);
          if(!canvas || typeof Chart === 'undefined') {
            return null;
          }
          return canvas.getContext('2d');
        }

        function buildChart(canvasId, dataset, label){
          const ctx = getCanvasContext(canvasId);
          if(!ctx){ return; }
          new Chart(ctx, {
            type: 'bar',
            data: {
              labels: payload.labels,
              datasets: [{
                label,
                data: dataset,
                backgroundColor: colors,
                borderColor: '#ffffff',
                borderWidth: 1,
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: {
                  callbacks: {
                    label: (ctx) => {
                      const value = ctx.parsed.y;
                      if(canvasId === 'statsAmountChart') {
                        return new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' }).format(value);
                      }
                      return new Intl.NumberFormat('it-IT').format(value) + ' pagamenti';
                    }
                  }
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: function(value){
                      if(canvasId === 'statsAmountChart') {
                        return new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(value);
                      }
                      return new Intl.NumberFormat('it-IT').format(value);
                    }
                  }
                }
              }
            }
          });
        }

        buildChart('statsAmountChart', payload.amounts, 'Importi');
        buildChart('statsCountChart', payload.counts, 'Numero pagamenti');

        function buildPieChart(canvasId, dataset, title, isAmount){
          const ctx = getCanvasContext(canvasId);
          if(!ctx){ return; }
          new Chart(ctx, {
            type: 'pie',
            data: {
              labels: payload.labels,
              datasets: [{
                data: dataset,
                backgroundColor: colors,
                borderColor: '#ffffff',
                borderWidth: 2,
              }],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                title: { display: true, text: title },
                tooltip: {
                  callbacks: {
                    label: (ctx) => {
                      const value = ctx.parsed;
                      if (isAmount) {
                        return new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' }).format(value);
                      }
                      return new Intl.NumberFormat('it-IT').format(value) + ' pagamenti';
                    },
                  },
                },
              },
            },
          });
        }

        buildPieChart('statsAmountPie', payload.amounts, 'Totale incassato', true);
        buildPieChart('statsCountPie', payload.counts, 'Totale pagamenti', false);
      })();
    </script>
  {% endif %}
{% endblock %}
