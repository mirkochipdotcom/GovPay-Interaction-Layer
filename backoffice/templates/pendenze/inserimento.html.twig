{% extends 'base.html.twig' %}

{% block title %}Pendenze - Inserimento{% endblock %}

{% block content %}
 
  {% if errors is defined and errors %}
    <div class="alert alert-danger" role="alert">
      <ul class="mb-0">
        {% for e in errors %}<li>{{ e }}</li>{% endfor %}
      </ul>
    </div>
  {% endif %}

  {% if warnings is defined and warnings %}
    <div class="alert alert-warning" role="alert">
      <ul class="mb-0">
        {% for w in warnings %}<li>{{ w }}</li>{% endfor %}
      </ul>
    </div>
  {% endif %}

  <form method="post" action="/pendenze" class="card border-0 shadow-sm mb-4">
    <input type="hidden" name="return" value="/pendenze/ricerca">
    {% if id_dominio is defined and id_dominio %}
      <input type="hidden" name="idDominio" value="{{ id_dominio }}">
    {% endif %}

    {# ID A2A: deve essere preso esclusivamente dalla variabile d'ambiente (mostrato nel body per mantenere header in cima alla card) #}
    <div class="card-header bg-light border-bottom py-2">
      <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
        <div class="lh-1">
          <h2 class="h6 mb-0">Inserimento Nuova pendenza</h2>
          <small class="text-muted" style="font-size: 0.75rem;">Compila i campi obbligatori</small>
        </div>
        
        {% if not is_edit_mode and pendenza_templates is defined and pendenza_templates|length > 0 %}
        <div class="d-flex align-items-center gap-2 flex-grow-1 justify-content-md-end" style="max-width: 500px;">
          <label for="templateSelector" class="form-label mb-0 small text-nowrap fw-bold text-primary">
            <i class="fas fa-magic me-1"></i> Template:
          </label>
          <select id="templateSelector" class="form-select form-select-sm border-primary">
            <option value="">-- Seleziona per autocompilare --</option>
            {% for t in pendenza_templates %}
              <option value="{{ t.id }}" 
                      data-tipo="{{ t.id_tipo_pendenza }}" 
                      data-causale="{{ t.causale|e('html_attr') }}"
                      data-importo="{{ t.importo }}">
                {{ t.titolo }} ({{ t.importo|number_format(2, ',', '.') }} â‚¬)
              </option>
            {% endfor %}
          </select>
        </div>
        {% endif %}
      </div>
    </div>
    <div class="card-body">
      <div class="mb-3">
        {% if not id_a2a %}
          <div class="alert alert-warning small mb-0">Variabile di ambiente <code>ID_A2A</code> non impostata: imposta <code>ID_A2A</code> in <code>.env</code> prima di creare pendenze.</div>
        {% endif %}
      </div>
      {% include 'pendenze/_form_pendenza.html.twig' with {
        old: old,
        tipologie_pendenze: tipologie_pendenze,
        pendenza_templates: pendenza_templates|default([]),
        default_anno: default_anno,
        is_edit: false
      } %}

      <div class="d-flex gap-2 mt-4">
        <button type="submit" formaction="/pendenze/preview" formmethod="post" class="btn btn-primary">Anteprima</button>
        <a class="btn btn-outline-secondary" href="/pendenze/ricerca">Annulla</a>
        <button type="button" class="btn btn-link ms-auto" data-bs-toggle="collapse" data-bs-target="#apiExtra" aria-expanded="false">Mostra campi avanzati</button>
      </div>
    </div>
  </form>
{% endblock %}