{% extends 'base.html.twig' %}

{% block title %}Storico Inserimento Massivo{% endblock %}

{% block content %}
<div class="container my-4">
  <div class="row mb-4">
    <div class="col-12">
      <h1 class="it-title">Storico Caricamenti Massivi</h1>
      <p class="text-muted">Gestisci i batch di pendenze caricate: visualizza i dettagli, metti in pausa l'elaborazione, elimina i batch vuoti o annulla tutte le pendenze emesse sul nodo per un lotto chiuso.</p>
    </div>
  </div>

  {% if session.flash %}
    <div class="alert alert-{{ session.flash.type == 'error' ? 'danger' : session.flash.type }} alert-dismissible fade show" role="alert">
      {{ session.flash.message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Chiudi"></button>
    </div>
  {% endif %}

  <div class="row">
    <div class="col-12">
      <div class="card-wrapper card-space">
        <div class="card card-bg">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm table-striped table-hover align-middle">
                <thead>
                  <tr>
                    <th>Lotto (Batch ID)</th>
                    <th>Data Creazione</th>
                    <th>Tot.</th>
                    <th>Stato Avanzamento (Righe)</th>
                    <th class="text-end">Azioni Batch</th>
                  </tr>
                </thead>
                <tbody>
                {% for b in batch_list %}
                  <tr>
                    <td>
                      <strong>{{ b.file_batch_id }}</strong><br>
                      <a href="/pendenze/massivo/dettaglio?batch={{ b.file_batch_id }}&from=storico" class="small">Vedi righe &rarr;</a>
                    </td>
                    <td>{{ b.data_creazione|date('d/m/Y H:i') }}</td>
                    <td>{{ b.totale }}</td>
                    <td>
                      <div class="d-flex flex-wrap gap-1">
                        {% if b.pending > 0 %}<span class="badge bg-secondary">In Coda: {{ b.pending }}</span>{% endif %}
                        {% if b.paused > 0 %}<span class="badge bg-warning text-dark">In Pausa: {{ b.paused }}</span>{% endif %}
                        {% if b.processing > 0 %}<span class="badge bg-info">In Elab: {{ b.processing }}</span>{% endif %}
                        {% if b.success > 0 %}<span class="badge bg-success">Completate: {{ b.success }}</span>{% endif %}
                        {% if b.error > 0 %}<span class="badge bg-danger">Errori: {{ b.error }}</span>{% endif %}
                        {% if b.cancelled > 0 %}<span class="badge bg-dark">Annullate: {{ b.cancelled }}</span>{% endif %}
                      </div>
                    </td>
                    <td class="text-end">
                      <div class="btn-group" role="group">
                        
                        {# Bottoni Pausa / Riprendi #}
                        {% if b.pending > 0 %}
                          <form method="POST" action="/pendenze/massivo/{{ b.file_batch_id }}/pausa" style="display:inline-block">
                            <button class="btn btn-outline-warning btn-xs mb-1" title="Sospendi le elaborazioni del lotto in coda">
                              <svg class="icon icon-xs icon-warning"><use href="/assets/bootstrap-italia/svg/sprites.svg#it-pause"></use></svg> Pausa
                            </button>
                          </form>
                        {% endif %}
                        {% if b.paused > 0 %}
                          <form method="POST" action="/pendenze/massivo/{{ b.file_batch_id }}/riprendi" style="display:inline-block">
                            <button class="btn btn-outline-success btn-xs mb-1" title="Riprendi le elaborazioni (torneranno in coda)">
                              <svg class="icon icon-xs icon-success"><use href="/assets/bootstrap-italia/svg/sprites.svg#it-play"></use></svg> Riprendi
                            </button>
                          </form>
                        {% endif %}

                        {# Bottone Elimina (solo se sicuri di non aver inviato niente) #}
                        {% if b.processing == 0 and b.success == 0 and b.error == 0 %}
                          <form method="POST" action="/pendenze/massivo/{{ b.file_batch_id }}/elimina" onsubmit="return confirm('Eliminare fisicamente questo batch per ripulire la tabella?');" style="display:inline-block">
                            <button class="btn btn-outline-danger btn-xs mb-1" title="Elimina intero lotto in coda">
                              <svg class="icon icon-xs icon-danger"><use href="/assets/bootstrap-italia/svg/sprites.svg#it-close"></use></svg> Elimina
                            </button>
                          </form>
                        {% endif %}

                        {# Bottone Annulla al Nodo (solo per pendenze successfully create) #}
                        {% if b.success > 0 %}
                          <form method="POST" action="/pendenze/massivo/{{ b.file_batch_id }}/annulla" onsubmit="return confirm('ATTENZIONE: Stai per richiamare in blocco l\'annullamento al Nodo per tutte le {{ b.success }} pendenze andate a buon fine in questo lotto. Vuoi procedere?');" style="display:inline-block">
                            <button class="btn btn-outline-danger btn-xs mb-1 ms-1" title="Annulla le pendenze completate di questo batch">
                              <svg class="icon icon-xs icon-danger"><use href="/assets/bootstrap-italia/svg/sprites.svg#it-error"></use></svg> Annulla Pendenze (*{{ b.success }})
                            </button>
                          </form>
                        {% endif %}
                        
                      </div>
                    </td>
                  </tr>
                {% else %}
                  <tr>
                    <td colspan="5" class="text-center text-muted py-4">Nessun caricamento massivo registrato nello storico.</td>
                  </tr>
                {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
