{% extends 'base.html.twig' %}

{% block title %}Guida rapida - GovPay IL{% endblock %}

{% block content %}
  <div class="row mb-4">
    <div class="col-12 col-lg-8">
      <h2 class="mb-2">Guida rapida</h2>
      <p class="lead">Questa guida ti aiuta a capire a cosa serve l'applicativo e come svolgere le operazioni principali, in base ai tuoi permessi.</p>
      {% if current_user %}
        {%- set first = current_user.first_name|default('') -%}
        {%- set last = current_user.last_name|default('') -%}
        {%- set show_name = (first != '') or (last != '') -%}
        {%- if last != '' -%}
          {%- set display_name = (first ~ ' ' ~ last|upper)|trim -%}
        {%- else -%}
          {%- set display_name = first|trim -%}
        {%- endif -%}
        <p>Sei autenticato come <strong>{% if show_name %}{{ display_name }}{% else %}{{ current_user.email }}{% endif %}</strong> con ruolo <span class="badge bg-primary">{{ current_user.role }}</span>.</p>
      {% else %}
        <p class="text-warning">Non sei autenticato. Accedi per vedere le funzionalità a te consentite.</p>
      {% endif %}
    </div>
  </div>

  <div class="row g-4">
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h3 class="h5"><i class="fas fa-search me-2"></i> Operazioni comuni (tutti gli utenti)</h3>
          <ul class="mb-0">
            <li><strong>Pendenze → Ricerca:</strong> filtra per intervallo date, stato, importi, testo libero. I risultati sono ordinabili e paginati.</li>
            <li><strong>Dettaglio pendenza:</strong> clicca una riga per visualizzare i dettagli; troverai i riferimenti di pagamento (IUV/CCP) e gli esiti.</li>
            <li><strong>Download documenti:</strong> dal dettaglio puoi scaricare l'Avviso di pagamento e, quando disponibile, la Ricevuta Telematica (RT).</li>
            <li><strong>Inserimento pendenza:</strong> crea una nuova pendenza dal menu Pendenze → Inserimento.</li>
            <li><strong>Inserimento massivo:</strong> carica più pendenze contemporaneamente (file/CSV) da Pendenze → Inserimento massivo.</li>
            <li><strong>Profilo:</strong> vedi le informazioni del tuo account e, se previsto, aggiorna le credenziali.</li>
          </ul>
          <div class="mt-3">
            <a href="/pendenze/ricerca" class="btn btn-outline-primary btn-sm">Vai alla ricerca</a>
            <a href="/pendenze/inserimento" class="btn btn-outline-secondary btn-sm ms-2">Nuova pendenza</a>
          </div>
        </div>
      </div>
    </div>

    {% if current_user and current_user.role in ['admin','superadmin'] %}
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h3 class="h5"><i class="fas fa-users-cog me-2"></i> Gestione utenti (admin)</h3>
          <ul class="mb-0">
            <li><strong>Elenco e ricerca:</strong> la tab "Utenti" all'interno di Configurazione mostra tutti gli account con filtro rapido e contatore risultati.</li>
            <li><strong>Creazione/Modifica:</strong> puoi aggiungere o aggiornare un utente (email, nome, cognome, ruolo, password).</li>
            <li><strong>Disabilitazione:</strong> al posto della cancellazione ora puoi disabilitare un account (e riabilitarlo in seguito). Gli utenti disabilitati non possono accedere.</li>
            <li><strong>Vincoli di sicurezza:</strong> non puoi agire sul tuo account o sull'ultimo superadmin attivo; le azioni vengono registrate nei log applicativi.</li>
          </ul>
          <div class="mt-3">
            <a href="/configurazione?tab=utenti" class="btn btn-outline-primary btn-sm">Apri tab Utenti</a>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    {% if current_user and current_user.role in ['admin','superadmin'] %}
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body">
          <h3 class="h5"><i class="fas fa-tools me-2"></i> Amministrazione e configurazione (superadmin)</h3>
          <p class="mb-2">La pagina Configurazione raccoglie informazioni dal Backoffice GovPay e dalle API per verifiche e setup. Gli admin la consultano in sola lettura (eccetto la tab Utenti), mentre i superadmin possono intervenire sulle impostazioni.</p>
          <ul class="mb-0">
            <li><strong>Dati principali:</strong> mostra i dettagli del Dominio beneficiario (ragione sociale, stazione, GLN, CBill, conti di accredito, eventuale logo, ecc.).</li>
            <li><strong>Tipologie di pendenze:</strong> elenco delle Entrate configurate per il dominio (con ricerca client-side).</li>
            <li><strong>Gestionali e info:</strong> panoramica sugli applicativi integrati e sulle versioni / build dell'istanza GovPay.</li>
            <li><strong>Tab Utenti:</strong> la gestione account è integrata nella pagina, così non serve più una vista separata.</li>
            <li><strong>Debug (solo in ambiente di test):</strong> puoi espandere i dati grezzi (JSON) per diagnosi e controllo configurazioni.</li>
          </ul>
          <div class="mt-3">
            <a href="/configurazione" class="btn btn-outline-primary btn-sm">Apri Configurazione</a>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body">
          <h3 class="h5"><i class="fas fa-shield-alt me-2"></i> Ruoli e permessi</h3>
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>Funzionalità</th>
                  <th class="text-center">user</th>
                  <th class="text-center">admin</th>
                  <th class="text-center">superadmin</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Pendenze: ricerca e dettaglio</td>
                  <td class="text-center">✔</td>
                  <td class="text-center">✔</td>
                  <td class="text-center">✔</td>
                </tr>
                <tr>
                  <td>Pendenze: inserimento / massivo</td>
                  <td class="text-center">✔</td>
                  <td class="text-center">✔</td>
                  <td class="text-center">✔</td>
                </tr>
                <tr>
                  <td>Download Avviso / RT</td>
                  <td class="text-center">✔</td>
                  <td class="text-center">✔</td>
                  <td class="text-center">✔</td>
                </tr>
                <tr>
                  <td>Gestione utenti</td>
                  <td class="text-center">—</td>
                  <td class="text-center">✔</td>
                  <td class="text-center">✔</td>
                </tr>
                <tr>
                  <td>Configurazione (Backoffice/Info)</td>
                  <td class="text-center">—</td>
                  <td class="text-center">✔<br><span class="text-muted small">lettura + tab Utenti</span></td>
                  <td class="text-center">✔<br><span class="text-muted small">controllo completo</span></td>
                </tr>
              </tbody>
            </table>
          </div>
          <p class="text-muted small mb-0">Le autorizzazioni possono essere ulteriormente limitate dalla configurazione dell'istanza GovPay e dall'ambiente.</p>
        </div>
      </div>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-12 col-lg-8">
      <div class="alert alert-info d-flex align-items-start" role="alert">
        <i class="fas fa-info-circle fa-lg me-3 mt-1"></i>
        <div>
          <div class="fw-semibold">Suggerimenti</div>
          <ul class="mb-0">
            <li>Usa la barra di navigazione per accedere rapidamente alle aree di tuo interesse.</li>
            <li>Quando scarichi un documento, verifica che il browser non lo blocchi in pop-up.</li>
            <li>Se compaiono errori, riprova più tardi o contatta un amministratore.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

{% endblock %}
