<VirtualHost *:443>
    ServerName localhost

    # Espone la web-root di spid-cie-php (setup contiene proxy.php, login.php, ecc.)
    DocumentRoot /var/www/spid-cie-php/www

    # Espone SimpleSAMLphp (necessario per metadata e moduli)
    # Nota: baseurlpath di default è "myservice/" (vedi vendor/simplesamlphp/.../config.php)
    Alias /myservice /var/www/spid-cie-php/vendor/simplesamlphp/simplesamlphp/www

    <Directory /var/www/spid-cie-php/vendor/simplesamlphp/simplesamlphp/www>
        Options FollowSymLinks
        AcceptPathInfo On
        AllowOverride None
        Require all granted
    </Directory>

    # Metadata SPID (compat: /metadata.xml e /spid-metadata.xml)
    # Doc: /myservice/module.php/saml/sp/metadata.php/spid
    RewriteEngine On

    # SPID button (GET) loses context
    # Il bottone SPID generato da spid-cie-php, in modalità GET, usa link del tipo "?idp=...".
    # Questo SOSTITUISCE tutta la query string e fa perdere client_id/redirect_uri/state; il PHP quindi
    # redirige a /metadata.xml e il browser "scarica il metadata" invece di continuare il login.
    #
    # Soluzione (robusta): persistiamo la query completa in un cookie durante il primo caricamento di
    # proxy-home.php, poi la ripristiniamo quando arriva un GET con solo ?idp=...
    # (non dipendiamo dal Referer: può essere assente, o avere host/porta diversi).
    # Non modifica alcun file dentro il repository spid-cie-php (che è su volume ed è in gitignore).

    # 1) Quando proxy-home.php viene chiamato correttamente con client_id, salva la query string.
    RewriteCond %{REQUEST_URI} ^/proxy-home\.php$ [NC]
    RewriteCond %{QUERY_STRING} (^|&)client_id= [NC]
    RewriteCond %{QUERY_STRING} (.+)
    RewriteRule ^proxy-home\.php$ - [E=SPID_CTX:%1]

    # 2) Imposta cookie solo quando SPID_CTX è valorizzata.
    # Nota: usiamo 'add' per non sovrascrivere cookie applicativi (es. PHPSESSID).
    Header always add Set-Cookie "spid_ctx=%{SPID_CTX}e; Path=/; Secure; HttpOnly; SameSite=Lax" env=SPID_CTX

    # 3) Se arriva solo ?idp=..., ripristina la query da cookie e aggiungi idp.
    RewriteCond %{REQUEST_URI} ^/proxy-home\.php$ [NC]
    RewriteCond %{QUERY_STRING} (?:^|&)idp=([^&]+) [NC]
    RewriteCond %{QUERY_STRING} !(^|&)client_id= [NC]
    RewriteCond %{HTTP:Cookie} (?:^|;\s*)spid_ctx=([^;]+) [NC]
    RewriteRule ^proxy-home\.php$ /proxy-home.php?%2&idp=%1 [R=302,L,NE]

    # Fallback (best-effort): ricostruisci la query dal Referer (se presente) e aggiungi idp.
    RewriteCond %{REQUEST_URI} ^/proxy-home\.php$ [NC]
    RewriteCond %{QUERY_STRING} (^|&)idp=[^&]+ [NC]
    RewriteCond %{QUERY_STRING} !(^|&)client_id= [NC]
    RewriteCond %{HTTP:Referer} ^https?://[^/]+/proxy-home\.php\?([^#]+) [NC]
    RewriteRule ^proxy-home\.php$ - [E=SPID_REFQS:%1]

    RewriteCond %{ENV:SPID_REFQS} .+
    RewriteCond %{REQUEST_URI} ^/proxy-home\.php$ [NC]
    RewriteCond %{QUERY_STRING} (?:^|&)idp=([^&]+) [NC]
    RewriteCond %{QUERY_STRING} !(^|&)client_id= [NC]
    RewriteRule ^proxy-home\.php$ /proxy-home.php?%{ENV:SPID_REFQS}&idp=%1 [R=302,L,NE]

    # Preferisci un metadata congelato (attestato) se presente su disco.
    # Questo evita modifiche involontarie al metadata quando cambiano env/config.
    RewriteCond %{DOCUMENT_ROOT}/metadata/spid-metadata-current.xml -f
    RewriteRule ^/(metadata\.xml|spid-metadata\.xml)$ /metadata/spid-metadata-current.xml [L]

    # Endpoint opzionale per un metadata "next" (generato in parallelo e non ancora messo in produzione).
    RewriteCond %{DOCUMENT_ROOT}/metadata/spid-metadata-next.xml -f
    RewriteRule ^/spid-metadata-next\.xml$ /metadata/spid-metadata-next.xml [L]

    # Fallback: metadata dinamico generato da SimpleSAML.
    RewriteRule ^/(metadata\.xml|spid-metadata\.xml)$ /myservice/module.php/saml/sp/metadata.php/spid [PT,L]

    # Metadata CIE
    # Doc: /myservice/module.php/saml/sp/metadata.php/cie
    # Preferisci un metadata congelato (attestato) se presente su disco.
    RewriteCond %{DOCUMENT_ROOT}/metadata/cie-metadata-current.xml -f
    RewriteRule ^/cie-metadata\.xml$ /metadata/cie-metadata-current.xml [L]

    # Endpoint opzionale per un metadata "next" (generato in parallelo e non ancora messo in produzione).
    RewriteCond %{DOCUMENT_ROOT}/metadata/cie-metadata-next.xml -f
    RewriteRule ^/cie-metadata-next\.xml$ /metadata/cie-metadata-next.xml [L]

    # Fallback: metadata dinamico generato da SimpleSAML.
    RewriteRule ^/cie-metadata\.xml$ /myservice/module.php/saml/sp/metadata.php/cie [PT,L]

    # Alcuni tool di validazione scaricano usando Content-Disposition (es. curl -OJ).
    # Il metadata di SimpleSAML può proporre filename poco parlanti; qui forziamo un nome stabile.
    <LocationMatch "^/(metadata\.xml|spid-metadata\.xml|spid-metadata-next\.xml)$">
        Header set Content-Type "application/xml; charset=utf-8"
        Header set Content-Disposition "inline; filename=spid-metadata.xml"
    </LocationMatch>

    <LocationMatch "^/(cie-metadata\.xml|cie-metadata-next\.xml)$">
        Header set Content-Type "application/xml; charset=utf-8"
        Header set Content-Disposition "inline; filename=cie-metadata.xml"
    </LocationMatch>

    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined

    SSLEngine on
    SSLCertificateFile /ssl/server.crt
    SSLCertificateKeyFile /ssl/server.key

    <Directory /var/www/spid-cie-php>
        Options FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    <Directory /var/www/spid-cie-php/www>
        Options FollowSymLinks
        AcceptPathInfo On
        AllowOverride All
        Require all granted
    </Directory>
</VirtualHost>

<VirtualHost *:80>
    ServerName localhost
    Redirect permanent / https://localhost/
</VirtualHost>
