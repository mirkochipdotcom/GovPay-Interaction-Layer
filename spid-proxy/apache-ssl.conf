<VirtualHost *:443>
    ServerName localhost

    # Espone la web-root di spid-cie-php (setup contiene proxy.php, login.php, ecc.)
    DocumentRoot /var/www/spid-cie-php/www

    # Espone SimpleSAMLphp (necessario per metadata e moduli)
    # Nota: baseurlpath di default è "myservice/" (vedi vendor/simplesamlphp/.../config.php)
    Alias /myservice /var/www/spid-cie-php/vendor/simplesamlphp/simplesamlphp/www

    <Directory /var/www/spid-cie-php/vendor/simplesamlphp/simplesamlphp/www>
        Options FollowSymLinks
        AcceptPathInfo On
        AllowOverride None
        Require all granted
    </Directory>

    # Metadata SPID (compat: /metadata.xml e /spid-metadata.xml)
    # Doc: /myservice/module.php/saml/sp/metadata.php/spid
    RewriteEngine On

    # SPID button (GET) loses context
    # Il bottone SPID generato da spid-cie-php, in modalità GET, usa link del tipo "?idp=...".
    # Questo SOSTITUISCE tutta la query string e fa perdere client_id/redirect_uri/state; il PHP quindi
    # redirige a /metadata.xml e il browser "scarica il metadata" invece di continuare il login.
    #
    # Qui ricostruiamo la query string prendendola dal Referer (solo se la host coincide) e aggiungiamo idp.
    # Non modifica alcun file dentro il repository spid-cie-php (che è su volume ed è in gitignore).
    RewriteCond %{REQUEST_URI} ^/proxy-home\.php$ [NC]
    RewriteCond %{QUERY_STRING} (^|&)idp=[^&]+ [NC]
    RewriteCond %{QUERY_STRING} !(^|&)client_id= [NC]
    RewriteCond %{HTTP:Referer} ^https?://([^/]+)/proxy-home\.php\?([^#]+) [NC]
    RewriteCond %1 =%{HTTP_HOST}
    RewriteRule ^proxy-home\.php$ - [E=SPID_REFQS:%2]

    RewriteCond %{ENV:SPID_REFQS} .+
    RewriteCond %{REQUEST_URI} ^/proxy-home\.php$ [NC]
    RewriteCond %{QUERY_STRING} (^|&)idp=([^&]+) [NC]
    RewriteCond %{QUERY_STRING} !(^|&)client_id= [NC]
    RewriteRule ^proxy-home\.php$ /proxy-home.php?%{ENV:SPID_REFQS}&idp=%2 [R=302,L,NE]

    # Preferisci un metadata congelato (attestato) se presente su disco.
    # Questo evita modifiche involontarie al metadata quando cambiano env/config.
    RewriteCond %{DOCUMENT_ROOT}/metadata/spid-metadata-current.xml -f
    RewriteRule ^/(metadata\.xml|spid-metadata\.xml)$ /metadata/spid-metadata-current.xml [L]

    # Endpoint opzionale per un metadata "next" (generato in parallelo e non ancora messo in produzione).
    RewriteCond %{DOCUMENT_ROOT}/metadata/spid-metadata-next.xml -f
    RewriteRule ^/spid-metadata-next\.xml$ /metadata/spid-metadata-next.xml [L]

    # Fallback: metadata dinamico generato da SimpleSAML.
    RewriteRule ^/(metadata\.xml|spid-metadata\.xml)$ /myservice/module.php/saml/sp/metadata.php/spid [PT,L]

    # Metadata CIE
    # Doc: /myservice/module.php/saml/sp/metadata.php/cie
    # Preferisci un metadata congelato (attestato) se presente su disco.
    RewriteCond %{DOCUMENT_ROOT}/metadata/cie-metadata-current.xml -f
    RewriteRule ^/cie-metadata\.xml$ /metadata/cie-metadata-current.xml [L]

    # Endpoint opzionale per un metadata "next" (generato in parallelo e non ancora messo in produzione).
    RewriteCond %{DOCUMENT_ROOT}/metadata/cie-metadata-next.xml -f
    RewriteRule ^/cie-metadata-next\.xml$ /metadata/cie-metadata-next.xml [L]

    # Fallback: metadata dinamico generato da SimpleSAML.
    RewriteRule ^/cie-metadata\.xml$ /myservice/module.php/saml/sp/metadata.php/cie [PT,L]

    # Alcuni tool di validazione scaricano usando Content-Disposition (es. curl -OJ).
    # Il metadata di SimpleSAML può proporre filename poco parlanti; qui forziamo un nome stabile.
    <LocationMatch "^/(metadata\.xml|spid-metadata\.xml|spid-metadata-next\.xml)$">
        Header set Content-Type "application/xml; charset=utf-8"
        Header set Content-Disposition "inline; filename=spid-metadata.xml"
    </LocationMatch>

    <LocationMatch "^/(cie-metadata\.xml|cie-metadata-next\.xml)$">
        Header set Content-Type "application/xml; charset=utf-8"
        Header set Content-Disposition "inline; filename=cie-metadata.xml"
    </LocationMatch>

    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined

    SSLEngine on
    SSLCertificateFile /ssl/server.crt
    SSLCertificateKeyFile /ssl/server.key

    <Directory /var/www/spid-cie-php>
        Options FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    <Directory /var/www/spid-cie-php/www>
        Options FollowSymLinks
        AcceptPathInfo On
        AllowOverride All
        Require all granted
    </Directory>
</VirtualHost>

<VirtualHost *:80>
    ServerName localhost
    Redirect permanent / https://localhost/
</VirtualHost>
