<VirtualHost *:443>
    ServerName localhost

    # Espone la web-root di spid-cie-php (setup contiene proxy.php, login.php, ecc.)
    DocumentRoot /var/www/spid-cie-php/www

    # Espone SimpleSAMLphp (necessario per metadata e moduli)
    # Nota: baseurlpath di default è "myservice/" (vedi vendor/simplesamlphp/.../config.php)
    Alias /myservice /var/www/spid-cie-php/vendor/simplesamlphp/simplesamlphp/www

    <Directory /var/www/spid-cie-php/vendor/simplesamlphp/simplesamlphp/www>
        Options FollowSymLinks
        AllowOverride None
        Require all granted
    </Directory>

    # Metadata SPID (compat: /metadata.xml e /spid-metadata.xml)
    # Doc: /myservice/module.php/saml/sp/metadata.php/spid
    RewriteEngine On
    RewriteRule ^/(metadata\.xml|spid-metadata\.xml)$ /myservice/module.php/saml/sp/metadata.php/spid [PT,L]

    # Alcuni tool di validazione scaricano usando Content-Disposition (es. curl -OJ).
    # Il metadata di SimpleSAML può proporre filename poco parlanti; qui forziamo un nome stabile.
    <LocationMatch "^/(metadata\.xml|spid-metadata\.xml)$">
        Header set Content-Type "application/xml; charset=utf-8"
        Header set Content-Disposition "inline; filename=sp-metadata.xml"
    </LocationMatch>

    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined

    SSLEngine on
    SSLCertificateFile /ssl/server.crt
    SSLCertificateKeyFile /ssl/server.key

    <Directory /var/www/spid-cie-php>
        Options FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    <Directory /var/www/spid-cie-php/www>
        Options FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>
</VirtualHost>

<VirtualHost *:80>
    ServerName localhost
    Redirect permanent / https://localhost/
</VirtualHost>
