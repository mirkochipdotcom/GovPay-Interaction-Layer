services:
  # Servizio di utility che genera i metadata SP al primo avvio
  init-spid-cert:
    image: italia/spid-compliant-certificates:latest
    container_name: govpay-init-spid-cert
    user: "0:0"
    volumes:
      - ./iam-proxy/spid-certs:/certs
    entrypoint: [ "/bin/sh", "-c" ]
    command:
      - |
        if [ -f /certs/sp-signing.key ] && [ -f /certs/sp-signing.crt ]; then
          echo "[INFO] SPID cert gi√† presente, skip generazione";
          exit 0;
        fi
        spid-compliant-certificates generator \
          --key-size "$${SPID_CERT_KEY_SIZE:-3072}" \
          --common-name "$${SPID_CERT_COMMON_NAME:-$${APP_ENTITY_NAME:-GovPay}}" \
          --days "$${SPID_CERT_DAYS:-365}" \
          --entity-id "$${SPID_CERT_ENTITY_ID:-$${FRONTOFFICE_PUBLIC_BASE_URL:-https://127.0.0.1:8444}/saml/sp}" \
          --locality-name "$${SPID_CERT_LOCALITY_NAME:-Roma}" \
          --org-id "$${SPID_CERT_ORG_ID:-PA:IT-$${APP_ENTITY_IPA_CODE:-c_x000}}" \
          --org-name "$${SPID_CERT_ORG_NAME:-$${APP_ENTITY_NAME:-GovPay}}" \
          --sector "$${SPID_CERT_SECTOR:-public}" \
          --key-out /certs/sp-signing.key \
          --csr-out /certs/sp-signing.csr \
          --crt-out /certs/sp-signing.crt
    env_file:
      - .env
    profiles:
      - iam-proxy

  init-sp-metadata:
    image: govpay-interaction-frontoffice:latest
    container_name: govpay-init-sp-metadata
    volumes:
      - ./scripts/ensure-sp-metadata.sh:/scripts/ensure-sp-metadata.sh:ro
      - ./iam-proxy/metadata-sp:/metadata/sp
      - ./iam-proxy/metadata-sp:/var/www/html/metadata-sp
      - ./iam-proxy/spid-certs:/var/www/html/spid-certs
    environment:
      - FRONTOFFICE_PUBLIC_BASE_URL=${FRONTOFFICE_PUBLIC_BASE_URL}
      - APP_ENTITY_NAME=${APP_ENTITY_NAME}
      - APP_ENTITY_IPA_CODE=${APP_ENTITY_IPA_CODE}
      - IAM_PROXY_SAML2_IDP_METADATA_URL_INTERNAL=${IAM_PROXY_SAML2_IDP_METADATA_URL_INTERNAL:-https://satosa-nginx:443/Saml2IDP/metadata}
    depends_on:
      init-spid-cert:
        condition: service_completed_successfully
    entrypoint: [ "/bin/sh", "-c" ]
    command:
      - |
        sh /scripts/ensure-sp-metadata.sh || exit 0
    profiles:
      - iam-proxy

  govpay-interaction-backoffice:
    build:
      context: .
      target: runtime-backoffice
    image: govpay-interaction-backoffice:latest
    container_name: govpay-interaction-backoffice
    ports:
      - "${BACKOFFICE_HTTP_PORT:-8443}:80"
    volumes:
      # Monta solo la cartella debug per sviluppo live
      - ./debug:/var/www/html/public/debug
      - ./iam-proxy/metadata-sp:/var/www/html/metadata-sp:ro
      - ./iam-proxy/metadata-sp:/metadata/sp:ro
    environment:
      - SSL=${SSL}
      - APACHE_SERVER_NAME=${APACHE_SERVER_NAME}
      - COMPOSER_VENDOR_DIR=/var/www/html/vendor
      - APP_SUITE=backoffice
      - APP_DEBUG=${APP_DEBUG}
      - ENABLE_DEBUG_TOOL=${ENABLE_DEBUG_TOOL}
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - APP_ENTITY_NAME=${APP_ENTITY_NAME}
      - APP_ENTITY_SUFFIX=${APP_ENTITY_SUFFIX}
      - APP_ENTITY_GOVERNMENT=${APP_ENTITY_GOVERNMENT}
      - APP_ENTITY_URL=${APP_ENTITY_URL}
      - APP_SUPPORT_EMAIL=${APP_SUPPORT_EMAIL}
      - APP_SUPPORT_PHONE=${APP_SUPPORT_PHONE}
      - APP_SUPPORT_HOURS=${APP_SUPPORT_HOURS}
      - APP_SUPPORT_LOCATION=${APP_SUPPORT_LOCATION}
      - APP_LOGO_SRC=${APP_LOGO_SRC}
      - APP_LOGO_TYPE=${APP_LOGO_TYPE}
      - ID_DOMINIO=${ID_DOMINIO}
      - ID_A2A=${ID_A2A}
      - URL_ENTE=${URL_ENTE}
      - PAGOPA_CHECKOUT_EC_BASE_URL=${PAGOPA_CHECKOUT_EC_BASE_URL}
      - PAGOPA_CHECKOUT_SUBSCRIPTION_KEY=${PAGOPA_CHECKOUT_SUBSCRIPTION_KEY}
      - PAGOPA_CHECKOUT_COMPANY_NAME=${PAGOPA_CHECKOUT_COMPANY_NAME}
      - PAGOPA_CHECKOUT_RETURN_OK_URL=${PAGOPA_CHECKOUT_RETURN_OK_URL}
      - PAGOPA_CHECKOUT_RETURN_CANCEL_URL=${PAGOPA_CHECKOUT_RETURN_CANCEL_URL}
      - PAGOPA_CHECKOUT_RETURN_ERROR_URL=${PAGOPA_CHECKOUT_RETURN_ERROR_URL}
      - PAGOPA_PAYMENT_OPTIONS_URL=${PAGOPA_PAYMENT_OPTIONS_URL}
      - PAGOPA_PAYMENT_OPTIONS_KEY=${PAGOPA_PAYMENT_OPTIONS_KEY}
      - GOVPAY_PENDENZE_URL=${GOVPAY_PENDENZE_URL}
      - GOVPAY_PAGAMENTI_URL=${GOVPAY_PAGAMENTI_URL}
      - GOVPAY_RAGIONERIA_URL=${GOVPAY_RAGIONERIA_URL}
      - GOVPAY_BACKOFFICE_URL=${GOVPAY_BACKOFFICE_URL}
      - GOVPAY_PENDENZE_PATCH_URL=${GOVPAY_PENDENZE_PATCH_URL}
      - AUTHENTICATION_GOVPAY=${AUTHENTICATION_GOVPAY}
      - BIZ_EVENTS_API_KEY=${BIZ_EVENTS_API_KEY}
      - BIZ_EVENTS_HOST=${BIZ_EVENTS_HOST}
      - BACKOFFICE_MAILER_DSN=${BACKOFFICE_MAILER_DSN}
      - BACKOFFICE_MAILER_FROM_ADDRESS=${BACKOFFICE_MAILER_FROM_ADDRESS}
      - BACKOFFICE_MAILER_FROM_NAME=${BACKOFFICE_MAILER_FROM_NAME}
      - BACKOFFICE_PUBLIC_BASE_URL=${BACKOFFICE_PUBLIC_BASE_URL}
      - GOVPAY_USER=${GOVPAY_USER}
      - GOVPAY_PASSWORD=${GOVPAY_PASSWORD}
      - GOVPAY_TLS_CERT=${GOVPAY_TLS_CERT}
      - GOVPAY_TLS_KEY=${GOVPAY_TLS_KEY}
      - TASSONOMIE_PAGOPA=${TASSONOMIE_PAGOPA}
      - ADMIN_EMAIL=${ADMIN_EMAIL}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      # env_file_ rimosso per sicurezza (isolamento esplicito)
      # - .env.backoffice (rimosso: mantenere solo .env locale)
    depends_on:
      - db
    entrypoint: [ "/usr/local/bin/docker-setup.sh" ] # Esegue script di setup (composer/autoload + cert) poi CMD apache
    restart: unless-stopped
    networks:
      - govpay-network
  govpay-interaction-frontoffice:
    build:
      context: .
      target: runtime-frontoffice
    image: govpay-interaction-frontoffice:latest
    container_name: govpay-interaction-frontoffice
    ports:
      - "${FRONTOFFICE_HTTP_PORT:-8444}:80"
    volumes:
      # Monta solo la cartella debug per sviluppo live
      - ./debug:/var/www/html/public/debug
      - ./iam-proxy/metadata-sp:/var/www/html/metadata-sp:ro
      - ./iam-proxy/metadata-sp:/metadata/sp:ro
      - ./iam-proxy/spid-certs:/var/www/html/spid-certs:ro
    environment:
      - SSL=${SSL}
      - APACHE_SERVER_NAME=${APACHE_SERVER_NAME}
      - COMPOSER_VENDOR_DIR=/var/www/html/vendor
      - APP_DEBUG=${APP_DEBUG}
      - ENABLE_DEBUG_TOOL=${ENABLE_DEBUG_TOOL}
      - APP_SUITE=frontoffice
      - DB_NAME=${DB_NAME_CITTADINI}
      - DB_USER=${DB_USER_CITTADINI}
      - DB_PASSWORD=${DB_PASSWORD_CITTADINI}
      - FRONTOFFICE_AUTH_PROXY_TYPE=${FRONTOFFICE_AUTH_PROXY_TYPE}
      - FRONTOFFICE_PUBLIC_BASE_URL=${FRONTOFFICE_PUBLIC_BASE_URL}
      - APP_ENTITY_IPA_CODE=${APP_ENTITY_IPA_CODE}
      - APP_ENTITY_NAME=${APP_ENTITY_NAME}
      - APP_ENTITY_SUFFIX=${APP_ENTITY_SUFFIX}
      - APP_ENTITY_GOVERNMENT=${APP_ENTITY_GOVERNMENT}
      - APP_ENTITY_URL=${APP_ENTITY_URL}
      - APP_SUPPORT_EMAIL=${APP_SUPPORT_EMAIL}
      - APP_SUPPORT_PHONE=${APP_SUPPORT_PHONE}
      - APP_SUPPORT_HOURS=${APP_SUPPORT_HOURS}
      - APP_SUPPORT_LOCATION=${APP_SUPPORT_LOCATION}
      - APP_LOGO_SRC=${APP_LOGO_SRC}
      - APP_LOGO_TYPE=${APP_LOGO_TYPE}
      - ID_DOMINIO=${ID_DOMINIO}
      - ID_A2A=${ID_A2A}
      - URL_ENTE=${URL_ENTE}
      - PAGOPA_CHECKOUT_EC_BASE_URL=${PAGOPA_CHECKOUT_EC_BASE_URL}
      - PAGOPA_CHECKOUT_SUBSCRIPTION_KEY=${PAGOPA_CHECKOUT_SUBSCRIPTION_KEY}
      - PAGOPA_CHECKOUT_COMPANY_NAME=${PAGOPA_CHECKOUT_COMPANY_NAME}
      - PAGOPA_CHECKOUT_RETURN_OK_URL=${PAGOPA_CHECKOUT_RETURN_OK_URL}
      - PAGOPA_CHECKOUT_RETURN_CANCEL_URL=${PAGOPA_CHECKOUT_RETURN_CANCEL_URL}
      - PAGOPA_CHECKOUT_RETURN_ERROR_URL=${PAGOPA_CHECKOUT_RETURN_ERROR_URL}
      - PAGOPA_PAYMENT_OPTIONS_URL=${PAGOPA_PAYMENT_OPTIONS_URL}
      - PAGOPA_PAYMENT_OPTIONS_KEY=${PAGOPA_PAYMENT_OPTIONS_KEY}
      - GOVPAY_PENDENZE_URL=${GOVPAY_PENDENZE_URL}
      - GOVPAY_PAGAMENTI_URL=${GOVPAY_PAGAMENTI_URL}
      - GOVPAY_RAGIONERIA_URL=${GOVPAY_RAGIONERIA_URL}
      - GOVPAY_BACKOFFICE_URL=${GOVPAY_BACKOFFICE_URL}
      - GOVPAY_PENDENZE_PATCH_URL=${GOVPAY_PENDENZE_PATCH_URL}
      - AUTHENTICATION_GOVPAY=${AUTHENTICATION_GOVPAY}
      - GOVPAY_USER=${GOVPAY_USER}
      - GOVPAY_PASSWORD=${GOVPAY_PASSWORD}
      - GOVPAY_TLS_CERT=${GOVPAY_TLS_CERT}
      - GOVPAY_TLS_KEY=${GOVPAY_TLS_KEY}
      - TASSONOMIE_PAGOPA=${TASSONOMIE_PAGOPA}
      - COMPOSE_PROFILES=${COMPOSE_PROFILES}
      - IAM_PROXY_SAML2_IDP_METADATA_URL_INTERNAL=${IAM_PROXY_SAML2_IDP_METADATA_URL_INTERNAL:-https://satosa-nginx:443/Saml2IDP/metadata}
    depends_on:
      - db
    entrypoint: [ "/usr/local/bin/docker-setup.sh" ]
    restart: unless-stopped
    networks:
      - govpay-network

  sync-iam-proxy:
    image: alpine:latest
    container_name: sync-iam-proxy
    environment:
      - APP_ENTITY_NAME=${APP_ENTITY_NAME}
    env_file:
      - .env.iam-proxy
    volumes:
      - ./iam-proxy:/iam-proxy
      - ./scripts:/scripts:ro
    working_dir: /scripts
    command:
      - /bin/sh
      - -c
      - |
        apk add --no-cache bash git curl unzip openssl gettext
        bash /scripts/sync-iam-proxy-italia.sh
    profiles:
      - iam-proxy

  iam-proxy-italia:
    image: ghcr.io/italia/iam-proxy-italia:latest
    container_name: iam-proxy-italia
    command:
      - /bin/bash
      - -c
      - |
        if [ -f /satosa_proxy/entrypoint.sh ]; then
          exec /bin/bash /satosa_proxy/entrypoint.sh
        else
          echo "[ERROR] /satosa_proxy/entrypoint.sh not found. Volume mount issue?"
          exit 1
        fi
    volumes:
      - ./iam-proxy/iam-proxy-italia-project:/satosa_proxy
      - ./iam-proxy/metadata-sp:/satosa_proxy/metadata/sp:ro
    profiles:
      - iam-proxy
    depends_on:
      sync-iam-proxy:
        condition: service_completed_successfully
      init-sp-metadata:
        condition: service_completed_successfully
    environment:
      # Config minima per esecuzione container (valori dettagliati/secret in .env)
      - SATOSA_BY_DOCKER=1
      - APP_ENTITY_NAME=${APP_ENTITY_NAME}
      - APP_ENTITY_IPA_CODE=${APP_ENTITY_IPA_CODE}
    env_file:
      # - .env.frontoffice (rimosso: usare .env e .env.iam-proxy)
      - .env.iam-proxy
    restart: on-failure:3
    healthcheck:
      test: [ "CMD", "test", "-f", "/satosa_proxy/entrypoint.sh" ]
      interval: 5s
      timeout: 2s
      retries: 10
      start_period: 10s
    networks:
      - govpay-network

  satosa-nginx:
    image: nginx:alpine
    container_name: satosa-nginx
    profiles:
      - iam-proxy
    depends_on:
      iam-proxy-italia:
        condition: service_started
    ports:
      - "${IAM_PROXY_HTTP_PORT:-9445}:80"
    environment:
      - SSL=${SSL:-on}
      - NGINX_HOST=${IAM_PROXY_HOSTNAME:-satosa-nginx}
      - TZ=${TZ:-Europe/Rome}
    volumes:
      - ./iam-proxy/nginx/conf.d:/satosa_config_templates:ro
      - ./iam-proxy/nginx/html:/usr/share/nginx/html:ro
      - ./iam-proxy/nginx/entrypoint.d:/docker-entrypoint.d:ro
      # Mount SATOSA static files for serving by nginx
      - ./iam-proxy/iam-proxy-italia-project/static:/usr/share/nginx/html/static:ro
      # Cert per TLS (riuso di ssl/ locale)
      - ./ssl:/etc/nginx/certs
    restart: unless-stopped
    networks:
      - govpay-network
  db:
    image: mariadb:11
    container_name: mariadb
    restart: always
    environment:
      - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD}
      - MYSQL_DATABASE=${DB_NAME}
      - MYSQL_USER=${DB_USER}
      - MYSQL_PASSWORD=${DB_PASSWORD}
      - DB_USER_CITTADINI=${DB_USER_CITTADINI}
      - DB_PASSWORD_CITTADINI=${DB_PASSWORD_CITTADINI}
    volumes:
      - db_data:/var/lib/mysql
      - ./docker/db-init:/docker-entrypoint-initdb.d:ro
    networks:
      - govpay-network

  satosa-mongo:
    image: mongo:7
    container_name: satosa-mongo
    profiles:
      - iam-proxy
    env_file:
      - .env.iam-proxy
    volumes:
      - satosa_mongo_data:/data/db
    restart: unless-stopped
    networks:
      - govpay-network

networks:
  govpay-network:
    driver: bridge

volumes:
  db_data:
  satosa_mongo_data:
