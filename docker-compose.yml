services:
  govpay-interaction-backoffice:
    build:
      context: .
      target: runtime-backoffice
    image: govpay-interaction-backoffice:latest
    container_name: govpay-interaction-backoffice
    ports:
      - "${BACKOFFICE_HTTPS_PORT:-8443}:443"
    volumes:
      # Monta solo la cartella debug per sviluppo live
      - ./debug:/var/www/html/public/debug
    environment:
      - APACHE_SERVER_NAME=${APACHE_SERVER_NAME}
      # Dice a Composer di installare 'vendor' qui, indipendentemente da dove viene eseguito.
      - COMPOSER_VENDOR_DIR=/var/www/html/vendor 
      - APP_SUITE=backoffice
    env_file:
      - .env # Assicura il caricamento dei parametri, leggere il readme
    depends_on:
      - db
    entrypoint: ["/usr/local/bin/docker-setup.sh"] # Esegue script di setup (composer/autoload + cert) poi CMD apache
    restart: unless-stopped
  govpay-interaction-frontoffice:
    build:
      context: .
      target: runtime-frontoffice
    image: govpay-interaction-frontoffice:latest
    container_name: govpay-interaction-frontoffice
    ports:
      - "${FRONTOFFICE_HTTPS_PORT:-8444}:443"
    environment:
      - APACHE_SERVER_NAME=${APACHE_SERVER_NAME}
      - COMPOSER_VENDOR_DIR=/var/www/html/vendor
      - APP_DEBUG=0
      - ENABLE_DEBUG_TOOL=0
      - APP_SUITE=frontoffice
      - DB_NAME=${DB_NAME_CITTADINI}
      - DB_USER=${DB_USER_CITTADINI}
      - DB_PASSWORD=${DB_PASSWORD_CITTADINI}
    env_file:
      - .env
      - .env.spid
    depends_on:
      - db
    entrypoint: ["/usr/local/bin/docker-setup.sh"]
    restart: unless-stopped

  spid-proxy:
    build:
      context: ./spid-proxy
    image: govpay-spid-proxy:latest
    container_name: spid-proxy
    profiles:
      - spid-proxy
    ports:
      - "${SPID_PROXY_HTTPS_PORT:-8445}:443"
    env_file:
      - .env
      - .env.spid
    volumes:
      - ./spid-proxy/data:/var/www/spid-cie-php
      - ./ssl:/ssl
    restart: unless-stopped

  # Generatore metadata "next": gira su una working directory separata, quindi non tocca il proxy in produzione.
  # Uso tipico:
  #   docker compose --profile spid-proxy-metadata run --rm spid-proxy-metadata
  # Output:
  #   spid-proxy/metadata-work/www/metadata/spid-metadata-next.xml
  spid-proxy-metadata:
    build:
      context: ./spid-proxy
    image: govpay-spid-proxy:latest
    container_name: spid-proxy-metadata
    profiles:
      - spid-proxy-metadata
    env_file:
      - .env
      - .env.spid
    environment:
      - SPID_PROXY_FORCE_SETUP=1
      - SPID_PROXY_FORCE_CERT=1
      - SPID_PROXY_METADATA_SNAPSHOT_ON_START=1
      - SPID_PROXY_METADATA_PUBLISH_ON_START=1
      - SPID_PROXY_METADATA_PUBLISH_TARGET=next
      - SPID_PROXY_GENERATE_ONLY=1
    volumes:
      - ./spid-proxy/metadata-work:/var/www/spid-cie-php
    restart: "no"
  db:
    image: mariadb:11
    container_name: mariadb
    restart: always
    environment:
      - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD}
      - MYSQL_DATABASE=${DB_NAME}
      - MYSQL_USER=${DB_USER}
      - MYSQL_PASSWORD=${DB_PASSWORD}
      - DB_USER_CITTADINI=${DB_USER_CITTADINI}
      - DB_PASSWORD_CITTADINI=${DB_PASSWORD_CITTADINI}
    volumes:
      - db_data:/var/lib/mysql
      - ./docker/db-init:/docker-entrypoint-initdb.d:ro

volumes:
  db_data:
