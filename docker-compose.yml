services:
  php-apache:
    build: .
    image: govpay-interaction-layer:latest
    container_name: govpay-interaction-layer
    ports:
      - "8443:443"
    volumes:
      # 1. Mount del codice sorgente principale (la tua applicazione)
      - ./src:/var/www/html

      # 2. Mount ISOLATO dei client generati (PER COMPOSER)
      - .:/app

      # 3. Volumi anonimi per Composer (vendor) e asset pubblici
      - /var/www/html/vendor
      - /var/www/html/public
    environment:
      - APACHE_SERVER_NAME=${APACHE_SERVER_NAME}
      # Dice a Composer di installare 'vendor' qui, indipendentemente da dove viene eseguito.
      - COMPOSER_VENDOR_DIR=/var/www/html/vendor 
    env_file:
      - .env # Assicura il caricamento di ENTE_TITOLO e delle URL
    depends_on:
      - db
    entrypoint: ["/usr/local/bin/docker-setup.sh"] # Esegue prima lo script di setup
    restart: unless-stopped
    command: >
      /bin/sh -c "
        # 1. Entra nella directory di Composer (/app)
        cd /app &&
        
        # 2. Il resto del codice Composer può usare la chiamata 'composer'
        # COMPOSER_VENDOR_DIR gestirà dove va la cartella 'vendor'.
        
        if [ ! -d /var/www/html/vendor ]; then 
          echo 'Eseguo: composer install per la prima volta...' &&
          composer install --no-dev --optimize-autoloader; 
        
        # Le altre clausole (come dump-autoload) devono usare il percorso corretto
        elif [ /var/www/html/vendor/composer/installed.json -ot composer.json ]; then
          echo 'Eseguo: composer update (file modficiati)...' &&
          composer update --no-dev --optimize-autoloader;
        
        else 
          echo 'Eseguo: composer dump-autoload (solo autoloading)...' &&
          composer dump-autoload;
        fi && 
        
        # Avvia Apache
        /usr/local/bin/docker-php-entrypoint apache2-foreground
      "
  db:
    image: mariadb:11
    container_name: mariadb
    restart: always
    environment:
      - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD}
      - MYSQL_DATABASE=${DB_NAME}
      - MYSQL_USER=${DB_USER}
      - MYSQL_PASSWORD=${DB_PASSWORD}
    volumes:
      - db_data:/var/lib/mysql

volumes:
  db_data:
