{% extends 'base.html.twig' %}

{% block title %}Seleziona il servizio - {{ app_entity.name }}{% endblock %}

{% block head %}
  <style>
    body { background: #f6f8fb; }
    .page-hero {
      padding: 3rem 0 1rem;
      background: linear-gradient(120deg, #05193d 0%, #003a6d 70%, #005fcc 100%);
      color: #fff;
    }
    .page-hero .breadcrumb-item + .breadcrumb-item::before {
      color: rgba(255,255,255,0.6);
    }
    .page-hero .breadcrumb-item a { color: rgba(255,255,255,0.85); }
    .service-grid-title {
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #5c6f82;
      font-weight: 600;
    }
    .service-card {
      display: block;
      height: 100%;
      border-radius: 20px;
      padding: 1.5rem;
      border: 1px solid #dde5f0;
      background: #fff;
      text-decoration: none;
      color: inherit;
      box-shadow: 0 10px 40px rgba(5, 25, 61, 0.06);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .service-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 45px rgba(5, 25, 61, 0.1);
    }
    .service-card__icon {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: #eef3fb;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .service-card--external {
      border-style: dashed;
      background: #fdf8ee;
    }
    .service-card--external .service-card__icon {
      background: #fff3d6;
    }
  </style>
{% endblock %}

{% block content %}
  <section class="page-hero">
    <div class="container-xxl">
      <div class="row align-items-center g-3">
        <div class="col-lg-8">
          <nav aria-label="Percorso" class="mb-2">
            <ol class="breadcrumb mb-0">
              <li class="breadcrumb-item"><a href="/">{{ 'Home'|trans }}</a></li>
              <li class="breadcrumb-item active" aria-current="page">{{ 'Pagamento spontaneo'|trans }}</li>
            </ol>
          </nav>
          <p class="text-uppercase small mb-2 text-white-50">{{ 'Servizi PagoPA'|trans }}</p>
          <h1 class="display-6 fw-semibold mb-3">{{ 'Scegli il servizio da pagare'|trans }}</h1>
          <p class="mb-0 lead text-white-75">{{ 'Seleziona la tipologia di pagamento per continuare. Alcuni servizi ti porteranno su un portale esterno indicato dall\'Ente.'|trans }}</p>
        </div>
      </div>
    </div>
  </section>

  <section class="py-5">
    <div class="container-xxl">
      {% if selection_error %}
        <div class="alert alert-warning" role="alert">
          {{ selection_error }}
        </div>
      {% endif %}

      <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3 mb-4">
        <div>
          <p class="service-grid-title mb-1">{{ 'Servizi PagoPA'|trans }}</p>
          <h2 class="h3 fw-semibold mb-0">{{ 'Seleziona la tipologia di pagamento'|trans }}</h2>
        </div>
        <p class="text-muted mb-0">{{ 'L\'elenco mostra le tipologie attive per il dominio'|trans }} {{ app_entity.name }}.</p>
      </div>

      <div class="d-flex flex-column flex-md-row align-items-md-center gap-2 mb-4">
        <div class="flex-grow-1">
          <label for="serviceSearch" class="form-label visually-hidden">{{ 'Cerca tipologie'|trans }}</label>
          <input id="serviceSearch" type="search" class="form-control" placeholder="{{ 'Cerca per tipologia o descrizione'|trans }}" autocomplete="off" aria-label="{{ 'Cerca per tipologia o descrizione'|trans }}">
        </div>
        <button id="serviceSearchClear" type="button" class="btn btn-outline-secondary">{{ 'Pulisci'|trans }}</button>
      </div>

      {% set all_services = (internal_services|default([]))|merge(external_services|default([])) %}
      {% if all_services %}
        <div class="row g-4">
          {% for service in all_services %}
            {% set isExternal = (service.type|default('internal')) == 'external' %}
            <div class="col-md-6 col-xl-4">
              <a class="service-card {{ isExternal ? 'service-card--external' : '' }}" href="/pagamento-spontaneo?tipologia={{ service.id }}" data-service-id="{{ service.id|default('')|e('html_attr') }}" data-service-label="{{ service.label|default('')|e('html_attr') }}" data-service-desc="{{ service.descrizione_estesa|default('')|e('html_attr') }}">
                {% if isExternal %}
                  <span class="badge text-bg-light text-secondary text-uppercase small mb-3">{{ 'Portale esterno'|trans }}</span>
                {% else %}
                  <span class="badge text-bg-primary-subtle text-primary-emphasis text-uppercase small mb-3">{{ 'PagoPA'|trans }}</span>
                {% endif %}

                <h3 class="h5 fw-semibold mb-2">{{ service.label }}</h3>

                {% if isExternal %}
                  {% if service.descrizione_estesa is defined and service.descrizione_estesa is not empty %}
                    <p class="text-muted mb-4">{{ service.descrizione_estesa|nl2br }}</p>
                  {% else %}
                    <p class="text-muted mb-4">{{ 'Verrai reindirizzato al portale esterno dell\'Ente.'|trans }}</p>
                  {% endif %}
                  <div class="d-flex align-items-center gap-2 text-secondary fw-semibold">
                    {{ 'Vai al servizio'|trans }}
                    <span class="service-card__icon" aria-hidden="true">
                      <svg class="icon"><use href="/assets/bootstrap-italia/svg/sprites.svg#it-chevron-right"></use></svg>
                    </span>
                  </div>
                {% else %}
                  <p class="text-muted mb-4">
                    {% if service.descrizione_estesa is defined and service.descrizione_estesa is not empty %}
                      {{ service.descrizione_estesa|nl2br }}
                    {% else %}
                      {{ 'Richiedi l\'emissione dell\'avviso e completa il pagamento su questo portale.'|trans }}
                    {% endif %}
                  </p>
                  <span class="service-card__icon" aria-hidden="true">
                    <svg class="icon"><use href="/assets/bootstrap-italia/svg/sprites.svg#it-arrow-right"></use></svg>
                  </span>
                {% endif %}
              </a>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-muted">{{ 'Al momento non sono disponibili tipologie.'|trans }}</p>
      {% endif %}
    </div>
  </section>

  {% block scripts %}
    <script>
      (function(){
        function initServiceSearch(){
          var input = document.getElementById('serviceSearch');
          var clearBtn = document.getElementById('serviceSearchClear');
          if(!input || !clearBtn) return;

          function safeLower(s){
            return (s || '').toString().toLowerCase();
          }

          function foldAccents(s){
            try{
              return s.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            }catch(e){
              return s;
            }
          }

          function tokenize(s){
            var x = foldAccents(safeLower(s)).trim();
            x = x.replace(/[^a-z0-9]+/g, ' ').trim();
            if(!x) return [];
            return x.split(/\s+/).filter(Boolean);
          }

          function bestTokenMatchScore(qToken, idTokens, labelTokens, descTokens){
            var best = 0;

            for(var i=0;i<labelTokens.length;i++){
              var t = labelTokens[i];
              if(t === qToken){ best = Math.max(best, 60); continue; }
              if(t.indexOf(qToken) === 0){ best = Math.max(best, 50); }
            }

            for(var j=0;j<idTokens.length;j++){
              var it = idTokens[j];
              if(it === qToken){ best = Math.max(best, 40); continue; }
              if(it.indexOf(qToken) === 0){ best = Math.max(best, 30); }
            }

            for(var k=0;k<descTokens.length;k++){
              var dt = descTokens[k];
              if(dt === qToken){ best = Math.max(best, 10); continue; }
              if(dt.indexOf(qToken) === 0){ best = Math.max(best, 8); }
            }

            return best;
          }

          var cards = Array.prototype.slice.call(document.querySelectorAll('[data-service-label]'));
          if(!cards.length) return;

          var entries = [];
          var rowOrder = new Map();
          cards.forEach(function(card){
            var col = card.closest('.col-md-6') || card.parentElement;
            if(!col) return;
            var row = col.parentElement;
            if(!row) return;

            if(!rowOrder.has(row)){
              rowOrder.set(row, []);
            }
            var originalIndex = rowOrder.get(row).length;
            rowOrder.get(row).push(col);

            var idVal = card.getAttribute('data-service-id') || '';
            var labelVal = card.getAttribute('data-service-label') || '';
            var descVal = card.getAttribute('data-service-desc') || '';

            entries.push({
              card: card,
              col: col,
              row: row,
              originalIndex: originalIndex,
              idTokens: tokenize(idVal),
              labelTokens: tokenize(labelVal),
              descTokens: tokenize(descVal),
              labelSort: foldAccents(safeLower(labelVal)).trim()
            });
          });

          function applyFilter(){
            var q = input.value || '';
            var qTokens = tokenize(q);

            // Nessuna query: mostra tutto e ripristina ordine originale
            if(qTokens.length === 0){
              entries.forEach(function(e){ e.col.classList.remove('d-none'); });
              rowOrder.forEach(function(cols, row){
                cols.sort(function(a,b){
                  return (a._origIndex || 0) - (b._origIndex || 0);
                });
                cols.forEach(function(col){ row.appendChild(col); });
              });
              return;
            }

            // Prepara mappa originalIndex anche su DOM (una tantum)
            entries.forEach(function(e){
              if(e.col._origIndex === undefined){
                e.col._origIndex = e.originalIndex;
              }
            });

            // Calcolo score per entry
            entries.forEach(function(e){
              var matchedTokens = 0;
              var baseScore = 0;

              for(var i=0;i<qTokens.length;i++){
                var qt = qTokens[i];
                if(qt.length < 2) continue;
                var s = bestTokenMatchScore(qt, e.idTokens, e.labelTokens, e.descTokens);
                if(s > 0){
                  matchedTokens++;
                  baseScore += s;
                }
              }

              // Ordinamento: prima chi matcha più token, poi score
              e._matchedTokens = matchedTokens;
              e._score = matchedTokens > 0 ? (matchedTokens * 1000 + baseScore) : 0;
            });

            // Visibilità + riordino per ciascuna row
            var byRow = new Map();
            entries.forEach(function(e){
              if(!byRow.has(e.row)) byRow.set(e.row, []);
              byRow.get(e.row).push(e);
            });

            byRow.forEach(function(list, row){
              var visible = [];
              var hidden = [];

              list.forEach(function(e){
                if(e._score > 0){
                  e.col.classList.remove('d-none');
                  visible.push(e);
                }else{
                  e.col.classList.add('d-none');
                  hidden.push(e);
                }
              });

              visible.sort(function(a,b){
                if(b._matchedTokens !== a._matchedTokens) return b._matchedTokens - a._matchedTokens;
                if(b._score !== a._score) return b._score - a._score;
                if(a.labelSort < b.labelSort) return -1;
                if(a.labelSort > b.labelSort) return 1;
                return a.originalIndex - b.originalIndex;
              });
              hidden.sort(function(a,b){ return a.originalIndex - b.originalIndex; });

              visible.concat(hidden).forEach(function(e){ row.appendChild(e.col); });
            });
          }

          input.addEventListener('input', applyFilter);
          clearBtn.addEventListener('click', function(){
            input.value = '';
            input.focus();
            applyFilter();
          });

          applyFilter();
        }

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initServiceSearch);
        } else {
          initServiceSearch();
        }
      })();
    </script>
  {% endblock %}
{% endblock %}
