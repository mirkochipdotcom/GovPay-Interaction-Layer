<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}{{ app_entity.name }} – {{ 'Sportello pagamenti'|trans }}{% endblock %}</title>
    <link rel="icon" href="{{ app_favicon.href }}" type="{{ app_favicon.type }}">
    <link rel="stylesheet" href="/assets/bootstrap-italia/css/bootstrap-italia.min.css">
    <link rel="stylesheet" href="/assets/fontawesome/css/all.min.css">
    <link rel="stylesheet" href="/assets/css/app.css">
    {% block head %}{% endblock %}
  </head>
  <body class="it-body">
    {% include 'partials/header.html.twig' %}
    <main id="main" class="pb-5">
      {% block content %}{% endblock %}
    </main>
    {% include 'partials/footer.html.twig' %}
    <script src="/assets/bootstrap-italia/js/bootstrap-italia.bundle.min.js"></script>
    <script src="/assets/js/app.js"></script>
    <script>
    /* ── Global Cart AJAX ── */
    (function () {
      function updateCartBadges(count) {
        document.querySelectorAll('.cart-badge').forEach(function (el) {
          el.textContent = count;
          el.style.display = count > 0 ? '' : 'none';
        });
      }

      var btn = document.getElementById('btn-cart-add');
      if (btn) {
        if (btn.dataset.added === '1') {
          var lbl = document.getElementById('btn-cart-label');
          if (lbl) lbl.textContent = '{{ "Nel carrello"|trans|escape("js") }} ✓';
          btn.disabled = true;
        }

        btn.addEventListener('click', function () {
          var id = btn.dataset.id;
          if (!id || btn.disabled) return;
          btn.disabled = true;
          var lbl = document.getElementById('btn-cart-label');

          var body = new URLSearchParams({ idPendenza: id });
          fetch('/carrello/aggiungi', {
            method: 'POST',
            body: body,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
          })
          .then(function (r) { return r.json(); })
          .then(function (data) {
            if (data.error) {
              btn.disabled = false;
              alert(data.error);
              return;
            }
            if (lbl) lbl.textContent = '{{ "Nel carrello"|trans|escape("js") }} ✓';
            updateCartBadges(data.count || 0);
          })
          .catch(function () {
            btn.disabled = false;
            if (lbl) lbl.textContent = '{{ "Errore, riprova"|trans|escape("js") }}';
          });
        });
      }
    })();
    </script>
    {% block scripts %}{% endblock %}
  </body>
</html>

